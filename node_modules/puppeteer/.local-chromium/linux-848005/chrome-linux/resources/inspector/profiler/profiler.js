import{ArrayUtilities as e,NumberUtilities as t,DateUtilities as i,StringUtilities as s}from"../platform/platform.js";import{DataGrid as r,ShowMoreDataGridNode as o,SortableDataGrid as n}from"../data_grid/data_grid.js";import{i18n as a}from"../i18n/i18n.js";import{UIUtils as l,Icon as d,Tooltip as h,Widget as c,TreeOutline as p,InplaceEditor as u,ARIAUtils as _,ContextMenu as m,View as f,SearchableView as g,Toolbar as v,Context as S,ListModel as w,ListControl as b,InspectorView as C,Fragment as P,SplitWidget as T,TabbedPane as y,PopoverHelper as x,SettingsUI as E,Panel as I,ActionRegistry as N,ViewManager as R}from"../ui/ui.js";import{Color as D,ObjectWrapper as F,Settings as L,Revealer as H,UIString as k,ParsedURL as M,Console as O,Worker as z,Throttler as B}from"../common/common.js";import{Platform as j,userMetrics as V,UserMetrics as G}from"../host/host.js";import{FlameChart as A,OverviewGrid as W,LineLevelProfile as U,PieChart as J}from"../perf_ui/perf_ui.js";import{Linkifier as q}from"../components/components.js";import{SDKModel as $,CPUProfilerModel as Q,CPUProfileDataModel as K,IsolateManager as X,RuntimeModel as Y,HeapProfilerModel as Z,ProfileTreeModel as ee,ConsoleModel as te,RemoteObject as ie,ResourceTreeModel as se}from"../sdk/sdk.js";import{DebuggerWorkspaceBinding as re,FileUtils as oe,TempFile as ne}from"../bindings/bindings.js";import{Runtime as ae}from"../root/root.js";import{HeapSnapshotModel as le}from"../heap_snapshot_model/heap_snapshot_model.js";import{ObjectPopoverHelper as de}from"../object_ui/object_ui.js";import{Workspace as he}from"../workspace/workspace.js";const ce={notOptimizedS:"Not optimized: {PH1}",genericTextTwoPlaceholders:"{PH1}, {PH2}"},pe=a.registerUIStrings("profiler/ProfileDataGrid.js",ce),ue=a.getLocalizedString.bind(void 0,pe);class _e extends r.DataGridNode{constructor(e,t,i){super(null,i),this._searchMatchedSelfColumn=!1,this._searchMatchedTotalColumn=!1,this._searchMatchedFunctionColumn=!1,this.profileNode=e,this.tree=t,this.childrenByCallUID=new Map,this.lastComparator=null,this.callUID=e.callUID,this.self=e.self,this.total=e.total,this.functionName=l.beautifyFunctionName(e.functionName),this._deoptReason=e.deoptReason||"",this.url=e.url,this.linkElement=null,this._populated=!1}static sort(e,t,i){for(let s=0;s<e.length;++s){const r=e[s],o=r.length;for(let s=0;s<o;++s){const o=r[s];if(!(i||o.expanded&&o.lastComparator!==t)){o.children.length&&(o.shouldRefreshChildren=!0);continue}o.lastComparator=t;const n=o.children,a=n.length;if(a){n.sort(t);for(let e=0;e<a;++e)n[e].recalculateSiblings(e);e.push(n)}}}}static merge(e,t,i){e.self+=t.self,i||(e.total+=t.total);let s=e.children.slice();e.removeChildren();let r=s.length;for(let o=0;o<r;++o)i&&s[o]===t||e.appendChild(s[o]);s=t.children.slice(),r=s.length;for(let t=0;t<r;++t){const i=s[t],r=e.childrenByCallUID.get(i.callUID);r?r.merge(i,!1):e.appendChild(i)}}static populate(e){if(e._populated)return;e._populated=!0,e.populateChildren();const t=e.tree.lastComparator;t&&e.sort(t,!0)}createCell(e){switch(e){case"self":{const t=this._createValueCell(this.self,this.selfPercent,e);return t.classList.toggle("highlight",this._searchMatchedSelfColumn),t}case"total":{const t=this._createValueCell(this.total,this.totalPercent,e);return t.classList.toggle("highlight",this._searchMatchedTotalColumn),t}case"function":{const t=this.createTD(e);if(t.classList.toggle("highlight",this._searchMatchedFunctionColumn),this._deoptReason){t.classList.add("not-optimized");const e=d.Icon.create("smallicon-warning","profile-warn-marker");h.Tooltip.install(e,ue(ce.notOptimizedS,{PH1:this._deoptReason})),t.appendChild(e)}if(l.createTextChild(t,this.functionName),"0"===this.profileNode.scriptId)return t;const i=this.tree._formatter.linkifyNode(this);return i?(i.style.maxWidth="75%",t.appendChild(i),this.linkElement=i,t):t}}return super.createCell(e)}_createValueCell(e,t,i){const s=document.createElement("td");s.classList.add("numeric-column");const r=s.createChild("div","profile-multiple-values"),o=r.createChild("span"),n=this.tree._formatter.formatValue(e,this);o.textContent=n;const a=r.createChild("span","percent-column"),l=this.tree._formatter.formatPercent(t,this);a.textContent=l;const d=this.tree._formatter.formatValueAccessibleText(e,this);return this.setCellAccessibleName(ue(ce.genericTextTwoPlaceholders,{PH1:d,PH2:l}),s,i),s}sort(e,t){const i=e;return _e.sort([[this]],i,t)}insertChild(e,t){const i=e;super.insertChild(i,t),this.childrenByCallUID.set(i.callUID,i)}removeChild(e){super.removeChild(e),this.childrenByCallUID.delete(e.callUID)}removeChildren(){super.removeChildren(),this.childrenByCallUID.clear()}findChild(e){return e&&this.childrenByCallUID.get(e.callUID)||null}get selfPercent(){return this.self/this.tree.total*100}get totalPercent(){return this.total/this.tree.total*100}populate(){_e.populate(this)}populateChildren(){}save(){this._savedChildren||(this._savedSelf=this.self,this._savedTotal=this.total,this._savedChildren=this.children.slice())}restore(){if(!this._savedChildren)return;this._savedSelf&&this._savedTotal&&(this.self=this._savedSelf,this.total=this._savedTotal),this.removeChildren();const e=this._savedChildren,t=e.length;for(let i=0;i<t;++i)e[i].restore(),this.appendChild(e[i])}merge(e,t){_e.merge(this,e,t)}}class me{constructor(e,t,i){this.tree=this,this.self=0,this.children=[],this._formatter=e,this._searchableView=t,this.total=i,this.lastComparator=null,this.childrenByCallUID=new Map,this.deepSearch=!0,this._populated=!1,this._searchResults}static propertyComparator(e,t){let i=me.propertyComparators[t?1:0][e];return i||(i=t?function(t,i){return t[e]<i[e]?-1:t[e]>i[e]?1:0}:function(t,i){return t[e]>i[e]?-1:t[e]<i[e]?1:0},me.propertyComparators[t?1:0][e]=i),i}get expanded(){return!0}appendChild(e){this.insertChild(e,this.children.length)}focus(e){}exclude(e){}insertChild(e,t){const i=e;this.children.splice(t,0,i),this.childrenByCallUID.set(i.callUID,e)}removeChildren(){this.children=[],this.childrenByCallUID.clear()}populateChildren(){}findChild(e){return e?this.childrenByCallUID.get(e.callUID):null}sort(e,t){return _e.sort([[this]],e,t)}save(){this._savedChildren||(this._savedTotal=this.total,this._savedChildren=this.children.slice())}restore(){if(!this._savedChildren)return;this.children=this._savedChildren,this._savedTotal&&(this.total=this._savedTotal);const e=this.children,t=e.length;for(let i=0;i<t;++i)e[i].restore();this._savedChildren=null}_matchFunction(e){const t=e.query.trim();if(!t.length)return null;const i=t.startsWith(">"),s=t.startsWith("<");let r=t.startsWith("=")||(i||s)&&1===t.indexOf("=");const o=t.endsWith("%"),n=t.length>2&&t.endsWith("ms"),a=!n&&t.endsWith("s");let l=parseFloat(t);(i||s||r)&&(l=r&&(i||s)?parseFloat(t.substring(2)):parseFloat(t.substring(1)));const d=a?1e3*l:l;isNaN(l)||i||s||(r=!0);const h=createPlainTextSearchRegex(t,"i");return function(e){return e._searchMatchedSelfColumn=!1,e._searchMatchedTotalColumn=!1,e._searchMatchedFunctionColumn=!1,o?(s?(e.selfPercent<l&&(e._searchMatchedSelfColumn=!0),e.totalPercent<l&&(e._searchMatchedTotalColumn=!0)):i&&(e.selfPercent>l&&(e._searchMatchedSelfColumn=!0),e.totalPercent>l&&(e._searchMatchedTotalColumn=!0)),r&&(e.selfPercent===l&&(e._searchMatchedSelfColumn=!0),e.totalPercent===l&&(e._searchMatchedTotalColumn=!0))):(n||a)&&(s?(e.self<d&&(e._searchMatchedSelfColumn=!0),e.total<d&&(e._searchMatchedTotalColumn=!0)):i&&(e.self>d&&(e._searchMatchedSelfColumn=!0),e.total>d&&(e._searchMatchedTotalColumn=!0)),r&&(e.self===d&&(e._searchMatchedSelfColumn=!0),e.total===d&&(e._searchMatchedTotalColumn=!0))),(e.functionName.match(h)||e.url&&e.url.match(h))&&(e._searchMatchedFunctionColumn=!0),!!(e._searchMatchedSelfColumn||e._searchMatchedTotalColumn||e._searchMatchedFunctionColumn)&&(e.refresh(),!0)}}performSearch(e,t,i){this.searchCanceled();const s=this._matchFunction(e);if(!s)return;this._searchResults=[];const r=this.deepSearch;let o;for(o=this.children[0];o;o=o.traverseNextNode(!r,null,!r)){const e=o;if(!e)break;s(e)&&this._searchResults.push({profileNode:e})}this._searchResultIndex=i?0:this._searchResults.length-1,this._searchableView.updateSearchMatchesCount(this._searchResults.length),this._searchableView.updateCurrentMatchIndex(this._searchResultIndex)}searchCanceled(){if(this._searchResults)for(let e=0;e<this._searchResults.length;++e){const t=this._searchResults[e].profileNode;t._searchMatchedSelfColumn=!1,t._searchMatchedTotalColumn=!1,t._searchMatchedFunctionColumn=!1,t.refresh()}this._searchResults=[],this._searchResultIndex=-1}jumpToNextSearchResult(){this._searchResults&&this._searchResults.length&&(this._searchResultIndex=(this._searchResultIndex+1)%this._searchResults.length,this._jumpToSearchResult(this._searchResultIndex))}jumpToPreviousSearchResult(){this._searchResults&&this._searchResults.length&&(this._searchResultIndex=(this._searchResultIndex-1+this._searchResults.length)%this._searchResults.length,this._jumpToSearchResult(this._searchResultIndex))}supportsCaseSensitiveSearch(){return!0}supportsRegexSearch(){return!1}_jumpToSearchResult(e){const t=this._searchResults[e];if(!t)return;t.profileNode.revealAndSelect(),this._searchableView.updateCurrentMatchIndex(e)}}me.propertyComparators=[{},{}];var fe=Object.freeze({__proto__:null,UIStrings:ce,ProfileDataGridNode:_e,ProfileDataGridTree:me,Formatter:class{formatValue(e,t){throw new Error("Not implemented")}formatValueAccessibleText(e,t){throw new Error("Not implemented")}formatPercent(e,t){throw new Error("Not implemented")}linkifyNode(e){throw new Error("Not implemented")}}});class ge extends _e{constructor(e,t){super(e,t,null!==e.parent&&Boolean(e.parent.parent)),this._remainingNodeInfos=[]}static _sharedPopulate(e){if(void 0===e._remainingNodeInfos)return;const t=e._remainingNodeInfos,i=t.length;for(let s=0;s<i;++s){const i=t[s],r=i.ancestor,o=i.focusNode;let n=e.findChild(r);if(n){const e=i.totalAccountedFor;n.self+=o.self,e||(n.total+=o.total)}else n=new ge(r,e.tree),r!==o&&(n.self=o.self,n.total=o.total),e.appendChild(n);const a=r.parent;a&&a.parent&&(i.ancestor=a,n._remainingNodeInfos||(n._remainingNodeInfos=[]),n._remainingNodeInfos.push(i))}delete e._remainingNodeInfos}_takePropertiesFromProfileDataGridNode(e){this.save(),this.self=e.self,this.total=e.total}_keepOnlyChild(e){this.save(),this.removeChildren(),this.appendChild(e)}_exclude(e){this._remainingNodeInfos&&this.populate(),this.save();const t=this.children;let i=this.children.length;for(;i--;)t[i]._exclude(e);const s=this.childrenByCallUID.get(e);s&&this.merge(s,!0)}restore(){super.restore(),this.children.length||this.setHasChildren(this._willHaveChildren(this.profileNode))}merge(e,t){this.self-=e.self,super.merge(e,t)}populateChildren(){ge._sharedPopulate(this)}_willHaveChildren(e){return Boolean(e.parent&&e.parent.parent)}}class ve extends me{constructor(e,t,i,s){super(e,t,s),this.deepSearch=!1;let r=0;const o=[[],[i]],n=new Map;this._remainingNodeInfos=[];for(let e=0;e<o.length;++e){const t=o[e],i=o[++e],s=i.length,a=new WeakMap;for(let e=0;e<s;++e){const s=i[e];if(a.get(s)||a.set(s,++r),s.parent){let e=n.get(s.callUID),i=!1;if(e){const s=t.length;for(let r=0;r<s;++r){const s=a.get(t[r]);if(s&&e.has(s)){i=!0;break}}}else e=new Set,n.set(s.callUID,e);const r=a.get(s);r&&e.add(r),this._remainingNodeInfos.push({ancestor:s,focusNode:s,totalAccountedFor:i})}const l=s.children;l.length&&(o.push(t.concat([s])),o.push(l))}}return _e.populate(this),this}focus(e){if(!e)return;this.save();let t=e,i=e;for(;t.parent&&t instanceof ge;)t._takePropertiesFromProfileDataGridNode(e),i=t,t=t.parent,t instanceof ge&&t._keepOnlyChild(i);this.children=[i],this.total=e.total}exclude(t){if(!t)return;this.save();const i=t.callUID,s=this.childrenByCallUID.get(i);s&&e.removeElement(this.children,s);const r=this.children,o=r.length;for(let e=0;e<o;++e)r[e]._exclude(i);this.lastComparator&&this.sort(this.lastComparator,!0)}populateChildren(){ge._sharedPopulate(this)}}var Se=Object.freeze({__proto__:null,NodeInfo:undefined,BottomUpProfileDataGridNode:ge,BottomUpProfileDataGridTree:ve});var we=Object.freeze({__proto__:null,ChildrenProvider:class{dispose(){}nodePosition(e){throw new Error("Not implemented yet")}isEmpty(){throw new Error("Not implemented yet")}serializeItemsRange(e,t){throw new Error("Not implemented yet")}sortAndRewind(e){throw new Error("Not implemented yet")}}});let be=null;class Ce{constructor(){this._colorGenerator=Ce.colorGenerator(),this._maxStackDepth=0,this.timelineData_=null,this.entryNodes=[]}static colorGenerator(){return be||(be=new D.Generator({min:30,max:330,count:void 0},{min:50,max:80,count:5},{min:80,max:90,count:3}),be.setColorForID("(idle)","hsl(0, 0%, 94%)"),be.setColorForID("(program)","hsl(0, 0%, 80%)"),be.setColorForID("(garbage collector)","hsl(0, 0%, 80%)")),be}minimumBoundary(){throw"Not implemented."}totalTime(){throw"Not implemented."}formatValue(e,t){return Number.preciseMillisToString(e,t)}maxStackDepth(){return this._maxStackDepth}timelineData(){return this.timelineData_||this._calculateTimelineData()}_calculateTimelineData(){throw"Not implemented."}prepareHighlightedEntryInfo(e){throw"Not implemented."}canJumpToEntry(e){return"0"!==this.entryNodes[e].scriptId}entryTitle(e){const t=this.entryNodes[e];return l.beautifyFunctionName(t.functionName)}entryFont(e){return this._font||(this._font="11px "+j.fontFamily(),this._boldFont="bold "+this._font),this.entryHasDeoptReason(e)?this._boldFont:this._font}entryHasDeoptReason(e){throw"Not implemented."}entryColor(e){const t=this.entryNodes[e];return this._colorGenerator.colorForID(t.url||("0"!==t.scriptId?t.scriptId:t.functionName))}decorateEntry(e,t,i,s,r,o,n){return!1}forceDecoration(e){return!1}textColor(e){return"#333"}navStartTimes(){return new Map}entryNodesLength(){return this.entryNodes.length}}class Pe extends c.VBox{constructor(e,t){super(),this.element.id="cpu-flame-chart",this._searchableView=e,this._overviewPane=new ye(t),this._overviewPane.show(this.element),this._mainPane=new A.FlameChart(t,this._overviewPane),this._mainPane.setBarHeight(15),this._mainPane.setTextBaseline(4),this._mainPane.setTextPadding(2),this._mainPane.show(this.element),this._mainPane.addEventListener(A.Events.EntrySelected,this._onEntrySelected,this),this._mainPane.addEventListener(A.Events.EntryInvoked,this._onEntryInvoked,this),this._entrySelected=!1,this._mainPane.addEventListener(A.Events.CanvasFocused,this._onEntrySelected,this),this._overviewPane.addEventListener(W.Events.WindowChanged,this._onWindowChanged,this),this._dataProvider=t,this._searchResults=[]}focus(){this._mainPane.focus()}_onWindowChanged(e){const t=e.data.windowTimeLeft,i=e.data.windowTimeRight;this._mainPane.setWindowTimes(t,i,!0)}selectRange(e,t){this._overviewPane._selectRange(e,t)}_onEntrySelected(e){if(e.data){const t=Number(e.data);this._mainPane.setSelectedEntry(t),this._entrySelected=-1!==t}else this._entrySelected||(this._mainPane.setSelectedEntry(0),this._entrySelected=!0)}_onEntryInvoked(e){this._onEntrySelected(e),this.dispatchEventToListeners(A.Events.EntryInvoked,e.data)}update(){this._overviewPane.update(),this._mainPane.update()}performSearch(e,t,i){const s=createPlainTextSearchRegex(e.query,e.caseSensitive?"":"i"),r=-1!==this._searchResultIndex?this._searchResults[this._searchResultIndex]:-1;this._searchResults=[];const o=this._dataProvider.entryNodesLength();for(let e=0;e<o;++e)this._dataProvider.entryTitle(e).match(s)&&this._searchResults.push(e);this._searchResults.length?(this._searchResultIndex=this._searchResults.indexOf(r),-1===this._searchResultIndex&&(this._searchResultIndex=i?this._searchResults.length-1:0),this._mainPane.setSelectedEntry(this._searchResults[this._searchResultIndex])):this.searchCanceled(),this._searchableView.updateSearchMatchesCount(this._searchResults.length),this._searchableView.updateCurrentMatchIndex(this._searchResultIndex)}searchCanceled(){this._mainPane.setSelectedEntry(-1),this._searchResults=[],this._searchResultIndex=-1}jumpToNextSearchResult(){this._searchResultIndex=(this._searchResultIndex+1)%this._searchResults.length,this._mainPane.setSelectedEntry(this._searchResults[this._searchResultIndex]),this._searchableView.updateCurrentMatchIndex(this._searchResultIndex)}jumpToPreviousSearchResult(){this._searchResultIndex=(this._searchResultIndex-1+this._searchResults.length)%this._searchResults.length,this._mainPane.setSelectedEntry(this._searchResults[this._searchResultIndex]),this._searchableView.updateCurrentMatchIndex(this._searchResultIndex)}supportsCaseSensitiveSearch(){return!0}supportsRegexSearch(){return!1}}class Te{constructor(e){this._formatter=e,this._minimumBoundaries,this._maximumBoundaries,this._xScaleFactor}_updateBoundaries(e){this._minimumBoundaries=e._dataProvider.minimumBoundary();const t=e._dataProvider.totalTime();this._maximumBoundaries=this._minimumBoundaries+t,this._xScaleFactor=e._overviewContainer.clientWidth/t}computePosition(e){return(e-this._minimumBoundaries)*this._xScaleFactor}formatValue(e,t){return this._formatter(e-this._minimumBoundaries,t)}maximumBoundary(){return this._maximumBoundaries}minimumBoundary(){return this._minimumBoundaries}zeroTime(){return this._minimumBoundaries}boundarySpan(){return this._maximumBoundaries-this._minimumBoundaries}}class ye extends c.VBox{constructor(e){super(),this.element.classList.add("cpu-profile-flame-chart-overview-pane"),this._overviewContainer=this.element.createChild("div","cpu-profile-flame-chart-overview-container"),this._overviewCalculator=new Te(e.formatValue),this._overviewGrid=new W.OverviewGrid("cpu-profile-flame-chart",this._overviewCalculator),this._overviewGrid.element.classList.add("fill"),this._overviewCanvas=this._overviewContainer.createChild("canvas","cpu-profile-flame-chart-overview-canvas"),this._overviewContainer.appendChild(this._overviewGrid.element),this._dataProvider=e,this._overviewGrid.addEventListener(W.Events.WindowChanged,this._onWindowChanged,this)}windowChanged(e,t){this._selectRange(e,t)}updateRangeSelection(e,t){}updateSelectedGroup(e,t){}_selectRange(e,t){const i=this._dataProvider.minimumBoundary(),s=this._dataProvider.totalTime();this._overviewGrid.setWindow((e-i)/s,(t-i)/s)}_onWindowChanged(e){const t={windowTimeLeft:e.data.rawStartValue,windowTimeRight:e.data.rawEndValue};this._windowTimeLeft=t.windowTimeLeft,this._windowTimeRight=t.windowTimeRight,this.dispatchEventToListeners(W.Events.WindowChanged,t)}_timelineData(){return this._dataProvider.timelineData()}onResize(){this._scheduleUpdate()}_scheduleUpdate(){this._updateTimerId||(this._updateTimerId=this.element.window().requestAnimationFrame(this.update.bind(this)))}update(){this._updateTimerId=0;this._timelineData()&&(this._resetCanvas(this._overviewContainer.clientWidth,this._overviewContainer.clientHeight-A.HeaderHeight),this._overviewCalculator._updateBoundaries(this),this._overviewGrid.updateDividers(this._overviewCalculator),this._drawOverviewCanvas())}_drawOverviewCanvas(){const e=this._overviewCanvas.width,t=this._overviewCanvas.height,i=this._calculateDrawData(e),s=this._overviewCanvas.getContext("2d");if(!s)throw new Error("Failed to get canvas context");const r=window.devicePixelRatio,o=t/(1.1*this._dataProvider.maxStackDepth());s.lineWidth=1,s.translate(.5,.5),s.strokeStyle="rgba(20,0,0,0.4)",s.fillStyle="rgba(214,225,254,0.8)",s.moveTo(-1,t+1),s.lineTo(-1,Math.round(t-i[0]*o-r));let n=0;for(let a=0;a<e;++a)n=Math.round(t-i[a]*o-r),s.lineTo(a,n);s.lineTo(e+1,n),s.lineTo(e+1,t+1),s.fill(),s.stroke(),s.closePath()}_calculateDrawData(e){const t=this._dataProvider,i=this._timelineData(),s=i.entryStartTimes,r=i.entryTotalTimes,o=i.entryLevels,n=s.length,a=this._dataProvider.minimumBoundary(),l=new Uint8Array(e),d=e/t.totalTime();for(let e=0;e<n;++e){const t=Math.floor((s[e]-a)*d),i=Math.floor((s[e]-a+r[e])*d);for(let s=t;s<=i;++s)l[s]=Math.max(l[s],o[e]+1)}return l}_resetCanvas(e,t){const i=window.devicePixelRatio;this._overviewCanvas.width=e*i,this._overviewCanvas.height=t*i,this._overviewCanvas.style.width=e+"px",this._overviewCanvas.style.height=t+"px"}}var xe=Object.freeze({__proto__:null,ProfileFlameChartDataProvider:Ce,CPUProfileFlameChart:Pe,OverviewCalculator:Te,OverviewPane:ye});class Ee extends F.ObjectWrapper{constructor(e,t){super(),this._profileType=e,this.title=t,this.uid=e.incrementProfileUid(),this._fromFile=!1,this.tempFile=null}setTitle(e){this.title=e,this.dispatchEventToListeners(Ne.ProfileTitleChanged,this)}profileType(){return this._profileType}updateStatus(e,t){this.dispatchEventToListeners(Ne.UpdateStatus,new Ie(e,t))}createSidebarTreeElement(e){throw new Error("Not implemented.")}createView(e){throw new Error("Not implemented.")}removeTempFile(){this.tempFile&&this.tempFile.remove()}dispose(){}canSaveToFile(){return!1}saveToFile(){throw new Error("Not implemented")}loadFromFile(e){throw new Error("Not implemented")}fromFile(){return this._fromFile}setFromFile(){this._fromFile=!0}setProfile(e){}}class Ie{constructor(e,t){this.subtitle=e,this.wait=t}}const Ne={UpdateStatus:Symbol("UpdateStatus"),ProfileReceived:Symbol("ProfileReceived"),ProfileTitleChanged:Symbol("ProfileTitleChanged")};class Re extends F.ObjectWrapper{constructor(e,t){super(),this._id=e,this._name=t,this._profiles=[],this._profileBeingRecorded=null,this._nextProfileUid=1,window.opener||window.addEventListener("unload",this._clearTempStorage.bind(this),!1)}typeName(){return""}nextProfileUid(){return this._nextProfileUid}incrementProfileUid(){return this._nextProfileUid++}hasTemporaryView(){return!1}fileExtension(){return null}get buttonTooltip(){return""}get id(){return this._id}get treeItemTitle(){return this._name}get name(){return this._name}buttonClicked(){return!1}get description(){return""}isInstantProfile(){return!1}isEnabled(){return!0}getProfiles(){return this._profiles.filter(function(e){return this._profileBeingRecorded!==e}.bind(this))}customContent(){return null}setCustomContentEnabled(e){}getProfile(e){for(let t=0;t<this._profiles.length;++t)if(this._profiles[t].uid===e)return this._profiles[t];return null}loadFromFile(e){let t=e.name;const i=this.fileExtension();i&&t.endsWith(i)&&(t=t.substr(0,t.length-i.length));const s=this.createProfileLoadedFromFile(t);return s.setFromFile(),this.setProfileBeingRecorded(s),this.addProfile(s),s.loadFromFile(e)}createProfileLoadedFromFile(e){throw new Error("Needs implemented.")}addProfile(e){this._profiles.push(e),this.dispatchEventToListeners(De.AddProfileHeader,e)}removeProfile(e){const t=this._profiles.indexOf(e);-1!==t&&(this._profiles.splice(t,1),this._disposeProfile(e))}_clearTempStorage(){for(let e=0;e<this._profiles.length;++e)this._profiles[e].removeTempFile()}profileBeingRecorded(){return this._profileBeingRecorded}setProfileBeingRecorded(e){this._profileBeingRecorded=e}profileBeingRecordedRemoved(){}reset(){for(const e of this._profiles.slice())this._disposeProfile(e);this._profiles=[],this._nextProfileUid=1}_disposeProfile(e){this.dispatchEventToListeners(De.RemoveProfileHeader,e),e.dispose(),this._profileBeingRecorded===e&&(this.profileBeingRecordedRemoved(),this.setProfileBeingRecorded(null))}}const De={AddProfileHeader:Symbol("add-profile-header"),ProfileComplete:Symbol("profile-complete"),RemoveProfileHeader:Symbol("remove-profile-header"),ViewUpdated:Symbol("view-updated")};var Fe=Object.freeze({__proto__:null,ProfileHeader:Ee,StatusUpdate:Ie,Events:Ne,ProfileType:Re,ProfileEvents:De,DataDisplayDelegate:class{showProfile(e){throw new Error("not implemented")}showObject(e,t){}async linkifyObject(e){throw new Error("not implemented")}}});const Le={save:"Save",saveWithEllipsis:"Save…",singlePlaceholder:"{PH1}",load:"Load…",delete:"Delete"},He=a.registerUIStrings("profiler/ProfileSidebarTreeElement.js",Le),ke=a.getLocalizedString.bind(void 0,He);let Me=null;function Oe(){return Me}function ze(e){Me=e}class Be extends p.TreeElement{constructor(e,t,i){super("",!1),this._iconElement=document.createElement("div"),this._iconElement.classList.add("icon"),this._titlesElement=document.createElement("div"),this._titlesElement.classList.add("titles"),this._titlesElement.classList.add("no-subtitle"),this._titleContainer=this._titlesElement.createChild("span","title-container"),this.titleElement=this._titleContainer.createChild("span","title"),this._subtitleElement=this._titlesElement.createChild("span","subtitle"),this.titleElement.textContent=t.title,this._className=i,this._small=!1,this._dataDisplayDelegate=e,this.profile=t,t.addEventListener(Ne.UpdateStatus,this._updateStatus,this),t.canSaveToFile()?this._createSaveLink():t.addEventListener(Ne.ProfileReceived,this._onProfileReceived,this)}_createSaveLink(){this._saveLinkElement=this._titleContainer.createChild("span","save-link"),this._saveLinkElement.textContent=ke(Le.save),this._saveLinkElement.addEventListener("click",this._saveProfile.bind(this),!1)}_onProfileReceived(e){this._createSaveLink()}_updateStatus(e){const t=e.data;null!==t.subtitle&&(this._subtitleElement.textContent=t.subtitle||"",this._titlesElement.classList.toggle("no-subtitle",!t.subtitle)),"boolean"==typeof t.wait&&this.listItemElement&&(this._iconElement.classList.toggle("spinner",t.wait),this.listItemElement.classList.toggle("wait",t.wait))}ondblclick(e){return this._editing||this._startEditing(e.target),!1}_startEditing(e){const t=e.enclosingNodeOrSelfWithClass("title");if(!t)return;const i=new u.Config(this._editingCommitted.bind(this),this._editingCancelled.bind(this));this._editing=u.InplaceEditor.startEditing(t,i)}_editingCommitted(e,t){delete this._editing,this.profile.setTitle(t)}_editingCancelled(){delete this._editing}dispose(){this.profile.removeEventListener(Ne.UpdateStatus,this._updateStatus,this),this.profile.removeEventListener(Ne.ProfileReceived,this._onProfileReceived,this)}onselect(){return this._dataDisplayDelegate.showProfile(this.profile),!0}ondelete(){return this.profile.profileType().removeProfile(this.profile),!0}onattach(){this._className&&this.listItemElement.classList.add(this._className),this._small&&this.listItemElement.classList.add("small"),this.listItemElement.append(this._iconElement,this._titlesElement),this.listItemElement.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!0),_.setDescription(this.listItemElement,ke(Le.singlePlaceholder,{PH1:this.profile.profileType().name}))}_handleContextMenuEvent(e){const t=this.profile,i=new m.ContextMenu(e),s=Oe();if(!s)throw new Error("File selector element shared by ProfilePanel instances is missing");i.headerSection().appendItem(ke(Le.load),s.click.bind(s)),t.canSaveToFile()&&i.saveSection().appendItem(ke(Le.saveWithEllipsis),t.saveToFile.bind(t)),i.footerSection().appendItem(ke(Le.delete),this.ondelete.bind(this)),i.show()}_saveProfile(e){this.profile.saveToFile()}setSmall(e){this._small=e,this.listItemElement&&this.listItemElement.classList.toggle("small",this._small)}setMainTitle(e){this.titleElement.textContent=e}}var je=Object.freeze({__proto__:null,UIStrings:Le,setSharedFileSelectorElement:ze,ProfileSidebarTreeElement:Be});class Ve extends _e{constructor(e,t){super(e,t,Boolean(e.children&&e.children.length)),this._remainingChildren=e.children}static _sharedPopulate(e){const t=e._remainingChildren,i=t.length;for(let s=0;s<i;++s)e.appendChild(new Ve(t[s],e.tree));e._remainingChildren=[]}static _excludeRecursively(e,t){e._remainingChildren.length>0&&e.populate(),e.save();const i=e.children;let s=e.children.length;for(;s--;)Ve._excludeRecursively(i[s],t);const r=e.childrenByCallUID.get(t);r&&_e.merge(e,r,!0)}populateChildren(){Ve._sharedPopulate(this)}}class Ge extends me{constructor(e,t,i,s){super(e,t,s),this._remainingChildren=i.children,_e.populate(this)}focus(e){e&&(this.save(),e.savePosition(),this.children=[e],this.total=e.total)}exclude(e){e&&(this.save(),Ve._excludeRecursively(this,e.callUID),this.lastComparator&&this.sort(this.lastComparator,!0))}restore(){this._savedChildren&&(this.children[0].restorePosition(),super.restore())}populateChildren(){Ve._sharedPopulate(this)}}var Ae=Object.freeze({__proto__:null,TopDownProfileDataGridNode:Ve,TopDownProfileDataGridTree:Ge});const We={profile:"Profile",findByCostMsNameOrFile:"Find by cost (>50ms), name or file",function:"Function",profiler:"Profiler",profileViewMode:"Profile view mode",focusSelectedFunction:"Focus selected function",excludeSelectedFunction:"Exclude selected function",restoreAllFunctions:"Restore all functions",chart:"Chart",heavyBottomUp:"Heavy (Bottom Up)",treeTopDown:"Tree (Top Down)",profileD:"Profile {PH1}",loadingD:"Loading… {PH1}%",fileSReadErrorS:"File '{PH1}' read error: {PH2}",loading:"Loading…",failedToReadFile:"Failed to read file",parsing:"Parsing…",loaded:"Loaded"},Ue=a.registerUIStrings("profiler/ProfileView.js",We),Je=a.getLocalizedString.bind(void 0,Ue);class qe extends f.SimpleView{constructor(){super(Je(We.profile)),this._profile=null,this._searchableView=new g.SearchableView(this,null),this._searchableView.setPlaceholder(Je(We.findByCostMsNameOrFile)),this._searchableView.show(this.element);const e=[];e.push({id:"self",title:this.columnHeader("self"),width:"120px",fixedWidth:!0,sortable:!0,sort:r.Order.Descending,titleDOMFragment:void 0,align:void 0,editable:void 0,nonSelectable:void 0,longText:void 0,disclosure:void 0,weight:void 0,allowInSortByEvenWhenHidden:void 0,dataType:void 0,defaultWeight:void 0}),e.push({id:"total",title:this.columnHeader("total"),width:"120px",fixedWidth:!0,sortable:!0,sort:void 0,titleDOMFragment:void 0,align:void 0,editable:void 0,nonSelectable:void 0,longText:void 0,disclosure:void 0,weight:void 0,allowInSortByEvenWhenHidden:void 0,dataType:void 0,defaultWeight:void 0}),e.push({id:"function",title:Je(We.function),disclosure:!0,sortable:!0,sort:void 0,titleDOMFragment:void 0,align:void 0,editable:void 0,nonSelectable:void 0,longText:void 0,weight:void 0,allowInSortByEvenWhenHidden:void 0,dataType:void 0,defaultWeight:void 0,width:void 0,fixedWidth:void 0}),this.dataGrid=new r.DataGridImpl({displayName:Je(We.profiler),columns:e,editCallback:void 0,deleteCallback:void 0,refreshCallback:void 0}),this.dataGrid.addEventListener(r.Events.SortingChanged,this._sortProfile,this),this.dataGrid.addEventListener(r.Events.SelectedNode,this._nodeSelected.bind(this,!0)),this.dataGrid.addEventListener(r.Events.DeselectedNode,this._nodeSelected.bind(this,!1)),this.dataGrid.setRowContextMenuCallback(this._populateContextMenu.bind(this)),this.viewSelectComboBox=new v.ToolbarComboBox(this._changeView.bind(this),Je(We.profileViewMode)),this.focusButton=new v.ToolbarButton(Je(We.focusSelectedFunction),"largeicon-visibility"),this.focusButton.setEnabled(!1),this.focusButton.addEventListener(v.ToolbarButton.Events.Click,this._focusClicked,this),this.excludeButton=new v.ToolbarButton(Je(We.excludeSelectedFunction),"largeicon-delete"),this.excludeButton.setEnabled(!1),this.excludeButton.addEventListener(v.ToolbarButton.Events.Click,this._excludeClicked,this),this.resetButton=new v.ToolbarButton(Je(We.restoreAllFunctions),"largeicon-refresh"),this.resetButton.setEnabled(!1),this.resetButton.addEventListener(v.ToolbarButton.Events.Click,this._resetClicked,this),this._linkifier=new q.Linkifier($e),this._nodeFormatter,this._viewType,this.adjustedTotal,this.profileHeader}static buildPopoverTable(e){const t=document.createElement("table");for(const i of e){const e=t.createChild("tr");e.createChild("td").textContent=i.title,e.createChild("td").textContent=i.value}return t}setProfile(e){this._profile=e,this._bottomUpProfileDataGridTree=null,this._topDownProfileDataGridTree=null,this._changeView(),this.refresh()}profile(){return this._profile}initialize(e){this._nodeFormatter=e,this._viewType=L.Settings.instance().createSetting("profileView",Qe.Heavy);const t=[Qe.Flame,Qe.Heavy,Qe.Tree],i=new Map([[Qe.Flame,Je(We.chart)],[Qe.Heavy,Je(We.heavyBottomUp)],[Qe.Tree,Je(We.treeTopDown)]]),s=new Map(t.map((e=>[e,this.viewSelectComboBox.createOption(i.get(e),e)]))),r=this._viewType.get()||t[0],o=s.get(r)||s.get(t[0]);this.viewSelectComboBox.select(o),this._changeView(),this._flameChart&&this._flameChart.update()}focus(){this._flameChart?this._flameChart.focus():super.focus()}columnHeader(e){throw"Not implemented"}selectRange(e,t){this._flameChart&&this._flameChart.selectRange(e,t)}async toolbarItems(){return[this.viewSelectComboBox,this.focusButton,this.excludeButton,this.resetButton]}_getBottomUpProfileDataGridTree(){return this._bottomUpProfileDataGridTree||(this._bottomUpProfileDataGridTree=new ve(this._nodeFormatter,this._searchableView,this._profile.root,this.adjustedTotal)),this._bottomUpProfileDataGridTree}_getTopDownProfileDataGridTree(){return this._topDownProfileDataGridTree||(this._topDownProfileDataGridTree=new Ge(this._nodeFormatter,this._searchableView,this._profile.root,this.adjustedTotal)),this._topDownProfileDataGridTree}_populateContextMenu(e,t){const i=t;i.linkElement&&!e.containsTarget(i.linkElement)&&e.appendApplicableItems(i.linkElement)}willHide(){this._currentSearchResultIndex=-1}refresh(){if(!this.profileDataGridTree)return;const e=this.dataGrid.selectedNode?this.dataGrid.selectedNode.profileNode:null;this.dataGrid.rootNode().removeChildren();const t=this.profileDataGridTree.children,i=t.length;for(let e=0;e<i;++e)this.dataGrid.rootNode().appendChild(t[e]);e&&(e.selected=!0)}refreshVisibleData(){let e=this.dataGrid.rootNode().children[0];for(;e;)e.refresh(),e=e.traverseNextNode(!1,null,!0)}searchableView(){return this._searchableView}supportsCaseSensitiveSearch(){return!0}supportsRegexSearch(){return!1}searchCanceled(){this._searchableElement&&this._searchableElement.searchCanceled()}performSearch(e,t,i){this._searchableElement&&this._searchableElement.performSearch(e,t,i)}jumpToNextSearchResult(){this._searchableElement&&this._searchableElement.jumpToNextSearchResult()}jumpToPreviousSearchResult(){this._searchableElement&&this._searchableElement.jumpToPreviousSearchResult()}linkifier(){return this._linkifier}createFlameChartDataProvider(){throw"Not implemented"}_ensureFlameChartCreated(){this._flameChart||(this._dataProvider=this.createFlameChartDataProvider(),this._flameChart=new Pe(this._searchableView,this._dataProvider),this._flameChart.addEventListener(A.Events.EntryInvoked,(e=>{this._onEntryInvoked(e)})))}async _onEntryInvoked(e){if(!this._dataProvider)return;const t=e.data,i=this._dataProvider._entryNodes[t],s=this.profileHeader._debuggerModel;if(!i||!i.scriptId||!s)return;const r=s.scriptForId(i.scriptId);if(!r)return;const o=s.createRawLocation(r,i.lineNumber,i.columnNumber),n=await re.DebuggerWorkspaceBinding.instance().rawLocationToUILocation(o);H.reveal(n)}_changeView(){if(!this._profile)return;switch(this._searchableView.closeSearch(),this._visibleView&&this._visibleView.detach(),this._viewType.set(this.viewSelectComboBox.selectedOption().value),this._viewType.get()){case Qe.Flame:this._ensureFlameChartCreated(),this._visibleView=this._flameChart,this._searchableElement=this._flameChart;break;case Qe.Tree:this.profileDataGridTree=this._getTopDownProfileDataGridTree(),this._sortProfile(),this._visibleView=this.dataGrid.asWidget(),this._searchableElement=this.profileDataGridTree;break;case Qe.Heavy:this.profileDataGridTree=this._getBottomUpProfileDataGridTree(),this._sortProfile(),this._visibleView=this.dataGrid.asWidget(),this._searchableElement=this.profileDataGridTree}const e=this._viewType.get()===Qe.Flame;this.focusButton.setVisible(!e),this.excludeButton.setVisible(!e),this.resetButton.setVisible(!e),this._visibleView&&this._visibleView.show(this._searchableView.element)}_nodeSelected(e){this.focusButton.setEnabled(e),this.excludeButton.setEnabled(e)}_focusClicked(e){this.dataGrid.selectedNode&&(this.resetButton.setEnabled(!0),this.resetButton.element.focus(),this.profileDataGridTree&&this.profileDataGridTree.focus(this.dataGrid.selectedNode),this.refresh(),this.refreshVisibleData(),V.actionTaken(G.Action.CpuProfileNodeFocused))}_excludeClicked(e){const t=this.dataGrid.selectedNode;t&&(this.resetButton.setEnabled(!0),this.resetButton.element.focus(),t.deselect(),this.profileDataGridTree&&this.profileDataGridTree.exclude(t),this.refresh(),this.refreshVisibleData(),V.actionTaken(G.Action.CpuProfileNodeExcluded))}_resetClicked(e){this.viewSelectComboBox.selectElement().focus(),this.resetButton.setEnabled(!1),this.profileDataGridTree&&this.profileDataGridTree.restore(),this._linkifier.reset(),this.refresh(),this.refreshVisibleData()}_sortProfile(){if(!this.profileDataGridTree)return;const e=this.dataGrid.isSortOrderAscending(),t=this.dataGrid.sortColumnId(),i="function"===t?"functionName":t||"";this.profileDataGridTree.sort(me.propertyComparator(i,e),!1),this.refresh()}}const $e=30,Qe={Flame:"Flame",Tree:"Tree",Heavy:"Heavy"};class Ke extends Ee{constructor(e,t,i){super(t,i||Je(We.profileD,{PH1:t.nextProfileUid()})),this._debuggerModel=e}_onChunkTransferred(e){this._jsonifiedProfile&&this.updateStatus(Je(We.loadingD,{PH1:t.bytesToString(this._jsonifiedProfile.length)}))}_onError(e){const t=e.error();t&&this.updateStatus(Je(We.fileSReadErrorS,{PH1:e.fileName(),PH2:t.message}))}async write(e){this._jsonifiedProfile+=e}async close(){}dispose(){this.removeTempFile()}createSidebarTreeElement(e){return new Be(e,this,"profile-sidebar-tree-item")}canSaveToFile(){return!this.fromFile()&&Boolean(this._protocolProfile)}async saveToFile(){const e=new oe.FileOutputStream;if(!this._fileName){const e=i.toISO8601Compact(new Date),t=this.profileType().fileExtension();this._fileName=`${this.profileType().typeName()}-${e}${t}`}if(!await e.open(this._fileName)||!this.tempFile)return;const t=await this.tempFile.read();t&&await e.write(t),e.close()}async loadFromFile(e){this.updateStatus(Je(We.loading),!0);const t=new oe.ChunkedFileReader(e,1e7,this._onChunkTransferred.bind(this));this._jsonifiedProfile="";if(!await t.read(this))return this._onError(t),new Error(Je(We.failedToReadFile));this.updateStatus(Je(We.parsing),!0);let i=null;try{this._profile=JSON.parse(this._jsonifiedProfile),this.setProfile(this._profile),this.updateStatus(Je(We.loaded),!1)}catch(e){i=e,this.profileType().removeProfile(this)}return this._jsonifiedProfile=null,this.profileType().profileBeingRecorded()===this&&this.profileType().setProfileBeingRecorded(null),i}setProtocolProfile(e){this.setProfile(e),this._protocolProfile=e,this.tempFile=new ne.TempFile,this.tempFile.write([JSON.stringify(e)]),this.canSaveToFile()&&this.dispatchEventToListeners(Ne.ProfileReceived)}}var Xe=Object.freeze({__proto__:null,UIStrings:We,ProfileView:qe,maxLinkLength:$e,ViewTypes:Qe,WritableProfileHeader:Ke});const Ye={selfTime:"Self Time",totalTime:"Total Time",recordJavascriptCpuProfile:"Record JavaScript CPU Profile",stopCpuProfiling:"Stop CPU profiling",startCpuProfiling:"Start CPU profiling",cpuProfiles:"CPU PROFILES",cpuProfilesShow:"CPU profiles show where the execution time is spent in your page's JavaScript functions.",recording:"Recording…",fms:"{PH1} ms",formatPercent:"{PH1} %",name:"Name",url:"URL",aggregatedSelfTime:"Aggregated self time",aggregatedTotalTime:"Aggregated total time",notOptimized:"Not optimized"},Ze=a.registerUIStrings("profiler/CPUProfileView.js",Ye),et=a.getLocalizedString.bind(void 0,Ze);class tt extends qe{constructor(e){super(),this.profileHeader=e,this.initialize(new rt(this));const t=e.profileModel();this.adjustedTotal=t.profileHead.total,this.adjustedTotal-=t.idleNode?t.idleNode.total:0,this.setProfile(t)}wasShown(){super.wasShown(),U.Performance.instance().reset(),U.Performance.instance().appendCPUProfile(this.profileHeader.profileModel())}columnHeader(e){switch(e){case"self":return et(Ye.selfTime);case"total":return et(Ye.totalTime)}return k.LocalizedEmptyString}createFlameChartDataProvider(){return new ot(this.profileHeader.profileModel(),this.profileHeader._cpuProfilerModel)}}class it extends Re{constructor(){super(it.TypeId,et(Ye.recordJavascriptCpuProfile)),this._recording=!1,$.TargetManager.instance().addModelListener(Q.CPUProfilerModel,Q.Events.ConsoleProfileFinished,this._consoleProfileFinished,this)}profileBeingRecorded(){return super.profileBeingRecorded()}typeName(){return"CPU"}fileExtension(){return".cpuprofile"}get buttonTooltip(){return this._recording?et(Ye.stopCpuProfiling):et(Ye.startCpuProfiling)}buttonClicked(){return this._recording?(this._stopRecordingProfile(),!1):(this._startRecordingProfile(),!0)}get treeItemTitle(){return et(Ye.cpuProfiles)}get description(){return et(Ye.cpuProfilesShow)}_consoleProfileFinished(e){const t=e.data,i=t.cpuProfile,s=new st(t.cpuProfilerModel,this,t.title);s.setProtocolProfile(i),this.addProfile(s)}_startRecordingProfile(){const e=S.Context.instance().flavor(Q.CPUProfilerModel);if(this.profileBeingRecorded()||!e)return;const t=new st(e,this);this.setProfileBeingRecorded(t),$.TargetManager.instance().suspendAllTargets(),this.addProfile(t),t.updateStatus(et(Ye.recording)),this._recording=!0,e.startRecording(),V.actionTaken(G.Action.ProfilesCPUProfileTaken)}async _stopRecordingProfile(){this._recording=!1;const e=this.profileBeingRecorded();if(!e||!e._cpuProfilerModel)return;const t=await e._cpuProfilerModel.stopRecording(),i=this.profileBeingRecorded();if(i){if(!t)throw new Error("Expected profile to be non-null");i.setProtocolProfile(t),i.updateStatus(""),this.setProfileBeingRecorded(null)}await $.TargetManager.instance().resumeAllTargets(),this.dispatchEventToListeners(De.ProfileComplete,i)}createProfileLoadedFromFile(e){return new st(null,this,e)}profileBeingRecordedRemoved(){this._stopRecordingProfile()}}it.TypeId="CPU";class st extends Ke{constructor(e,t,i){super(e&&e.debuggerModel(),t,i),this._cpuProfilerModel=e}createView(){return new tt(this)}protocolProfile(){if(!this._protocolProfile)throw new Error("Expected _protocolProfile to be available");return this._protocolProfile}profileModel(){if(!this._profileModel)throw new Error("Expected _profileModel to be available");return this._profileModel}setProfile(e){const t=this._cpuProfilerModel&&this._cpuProfilerModel.target()||null;this._profileModel=new K.CPUProfileDataModel(e,t)}}class rt{constructor(e){this._profileView=e}formatValue(e){return et(Ye.fms,{PH1:e.toFixed(1)})}formatValueAccessibleText(e){return this.formatValue(e)}formatPercent(e,t){if(this._profileView){const i=this._profileView.profile();if(i&&t.profileNode!==i.idleNode)return et(Ye.formatPercent,{PH1:e.toFixed(2)})}return""}linkifyNode(e){const t=this._profileView.profileHeader._cpuProfilerModel,i=t?t.target():null,s={className:"profile-node-file",columnNumber:void 0,tabStop:void 0};return this._profileView.linkifier().maybeLinkifyConsoleCallFrame(i,e.profileNode.callFrame,s)}}class ot extends Ce{constructor(e,t){super(),this._cpuProfile=e,this._cpuProfilerModel=t}minimumBoundary(){return this._cpuProfile.profileStartTime}totalTime(){return this._cpuProfile.profileHead.total}entryHasDeoptReason(e){const t=this.entryNodes[e];return Boolean(t.deoptReason)}_calculateTimelineData(){const e=[],t=[];let i=5;this._cpuProfile.forEachFrame((function(){t.push(e.length),e.push(null)}),(function(s,r,o,n,a){const l=t.pop();e[l]=new ot.ChartEntry(s,n,o,a,r),i=Math.max(i,s)}));const s=new Array(e.length),r=new Uint16Array(e.length),o=new Float32Array(e.length),n=new Float32Array(e.length),a=new Float64Array(e.length);for(let t=0;t<e.length;++t){const i=e[t];i&&(s[t]=i.node,r[t]=i.depth,o[t]=i.duration,a[t]=i.startTime,n[t]=i.selfTime)}return this._maxStackDepth=i+1,this.entryNodes=s,this.timelineData_=new A.TimelineData(r,o,a,null),this._entrySelfTimes=n,this.timelineData_}prepareHighlightedEntryInfo(e){const t=this.timelineData_,i=this.entryNodes[e];if(!i)return null;const s=[];function r(e,t){s.push({title:e,value:t})}function o(e){return 0===e?"0":e<1e3?et(Ye.fms,{PH1:e.toFixed(1)}):Number.secondsToString(e/1e3,!0)}const n=l.beautifyFunctionName(i.functionName);r(et(Ye.name),n);const a=o(this._entrySelfTimes[e]),d=o(t.entryTotalTimes[e]);r(et(Ye.selfTime),a),r(et(Ye.totalTime),d);const h=new q.Linkifier,c=h.maybeLinkifyConsoleCallFrame(this._cpuProfilerModel&&this._cpuProfilerModel.target(),i.callFrame);c&&r(et(Ye.url),c.textContent||""),h.dispose(),r(et(Ye.aggregatedSelfTime),Number.secondsToString(i.self/1e3,!0)),r(et(Ye.aggregatedTotalTime),Number.secondsToString(i.total/1e3,!0));const p=i.deoptReason;return p&&r(et(Ye.notOptimized),p),qe.buildPopoverTable(s)}}ot.ChartEntry=class{constructor(e,t,i,s,r){this.depth=e,this.duration=t,this.startTime=i,this.selfTime=s,this.node=r}};var nt=Object.freeze({__proto__:null,UIStrings:Ye,CPUProfileView:tt,CPUProfileType:it,CPUProfileHeader:st,NodeFormatter:rt,CPUFlameChartDataProvider:ot});const at={javascriptVmInstances:"JavaScript VM instances",totalJsHeapSize:"Total JS heap size",totalPageJsHeapSizeChangeTrend:"Total page JS heap size change trend over the last {PH1} minutes.",totalPageJsHeapSizeAcrossAllVm:"Total page JS heap size across all VM instances.",changeRate:"{PH1}/s",increasingBySPerSecond:"increasing by {PH1} per second",decreasingBySPerSecond:"decreasing by {PH1} per second",heapSizeInUseByLiveJsObjects:"Heap size in use by live JS objects.",heapSizeChangeTrendOverTheLastS:"Heap size change trend over the last {PH1} minutes.",empty:"(empty)"},lt=a.registerUIStrings("profiler/IsolateSelector.js",at),dt=a.getLocalizedString.bind(void 0,lt);class ht extends c.VBox{constructor(){super(!1),this._items=new w.ListModel,this._list=new b.ListControl(this._items,this,b.ListMode.NonViewport),this._list.element.classList.add("javascript-vm-instances-list"),_.setAccessibleName(this._list.element,dt(at.javascriptVmInstances)),this.contentElement.appendChild(this._list.element),this._itemByIsolate=new Map,this._totalElement=document.createElement("div"),this._totalElement.classList.add("profile-memory-usage-item"),this._totalElement.classList.add("hbox"),this._totalValueDiv=this._totalElement.createChild("div","profile-memory-usage-item-size"),this._totalTrendDiv=this._totalElement.createChild("div","profile-memory-usage-item-trend"),this._totalElement.createChild("div").textContent=dt(at.totalJsHeapSize);const e=Math.round(X.MemoryTrendWindowMs/6e4);h.Tooltip.install(this._totalTrendDiv,dt(at.totalPageJsHeapSizeChangeTrend,{PH1:e})),h.Tooltip.install(this._totalValueDiv,dt(at.totalPageJsHeapSizeAcrossAllVm)),X.IsolateManager.instance().observeIsolates(this),$.TargetManager.instance().addEventListener($.Events.NameChanged,this._targetChanged,this),$.TargetManager.instance().addEventListener($.Events.InspectedURLChanged,this._targetChanged,this)}wasShown(){X.IsolateManager.instance().addEventListener(X.Events.MemoryChanged,this._heapStatsChanged,this)}willHide(){X.IsolateManager.instance().removeEventListener(X.Events.MemoryChanged,this._heapStatsChanged,this)}isolateAdded(e){this._list.element.tabIndex=0;const t=new ct(e),i=t.model().target()===$.TargetManager.instance().mainTarget()?0:this._items.length;this._items.insert(i,t),this._itemByIsolate.set(e,t),(1===this._items.length||e.isMainThread())&&this._list.selectItem(t),this._update()}isolateChanged(e){const t=this._itemByIsolate.get(e);t&&t.updateTitle(),this._update()}isolateRemoved(e){const t=this._itemByIsolate.get(e);t&&this._items.remove(this._items.indexOf(t)),this._itemByIsolate.delete(e),0===this._items.length&&(this._list.element.tabIndex=-1),this._update()}_targetChanged(e){const t=e.data.model(Y.RuntimeModel);if(!t)return;const i=X.IsolateManager.instance().isolateByModel(t),s=i&&this._itemByIsolate.get(i);s&&s.updateTitle()}_heapStatsChanged(e){const t=e.data,i=this._itemByIsolate.get(t);i&&i.updateStats(),this._updateTotal()}_updateTotal(){let e=0,i=0;for(const t of X.IsolateManager.instance().isolates())e+=t.usedHeapSize(),i+=t.usedHeapSizeGrowRate();this._totalValueDiv.textContent=t.bytesToString(e),ht._formatTrendElement(i,this._totalTrendDiv)}static _formatTrendElement(e,i){const s=1e3*e;if(Math.abs(s)<1e3)return;const r=t.bytesToString(Math.abs(s));let o,n;s>0?(o="⬆"+dt(at.changeRate,{PH1:r}),i.classList.toggle("increasing",!0),n=dt(at.increasingBySPerSecond,{PH1:r})):(o="⬇"+dt(at.changeRate,{PH1:r}),i.classList.toggle("increasing",!1),n=dt(at.decreasingBySPerSecond,{PH1:r})),i.textContent=o,_.setAccessibleName(i,n)}totalMemoryElement(){return this._totalElement}createElementForItem(e){return e.element}heightForItem(e){return console.assert(!1,"should not be called"),0}updateSelectedItemARIA(e,t){return!1}isItemSelectable(e){return!0}selectedItemChanged(e,t,i,s){i&&i.classList.remove("selected"),s&&s.classList.add("selected");const r=t&&t.model();S.Context.instance().setFlavor(Z.HeapProfilerModel,r&&r.heapProfilerModel()),S.Context.instance().setFlavor(Q.CPUProfilerModel,r&&r.target().model(Q.CPUProfilerModel))}_update(){this._updateTotal(),this._list.invalidateRange(0,this._items.length)}}class ct{constructor(e){this._isolate=e;const t=Math.round(X.MemoryTrendWindowMs/6e4);this.element=document.createElement("div"),this.element.classList.add("profile-memory-usage-item"),this.element.classList.add("hbox"),_.markAsOption(this.element),this._heapDiv=this.element.createChild("div","profile-memory-usage-item-size"),h.Tooltip.install(this._heapDiv,dt(at.heapSizeInUseByLiveJsObjects)),this._trendDiv=this.element.createChild("div","profile-memory-usage-item-trend"),h.Tooltip.install(this._trendDiv,dt(at.heapSizeChangeTrendOverTheLastS,{PH1:t})),this._nameDiv=this.element.createChild("div","profile-memory-usage-item-name"),this.updateTitle()}model(){return this._isolate.runtimeModel()}updateStats(){this._heapDiv.textContent=t.bytesToString(this._isolate.usedHeapSize()),ht._formatTrendElement(this._isolate.usedHeapSizeGrowRate(),this._trendDiv)}updateTitle(){const e=new Map;for(const t of this._isolate.models()){const i=t.target(),s=$.TargetManager.instance().mainTarget()!==i?i.name():"",r=new M.ParsedURL(i.inspectedURL()),o=r.isValid?r.domain():"",n=i.decorateLabel(o&&s?`${o}: ${s}`:s||o||dt(at.empty));e.set(n,(e.get(n)||0)+1)}this._nameDiv.removeChildren();const t=[];for(const[i,s]of e){const e=s>1?`${i} (${s})`:i;t.push(e);const r=this._nameDiv.createChild("div");r.textContent=e,h.Tooltip.install(r,String(e))}}}var pt=Object.freeze({__proto__:null,UIStrings:at,IsolateSelector:ht,ListItem:ct});const ut={selectJavascriptVmInstance:"Select JavaScript VM instance",load:"Load",takeSnapshot:"Take snapshot",stop:"Stop",start:"Start",selectProfilingType:"Select profiling type"},_t=a.registerUIStrings("profiler/ProfileLauncherView.js",ut),mt=a.getLocalizedString.bind(void 0,_t);class ft extends c.VBox{constructor(e){super(),this.registerRequiredCSS("profiler/profileLauncherView.css",{enableLegacyPatching:!0}),this._panel=e,this.element.classList.add("profile-launcher-view"),this._contentElement=this.element.createChild("div","profile-launcher-view-content vbox");const t=this._contentElement.createChild("div","vbox");this._selectedProfileTypeSetting=L.Settings.instance().createSetting("selectedProfileType","CPU"),this._profileTypeHeaderElement=t.createChild("h1"),this._profileTypeSelectorForm=t.createChild("form"),_.markAsRadioGroup(this._profileTypeSelectorForm);const i=this._contentElement.createChild("div","vbox profile-isolate-selector-block");i.createChild("h1").textContent=mt(ut.selectJavascriptVmInstance);const s=new ht;s.show(i.createChild("div","vbox profile-launcher-target-list")),i.appendChild(s.totalMemoryElement());const r=this._contentElement.createChild("div","hbox profile-launcher-buttons");this._controlButton=l.createTextButton("",this._controlButtonClicked.bind(this),"",!0),this._loadButton=l.createTextButton(mt(ut.load),this._loadButtonClicked.bind(this),""),r.appendChild(this._controlButton),r.appendChild(this._loadButton),this._recordButtonEnabled=!0,this._typeIdToOptionElementAndProfileType=new Map}_loadButtonClicked(){this._panel.showLoadFromFileDialog()}_updateControls(){this._isEnabled&&this._recordButtonEnabled?this._controlButton.removeAttribute("disabled"):this._controlButton.setAttribute("disabled",""),h.Tooltip.install(this._controlButton,this._recordButtonEnabled?"":l.anotherProfilerActiveLabel()),this._isInstantProfile?(this._controlButton.classList.remove("running"),this._controlButton.classList.add("primary-button"),this._controlButton.textContent=mt(ut.takeSnapshot)):this._isProfiling?(this._controlButton.classList.add("running"),this._controlButton.classList.remove("primary-button"),this._controlButton.textContent=mt(ut.stop)):(this._controlButton.classList.remove("running"),this._controlButton.classList.add("primary-button"),this._controlButton.textContent=mt(ut.start));for(const{optionElement:e}of this._typeIdToOptionElementAndProfileType.values())e.disabled=Boolean(this._isProfiling)}profileStarted(){this._isProfiling=!0,this._updateControls()}profileFinished(){this._isProfiling=!1,this._updateControls()}updateProfileType(e,t){this._isInstantProfile=e.isInstantProfile(),this._recordButtonEnabled=t,this._isEnabled=e.isEnabled(),this._updateControls()}addProfileType(e){const t=l.createRadioLabel("profile-type",e.name);this._profileTypeSelectorForm.appendChild(t);const i=t.radioElement;this._typeIdToOptionElementAndProfileType.set(e.id,{optionElement:i,profileType:e}),i.addEventListener("change",this._profileTypeChanged.bind(this,e),!1);this._profileTypeSelectorForm.createChild("p").textContent=e.description,_.setDescription(i,e.description);const s=e.customContent();s&&(this._profileTypeSelectorForm.createChild("p").appendChild(s),e.setCustomContentEnabled(!1));const r=this._typeIdToOptionElementAndProfileType.size>1?mt(ut.selectProfilingType):e.name;this._profileTypeHeaderElement.textContent=r,_.setAccessibleName(this._profileTypeSelectorForm,r)}restoreSelectedProfileType(){let e=this._selectedProfileTypeSetting.get();this._typeIdToOptionElementAndProfileType.has(e)||(e=this._typeIdToOptionElementAndProfileType.keys().next().value,this._selectedProfileTypeSetting.set(e));const t=this._typeIdToOptionElementAndProfileType.get(e);t.optionElement.checked=!0;const i=t.profileType;for(const[t,{profileType:i}]of this._typeIdToOptionElementAndProfileType){const s=t===e;i.setCustomContentEnabled(s)}this.dispatchEventToListeners(gt.ProfileTypeSelected,i)}_controlButtonClicked(){this._panel.toggleRecord()}_profileTypeChanged(e){const t=this._selectedProfileTypeSetting.get();this._typeIdToOptionElementAndProfileType.get(t).profileType.setCustomContentEnabled(!1),e.setCustomContentEnabled(!0),this.dispatchEventToListeners(gt.ProfileTypeSelected,e),this._isInstantProfile=e.isInstantProfile(),this._isEnabled=e.isEnabled(),this._updateControls(),this._selectedProfileTypeSetting.set(e.id)}}const gt={ProfileTypeSelected:Symbol("ProfileTypeSelected")};var vt=Object.freeze({__proto__:null,UIStrings:ut,ProfileLauncherView:ft,Events:gt});class St extends c.VBox{constructor(){super(),this.element.id="heap-recording-view",this.element.classList.add("heap-tracking-overview"),this._overviewCalculator=new Pt,this._overviewContainer=this.element.createChild("div","heap-overview-container"),this._overviewGrid=new W.OverviewGrid("heap-recording",this._overviewCalculator),this._overviewGrid.element.classList.add("fill"),this._overviewCanvas=this._overviewContainer.createChild("canvas","heap-recording-overview-canvas"),this._overviewContainer.appendChild(this._overviewGrid.element),this._overviewGrid.addEventListener(W.Events.WindowChanged,this._onWindowChanged,this),this._windowLeft=0,this._windowRight=1,this._overviewGrid.setWindow(this._windowLeft,this._windowRight),this._yScale=new bt,this._xScale=new bt,this._profileSamples=new Ct}start(){this._running=!0;const e=()=>{this.update(),this._running&&this.element.window().requestAnimationFrame(e)};e()}stop(){this._running=!1}setSamples(e){this._profileSamples=e,this._running||this.update()}_drawOverviewCanvas(e,i){if(!this._profileSamples)return;const s=this._profileSamples,r=s.sizes,o=s.max,n=s.timestamps,a=n[0],l=this._xScale.nextScale(e/s.totalTime);let d=0;function h(e,t){let i=0,s=0;for(let r=1;r<n.length;++r){const o=Math.floor((n[r]-a)*l);o!==s&&(i&&t(s,i),i=0,s=o),i+=e[r]}t(s,i)}h(r,(function(e,t){d=Math.max(d,t)}));const c=this._yScale.nextScale(d?i/(1.1*d):0);this._overviewCanvas.width=e*window.devicePixelRatio,this._overviewCanvas.height=i*window.devicePixelRatio,this._overviewCanvas.style.width=e+"px",this._overviewCanvas.style.height=i+"px";const p=this._overviewCanvas.getContext("2d");if(!p)throw new Error("Failed to get canvas context");const u=p;if(u.scale(window.devicePixelRatio,window.devicePixelRatio),this._running){u.beginPath(),u.lineWidth=2,u.strokeStyle="rgba(192, 192, 192, 0.6)";const e=(Date.now()-a)*l;u.moveTo(e,i-1),u.lineTo(e,0),u.stroke(),u.closePath()}let _,m=0;if(c){const t=(i-14)/c;_=Math.pow(1024,Math.floor(Math.log(t)/Math.log(1024))),_*=Math.pow(10,Math.floor(Math.log(t/_)/Math.LN10)),5*_<=t&&(_*=5),m=Math.round(i-_*c-.5)+.5,u.beginPath(),u.lineWidth=1,u.strokeStyle="rgba(0, 0, 0, 0.2)",u.moveTo(0,m),u.lineTo(e,m),u.stroke(),u.closePath()}function f(e,t){u.moveTo(e,i-1),u.lineTo(e,Math.round(i-t*c-1))}if(u.beginPath(),u.lineWidth=2,u.strokeStyle="rgba(192, 192, 192, 0.6)",h(o,f),u.stroke(),u.closePath(),u.beginPath(),u.lineWidth=2,u.strokeStyle="rgba(0, 0, 192, 0.8)",h(r,f),u.stroke(),u.closePath(),_){const e=t.bytesToString(_),i=4,s=0,r=m-.5,o=2*i+u.measureText(e).width;u.beginPath(),u.textBaseline="bottom",u.font="10px "+window.getComputedStyle(this.element,null).getPropertyValue("font-family"),u.fillStyle="rgba(255, 255, 255, 0.75)",u.fillRect(s,r-14,o,14),u.fillStyle="rgb(64, 64, 64)",u.fillText(e,s+i,r),u.fill(),u.closePath()}}onResize(){this._updateOverviewCanvas=!0,this._scheduleUpdate()}_onWindowChanged(){this._updateGridTimerId||(this._updateGridTimerId=setTimeout(this.updateGrid.bind(this),10))}_scheduleUpdate(){this._updateTimerId||(this._updateTimerId=setTimeout(this.update.bind(this),10))}_updateBoundaries(){this._windowLeft=this._overviewGrid.windowLeft(),this._windowRight=this._overviewGrid.windowRight(),this._windowWidth=this._windowRight-this._windowLeft}update(){this._updateTimerId=null,this.isShowing()&&(this._updateBoundaries(),this._overviewCalculator._updateBoundaries(this),this._overviewGrid.updateDividers(this._overviewCalculator),this._drawOverviewCanvas(this._overviewContainer.clientWidth,this._overviewContainer.clientHeight-20))}updateGrid(){this._updateGridTimerId=0,this._updateBoundaries();const t=this._profileSamples.ids;if(!t.length)return;const i=this._profileSamples.timestamps,s=this._profileSamples.sizes,r=i[0],o=this._profileSamples.totalTime,n=r+o*this._windowLeft,a=r+o*this._windowRight,l=e.lowerBound(i,n,e.DEFAULT_COMPARATOR),d=e.upperBound(i,a,e.DEFAULT_COMPARATOR);let h=0;for(let e=l;e<=d;++e)h+=s[e];const c=l>0?t[l-1]:0,p=d<t.length?t[d]:1/0;this.dispatchEventToListeners(wt,{minId:c,maxId:p,size:h})}}const wt=Symbol("IdsRangeChanged");class bt{constructor(){this._lastUpdate=0,this._currentScale=0}nextScale(e){if(e=e||this._currentScale,this._currentScale){const i=Date.now(),s=i-this._lastUpdate;this._lastUpdate=i;const r=20,o=Math.pow(r,s/1e3),n=e/this._currentScale;this._currentScale*=t.clamp(n,1/o,o)}else this._currentScale=e;return this._currentScale}}class Ct{constructor(){this.sizes=[],this.ids=[],this.timestamps=[],this.max=[],this.totalTime=3e4}}class Pt{constructor(){this._maximumBoundaries=0,this._minimumBoundaries=0,this._xScaleFactor=0}_updateBoundaries(e){this._minimumBoundaries=0,this._maximumBoundaries=e._profileSamples.totalTime,this._xScaleFactor=e._overviewContainer.clientWidth/this._maximumBoundaries}computePosition(e){return(e-this._minimumBoundaries)*this._xScaleFactor}formatValue(e,t){return Number.secondsToString(e/1e3,Boolean(t))}maximumBoundary(){return this._maximumBoundaries}minimumBoundary(){return this._minimumBoundaries}zeroTime(){return this._minimumBoundaries}boundarySpan(){return this._maximumBoundaries-this._minimumBoundaries}}var Tt=Object.freeze({__proto__:null,HeapTimelineOverview:St,IdsRangeChanged:wt,SmoothScale:bt,Samples:Ct,OverviewCalculator:Pt});const yt={selectedSizeS:"Selected size: {PH1}",selfSizeBytes:"Self Size (bytes)",totalSizeBytes:"Total Size (bytes)",stopHeapProfiling:"Stop heap profiling",startHeapProfiling:"Start heap profiling",recording:"Recording…",heapProfilerIsRecording:"Heap profiler is recording",stopping:"Stopping…",allocationSampling:"Allocation sampling",samplingProfiles:"SAMPLING PROFILES",recordMemoryAllocationsUsing:"Record memory allocations using sampling method.\n              This profile type has minimal performance overhead and can be used for long running operations.\n              It provides good approximation of allocations broken down by JavaScript execution stack.",profileD:"Profile {PH1}",sBytes:"{PH1} bytes",formatPercent:"{PH1} %",skb:"{PH1} kB",name:"Name",selfSize:"Self size",totalSize:"Total size",url:"URL"},xt=a.registerUIStrings("profiler/HeapProfileView.js",yt),Et=a.getLocalizedString.bind(void 0,xt);function It(e){return e._profile||e.protocolProfile()}class Nt extends qe{constructor(e){super(),this.profileHeader=e,this._profileType=e.profileType(),this.initialize(new Mt(this));const t=new kt(It(e));this.adjustedTotal=t.total,this.setProfile(t),this._selectedSizeText=new v.ToolbarText,this._timestamps=[],this._sizes=[],this._max=[],this._ordinals=[],this._totalTime=0,this._lastOrdinal=0,this._timelineOverview=new St,ae.experiments.isEnabled("samplingHeapProfilerTimeline")&&(this._timelineOverview.addEventListener(wt,this._onIdsRangeChanged.bind(this)),this._timelineOverview.show(this.element,this.element.firstChild),this._timelineOverview.start(),this._profileType.addEventListener(Ft.Events.StatsUpdate,this._onStatsUpdate,this),this._profileType.once(De.ProfileComplete).then((()=>{this._profileType.removeEventListener(Ft.Events.StatsUpdate,this._onStatsUpdate,this),this._timelineOverview.stop(),this._timelineOverview.updateGrid()})))}async toolbarItems(){return[...await super.toolbarItems(),this._selectedSizeText]}_onIdsRangeChanged(e){const i=e.data.minId,s=e.data.maxId;this._selectedSizeText.setText(Et(yt.selectedSizeS,{PH1:t.bytesToString(e.data.size)})),this._setSelectionRange(i,s)}_setSelectionRange(e,t){const i=It(this.profileHeader),s=new kt(i,e,t);this.adjustedTotal=s.total,this.setProfile(s)}_onStatsUpdate(t){const i=t.data;this._totalTime||(this._timestamps=[],this._sizes=[],this._max=[],this._ordinals=[],this._totalTime=3e4,this._lastOrdinal=0),this._sizes.fill(0),this._sizes.push(0),this._timestamps.push(Date.now()),this._ordinals.push(this._lastOrdinal+1);for(const t of i.samples){this._lastOrdinal=Math.max(this._lastOrdinal,t.ordinal);const i=e.upperBound(this._ordinals,t.ordinal,e.DEFAULT_COMPARATOR)-1;this._sizes[i]+=t.size}this._max.push(this._sizes[this._sizes.length-1]);this._timestamps[this._timestamps.length-1]-this._timestamps[0]>this._totalTime&&(this._totalTime*=2);const s={sizes:this._sizes,max:this._max,ids:this._ordinals,timestamps:this._timestamps,totalTime:this._totalTime};this._timelineOverview.setSamples(s)}columnHeader(e){switch(e){case"self":return Et(yt.selfSizeBytes);case"total":return Et(yt.totalSizeBytes)}return k.LocalizedEmptyString}createFlameChartDataProvider(){return new Ot(this.profile(),this.profileHeader.heapProfilerModel())}}class Rt extends Re{constructor(e,t){super(e,t),this._recording=!1}profileBeingRecorded(){return super.profileBeingRecorded()}typeName(){return"Heap"}fileExtension(){return".heapprofile"}get buttonTooltip(){return this._recording?Et(yt.stopHeapProfiling):Et(yt.startHeapProfiling)}buttonClicked(){return this._recording?this._stopRecordingProfile():this._startRecordingProfile(),this._recording}_startRecordingProfile(){const e=S.Context.instance().flavor(Z.HeapProfilerModel);if(this.profileBeingRecorded()||!e)return;const t=new Lt(e,this);this.setProfileBeingRecorded(t),this.addProfile(t),t.updateStatus(Et(yt.recording));const i=d.Icon.create("smallicon-warning");h.Tooltip.install(i,Et(yt.heapProfilerIsRecording)),C.InspectorView.instance().setPanelIcon("heap_profiler",i),this._recording=!0,this._startSampling()}async _stopRecordingProfile(){this._recording=!1;const e=this.profileBeingRecorded();if(!e||!e.heapProfilerModel())return;e.updateStatus(Et(yt.stopping));const t=await this._stopSampling();e&&(console.assert(void 0!==t),e.setProtocolProfile(t),e.updateStatus(""),this.setProfileBeingRecorded(null)),C.InspectorView.instance().setPanelIcon("heap_profiler",null),this.dispatchEventToListeners(De.ProfileComplete,e)}createProfileLoadedFromFile(e){return new Lt(null,this,e)}profileBeingRecordedRemoved(){this._stopRecordingProfile()}_startSampling(){throw"Not implemented"}_stopSampling(){throw"Not implemented"}}let Dt;class Ft extends Rt{constructor(){super(Ft.TypeId,Et(yt.allocationSampling)),Dt||(Dt=this),this._updateTimer=0,this._updateIntervalMs=200}static get instance(){return Dt}get treeItemTitle(){return Et(yt.samplingProfiles)}get description(){return Et(yt.recordMemoryAllocationsUsing)}hasTemporaryView(){return ae.experiments.isEnabled("samplingHeapProfilerTimeline")}_startSampling(){const e=this._obtainRecordingProfile();e&&(e.startSampling(),ae.experiments.isEnabled("samplingHeapProfilerTimeline")&&(this._updateTimer=window.setTimeout((()=>{this._updateStats()}),this._updateIntervalMs)))}_obtainRecordingProfile(){const e=this.profileBeingRecorded();if(e){return e.heapProfilerModel()}return null}async _stopSampling(){window.clearTimeout(this._updateTimer),this._updateTimer=0,this.dispatchEventToListeners(Ft.Events.RecordingStopped);const e=this._obtainRecordingProfile();if(!e)throw new Error("No heap profiler model");const t=await e.stopSampling();if(!t)throw new Error("No sampling profile found");return t}async _updateStats(){const e=this._obtainRecordingProfile();if(!e)return;const t=await e.getSamplingProfile();this._updateTimer&&(this.dispatchEventToListeners(Ft.Events.StatsUpdate,t),this._updateTimer=window.setTimeout((()=>{this._updateStats()}),this._updateIntervalMs))}}Ft.TypeId="SamplingHeap",Ft.Events={RecordingStopped:Symbol("RecordingStopped"),StatsUpdate:Symbol("StatsUpdate")};class Lt extends Ke{constructor(e,t,i){super(e&&e.debuggerModel(),t,i||Et(yt.profileD,{PH1:t.nextProfileUid()})),this._heapProfilerModel=e,this._protocolProfile={head:{callFrame:{functionName:"",scriptId:"",url:"",lineNumber:0,columnNumber:0},children:[],selfSize:0,id:0},samples:[],startTime:0,endTime:0,nodes:[]}}createView(){return new Nt(this)}protocolProfile(){return this._protocolProfile}heapProfilerModel(){return this._heapProfilerModel}}class Ht extends ee.ProfileNode{constructor(e){super(e.callFrame||{functionName:e.functionName,scriptId:e.scriptId,url:e.url,lineNumber:e.lineNumber-1,columnNumber:e.columnNumber-1}),this.self=e.selfSize}}class kt extends ee.ProfileTreeModel{constructor(e,t,i){super(),this.modules=e.modules||[];let s=null;if(t||i){s=new Map,t=t||0,i=i||1/0;for(const r of e.samples){if(r.ordinal<t||r.ordinal>i)continue;const e=s.get(r.nodeId)||0;s.set(r.nodeId,e+r.size)}}function r(e){return e.children=e.children.filter(r),Boolean(e.children.length||e.self)}this.initialize(function(e){const t=new Ht(e),i=[e],o=[t];for(;i.length;){const e=i.pop(),t=o.pop();t.children=e.children.map((e=>{const t=new Ht(e);return s&&(t.self=s.get(e.id)||0),t})),i.push(...e.children),o.push(...t.children)}return r(t),t}(e.head))}}class Mt{constructor(e){this._profileView=e}formatValue(e){return Number.withThousandsSeparator(e)}formatValueAccessibleText(e){return Et(yt.sBytes,{PH1:e})}formatPercent(e,t){return Et(yt.formatPercent,{PH1:e.toFixed(2)})}linkifyNode(e){const t=this._profileView.profileHeader.heapProfilerModel(),i=t?t.target():null,s={className:"profile-node-file",columnNumber:void 0,tabStop:void 0};return this._profileView.linkifier().maybeLinkifyConsoleCallFrame(i,e.profileNode.callFrame,s)}}class Ot extends Ce{constructor(e,t){super(),this._profile=e,this._heapProfilerModel=t,this._entryNodes=[]}minimumBoundary(){return 0}totalTime(){return this._profile.root.total}entryHasDeoptReason(e){return!1}formatValue(e,t){return Et(yt.skb,{PH1:Number.withThousandsSeparator(e/1e3)})}_calculateTimelineData(){const e=function e(t){return t.children.reduce(((t,i)=>t+e(i)),1)}(this._profile.root),t=new Array(e),i=new Uint16Array(e),s=new Float32Array(e),r=new Float64Array(e);let o=0,n=0,a=0,l=0;return function e(d){const h=a;t[l]=d,i[l]=o,s[l]=d.total,r[l]=a,++l,++o,d.children.forEach(e),--o,n=Math.max(n,o),a=h+d.total}(this._profile.root),this._maxStackDepth=n+1,this._entryNodes=t,this._timelineData=new A.TimelineData(i,s,r,null),this._timelineData}prepareHighlightedEntryInfo(e){const i=this._entryNodes[e];if(!i)return null;const s=[];function r(e,t){s.push({title:e,value:t})}r(Et(yt.name),l.beautifyFunctionName(i.functionName)),r(Et(yt.selfSize),t.bytesToString(i.self)),r(Et(yt.totalSize),t.bytesToString(i.total));const o=new q.Linkifier,n=o.maybeLinkifyConsoleCallFrame(this._heapProfilerModel?this._heapProfilerModel.target():null,i.callFrame);return n&&r(Et(yt.url),n.textContent),o.dispose(),qe.buildPopoverTable(s)}}var zt=Object.freeze({__proto__:null,UIStrings:yt,HeapProfileView:Nt,SamplingHeapProfileTypeBase:Rt,SamplingHeapProfileType:Ft,SamplingHeapProfileHeader:Lt,SamplingHeapProfileNode:Ht,SamplingHeapProfileModel:kt,NodeFormatter:Mt,HeapFlameChartDataProvider:Ot});const Bt={emptyPlaceholder:"{PH1}",genericStringsTwoPlaceholders:"{PH1}, {PH2}",internalArray:"(internal array)[]",userObjectReachableFromWindow:"User object reachable from window",detachedFromDomTree:"Detached from DOM tree",previewIsNotAvailable:"Preview is not available",revealInSummaryView:"Reveal in Summary view",summary:"Summary",revealObjectSWithIdSInSummary:"Reveal object '{PH1}' with id @{PH2} in Summary view",storeAsGlobalVariable:"Store as global variable",inElement:"in"},jt=a.registerUIStrings("profiler/HeapSnapshotGridNodes.js",Bt),Vt=a.getLocalizedString.bind(void 0,jt);class Gt extends r.DataGridNode{constructor(e,t){super(null,t),this._dataGrid=e,this._instanceCount=0,this._savedChildren=new Map,this._retrievedChildrenRanges=[],this._providerObject=null,this._reachableFromWindow=!1}get name(){}heapSnapshotDataGrid(){return this._dataGrid}createProvider(){throw new Error("Not implemented.")}comparator(){throw new Error("Not implemented.")}_getHash(){throw new Error("Not implemented.")}_createChildNode(e){throw new Error("Not implemented.")}retainersDataSource(){return null}_provider(){return this._providerObject||(this._providerObject=this.createProvider()),this._providerObject}createCell(e){return super.createCell(e)}collapse(){super.collapse(),this._dataGrid.updateVisibleNodes(!0)}expand(){super.expand(),this._dataGrid.updateVisibleNodes(!0)}dispose(){this._providerObject&&this._providerObject.dispose();for(let e=this.children[0];e;e=e.traverseNextNode(!0,this,!0))e.dispose()}queryObjectContent(e,t){throw new Error("Not implemented")}tryQueryObjectContent(e,t){throw new Error("Not implemented")}populateContextMenu(e,t,i){}_toPercentString(e){return e.toFixed(0)+" %"}_toUIDistance(e){const t=le.baseSystemDistance;return e>=0&&e<t?Vt(Bt.emptyPlaceholder,{PH1:e}):"−"}allChildren(){return this._dataGrid.allChildren(this)}removeChildByIndex(e){this._dataGrid.removeChildByIndex(this,e)}childForPosition(e){let t=0;for(let i=0;i<this._retrievedChildrenRanges.length;i++){const s=this._retrievedChildrenRanges[i];if(s.from<=e&&e<s.to){const i=t+e-s.from;return this.allChildren()[i]}t+=s.to-s.from+1}return null}_createValueCell(e){const t=P.html`<td class="numeric-column" />`,i=this.dataGrid;if(i.snapshot&&0!==i.snapshot.totalSize){const i=document.createElement("div"),s=P.html`<span>${this.data[e]}</span>`;i.appendChild(s);const r=e+"-percent";if(r in this.data){const o=P.html`<span class="percent-column">${this.data[r]}</span>`;i.appendChild(o),i.classList.add("profile-multiple-values"),_.markAsHidden(s),_.markAsHidden(o),this.setCellAccessibleName(Vt(Bt.genericStringsTwoPlaceholders,{PH1:this.data[e],PH2:this.data[r]}),t,e)}t.appendChild(i)}return t}populate(){this._populated||(this._populated=!0,this._provider().sortAndRewind(this.comparator()).then((()=>this._populateChildren())))}expandWithoutPopulate(){return this._populated=!0,this.expand(),this._provider().sortAndRewind(this.comparator())}_childHashForEntity(e){return"edgeIndex"in e?e.edgeIndex:e.id}_populateChildren(e,t){return new Promise((i=>{e=e||0,t=t||e+this._dataGrid.defaultPopulateCount();let s=e;function r(e){if(s>=e)return;const t=Math.min(s+this._dataGrid.defaultPopulateCount(),e);this._provider().serializeItemsRange(s,t).then((t=>l.call(this,t,e))),s=t}function n(e,t){if(this._savedChildren){const i=this._childHashForEntity(e),s=this._savedChildren.get(i);if(s)return void this._dataGrid.insertChild(this,s,t)}this._dataGrid.insertChild(this,this._createChildNode(e),t)}function a(e,t,i){const s=new o.ShowMoreDataGridNode(this._populateChildren.bind(this),e,t,this._dataGrid.defaultPopulateCount());this._dataGrid.insertChild(this,s,i)}function l(e,t){let o=0,l=e.startPosition;const d=e.items;let h=0;if(this._retrievedChildrenRanges.length){let t=0,i=!1,s={from:0,to:0};for(;t<this._retrievedChildrenRanges.length;){if(s=this._retrievedChildrenRanges[t],s.to>=l){i=!0;break}h+=s.to-s.from,s.to<e.totalLength&&(h+=1),++t}if(!i||e.startPosition<s.from){this.allChildren()[h-1].setEndPosition(e.startPosition),a.call(this,e.startPosition,i?s.from:e.totalLength,h),s={from:e.startPosition,to:e.startPosition},i||(t=this._retrievedChildrenRanges.length),this._retrievedChildrenRanges.splice(t,0,s)}else h+=l-s.from;for(;s.to<e.endPosition;){const i=s.to-l;h+=i,o+=i,l=s.to;const r=this._retrievedChildrenRanges[t+1];let a=r?r.from:e.totalLength;for(a>e.endPosition&&(a=e.endPosition);l<a;)n.call(this,d[o++],h++),++l;r&&a===r.from?(s.to=r.to,this.removeChildByIndex(h),this._retrievedChildrenRanges.splice(t+1,1)):(s.to=a,a===e.totalLength?this.removeChildByIndex(h):this.allChildren()[h].setStartPosition(e.endPosition))}}else{e.startPosition>0&&(this._retrievedChildrenRanges.push({from:0,to:0}),a.call(this,0,e.startPosition,h++)),this._retrievedChildrenRanges.push({from:e.startPosition,to:e.endPosition});for(let e=0,t=d.length;e<t;++e)n.call(this,d[e],h++);e.endPosition<e.totalLength&&a.call(this,e.endPosition,e.totalLength,h++)}this._instanceCount+=d.length,s<t?r.call(this,t):(this.expanded&&this._dataGrid.updateVisibleNodes(!0),i(),this.dispatchEventToListeners(Gt.Events.PopulateComplete))}r.call(this,t)}))}_saveChildren(){this._savedChildren.clear();const e=this.allChildren();for(let t=0,i=e.length;t<i;++t){const i=e[t];i.expanded&&this._savedChildren.set(i._getHash(),i)}}async sort(){this._dataGrid.recursiveSortingEnter(),await this._provider().sortAndRewind(this.comparator()),this._saveChildren(),this._dataGrid.removeAllChildren(this),this._retrievedChildrenRanges=[];const e=this._instanceCount;this._instanceCount=0,await this._populateChildren(0,e);for(const e of this.allChildren())e.expanded&&e.sort();this._dataGrid.recursiveSortingLeave()}}Gt.Events={PopulateComplete:Symbol("PopulateComplete")};class At extends Gt{constructor(e,t){if(super(e,!1),!t)return;this._referenceName=null,this._name=t.name,this._type=t.type,this._distance=t.distance,this._shallowSize=t.selfSize,this._retainedSize=t.retainedSize,this.snapshotNodeId=t.id,this.snapshotNodeIndex=t.nodeIndex,"string"===this._type?this._reachableFromWindow=!0:"object"===this._type&&this._name.startsWith("Window")?(this._name=this.shortenWindowURL(this._name,!1),this._reachableFromWindow=!0):t.canBeQueried&&(this._reachableFromWindow=!0),t.detachedDOMTreeNode&&(this.detachedDOMTreeNode=!0);const i=e.snapshot,s=this._shallowSize/i.totalSize*100,r=this._retainedSize/i.totalSize*100;this.data={distance:this._toUIDistance(this._distance),shallowSize:Number.withThousandsSeparator(this._shallowSize),retainedSize:Number.withThousandsSeparator(this._retainedSize),"shallowSize-percent":this._toPercentString(s),"retainedSize-percent":this._toPercentString(r)}}get name(){return this._name}retainersDataSource(){return void 0===this.snapshotNodeIndex?null:{snapshot:this._dataGrid.snapshot,snapshotNodeIndex:this.snapshotNodeIndex}}createCell(e){return"object"!==e?this._createValueCell(e):this._createObjectCell()}_createObjectCell(){let e=this._name,t="object";switch(this._type){case"concatenated string":case"string":e=`"${e}"`,t="string";break;case"regexp":e=`/${e}/`,t="string";break;case"closure":e+="()",t="function";break;case"bigint":t="bigint";break;case"number":t="number";break;case"hidden":t="null";break;case"array":e=e?e+"[]":Vt(Bt.internalArray)}return this._createObjectCellWithValue(t,e||"")}_createObjectCellWithValue(e,t){const i=P.Fragment.build`
        <td class="object-column disclosure">
          <div class="source-code event-properties" style="overflow: visible" $="container">
            <span class="value object-value-${e}">${t}</span>
            <span class="object-value-id">@${this.snapshotNodeId}</span>
          </div>
        </td>`,s=i.$("container");this._prefixObjectCell(s),this._reachableFromWindow&&s.appendChild(P.html`<span class="heap-object-tag" title="${Vt(Bt.userObjectReachableFromWindow)}">🗖</span>`),this.detachedDOMTreeNode&&s.appendChild(P.html`<span class="heap-object-tag" title="${Vt(Bt.detachedFromDomTree)}">✀</span>`),this._appendSourceLocation(s);const r=i.element();return this.depth&&r.style.setProperty("padding-left",this.depth*this.dataGrid.indentWidth+"px"),r}_prefixObjectCell(e){}async _appendSourceLocation(e){const t=P.html`<span class="heap-object-source-link" />`;e.appendChild(t);const i=await this._dataGrid.dataDisplayDelegate().linkifyObject(this.snapshotNodeIndex);i?(t.appendChild(i),this.linkElement=i):t.remove()}async queryObjectContent(e,t){return await this.tryQueryObjectContent(e,t)||e.runtimeModel().createRemoteObjectFromPrimitiveValue(Vt(Bt.previewIsNotAvailable))}async tryQueryObjectContent(e,t){return"string"===this._type?e.runtimeModel().createRemoteObjectFromPrimitiveValue(this._name):await e.objectForSnapshotObjectId(String(this.snapshotNodeId),t)}async updateHasChildren(){const e=await this._provider().isEmpty();this.setHasChildren(!e)}shortenWindowURL(e,t){const i=e.indexOf("/"),r=t?e.indexOf("@"):e.length;if(-1===i||-1===r)return e;const o=e.substring(i+1,r).trimLeft();let n=s.trimURL(o);return n.length>40&&(n=s.trimMiddle(n,40)),e.substr(0,i+2)+n+e.substr(r)}populateContextMenu(e,t,i){if(e.revealSection().appendItem(Vt(Bt.revealInSummaryView),(()=>{t.showObject(String(this.snapshotNodeId),Vt(Bt.summary))})),this._referenceName)for(const i of this._referenceName.matchAll(/\((?<objectName>[^@)]*) @(?<snapshotNodeId>\d+)\)/g)){const{objectName:s,snapshotNodeId:r}=i.groups;e.revealSection().appendItem(Vt(Bt.revealObjectSWithIdSInSummary,{PH1:s,PH2:r}),(()=>{t.showObject(r,Vt(Bt.summary))}))}i&&e.revealSection().appendItem(Vt(Bt.storeAsGlobalVariable),(async()=>{const e=await this.tryQueryObjectContent(i,"");e?await te.ConsoleModel.instance().saveToTempVariable(S.Context.instance().flavor(Y.ExecutionContext),e):O.Console.instance().error(Vt(Bt.previewIsNotAvailable))}))}}class Wt extends At{constructor(e,t,i,s){super(e,i.node),this._referenceName=i.name,this._referenceType=i.type,this._edgeIndex=i.edgeIndex,this._snapshot=t,this._parentObjectNode=s,this._cycledWithAncestorGridNode=this._findAncestorWithSameSnapshotNodeId(),this._cycledWithAncestorGridNode||this.updateHasChildren();const r=this.data;r.count="",r.addedCount="",r.removedCount="",r.countDelta="",r.addedSize="",r.removedSize="",r.sizeDelta=""}retainersDataSource(){return void 0===this.snapshotNodeIndex?null:{snapshot:this._snapshot,snapshotNodeIndex:this.snapshotNodeIndex}}createProvider(){if(void 0===this.snapshotNodeIndex)throw new Error("Cannot create a provider on a root node");return this._snapshot.createEdgesProvider(this.snapshotNodeIndex)}_findAncestorWithSameSnapshotNodeId(){let e=this._parentObjectNode;for(;e;){if(e.snapshotNodeId===this.snapshotNodeId)return e;e=e._parentObjectNode}return null}_createChildNode(e){return new Wt(this._dataGrid,this._snapshot,e,this)}_getHash(){return this._edgeIndex}comparator(){const e=this._dataGrid.isSortOrderAscending();switch(this._dataGrid.sortColumnId()){case"object":return new le.ComparatorConfig("!edgeName",e,"retainedSize",!1);case"count":return new le.ComparatorConfig("!edgeName",!0,"retainedSize",!1);case"shallowSize":return new le.ComparatorConfig("selfSize",e,"!edgeName",!0);case"retainedSize":return new le.ComparatorConfig("retainedSize",e,"!edgeName",!0);case"distance":return new le.ComparatorConfig("distance",e,"_name",!0);default:return new le.ComparatorConfig("!edgeName",!0,"retainedSize",!1)}}_prefixObjectCell(e){let t=this._referenceName||"(empty)",i="name";switch(this._referenceType){case"context":i="object-value-number";break;case"internal":case"hidden":case"weak":i="object-value-null";break;case"element":t=`[${t}]`}this._cycledWithAncestorGridNode&&e.classList.add("cycled-ancessor-node"),e.prepend(P.html`<span class="property-name ${i}">${t}</span>
                        <span class="grayed">${this._edgeNodeSeparator()}</span>`)}_edgeNodeSeparator(){return"::"}}class Ut extends Wt{constructor(e,t,i,s){super(e,t,i,s)}createProvider(){if(void 0===this.snapshotNodeIndex)throw new Error("Cannot create providers on root nodes");return this._snapshot.createRetainingEdgesProvider(this.snapshotNodeIndex)}_createChildNode(e){return new Ut(this._dataGrid,this._snapshot,e,this)}_edgeNodeSeparator(){return Vt(Bt.inElement)}expand(){this._expandRetainersChain(20)}_expandRetainersChain(e){if(!this._populated)return this.once(Gt.Events.PopulateComplete).then((()=>this._expandRetainersChain(e))),void this.populate();if(super.expand(),--e>0&&this.children.length>0){const t=this.children[0];if((t._distance||0)>1)return void t._expandRetainersChain(e)}this._dataGrid.dispatchEventToListeners(ai.ExpandRetainersComplete)}}class Jt extends At{constructor(e,t,i,s){super(e,i),this._baseSnapshotOrSnapshot=t,this._isDeletedNode=s,this.updateHasChildren();const r=this.data;r.count="",r.countDelta="",r.sizeDelta="",this._isDeletedNode?(r.addedCount="",r.addedSize="",r.removedCount="•",r.removedSize=Number.withThousandsSeparator(this._shallowSize||0)):(r.addedCount="•",r.addedSize=Number.withThousandsSeparator(this._shallowSize||0),r.removedCount="",r.removedSize="")}retainersDataSource(){return void 0===this.snapshotNodeIndex?null:{snapshot:this._baseSnapshotOrSnapshot,snapshotNodeIndex:this.snapshotNodeIndex}}createProvider(){if(void 0===this.snapshotNodeIndex)throw new Error("Cannot create providers on root nodes");return this._baseSnapshotOrSnapshot.createEdgesProvider(this.snapshotNodeIndex)}_createChildNode(e){return new Wt(this._dataGrid,this._baseSnapshotOrSnapshot,e,null)}_getHash(){if(void 0===this.snapshotNodeId)throw new Error("Cannot hash root nodes");return this.snapshotNodeId}comparator(){const e=this._dataGrid.isSortOrderAscending();switch(this._dataGrid.sortColumnId()){case"object":return new le.ComparatorConfig("!edgeName",e,"retainedSize",!1);case"distance":return new le.ComparatorConfig("distance",e,"retainedSize",!1);case"count":return new le.ComparatorConfig("!edgeName",!0,"retainedSize",!1);case"addedSize":case"removedSize":case"shallowSize":return new le.ComparatorConfig("selfSize",e,"!edgeName",!0);case"retainedSize":return new le.ComparatorConfig("retainedSize",e,"!edgeName",!0);default:return new le.ComparatorConfig("!edgeName",!0,"retainedSize",!1)}}}class qt extends Gt{constructor(e,t,i,s){super(e,i.count>0),this._name=t,this._nodeFilter=s,this._distance=i.distance,this._count=i.count,this._shallowSize=i.self,this._retainedSize=i.maxRet;const r=e.snapshot,o=this._retainedSize/r.totalSize*100,n=this._shallowSize/r.totalSize*100;this.data={object:t,count:Number.withThousandsSeparator(this._count),distance:this._toUIDistance(this._distance),shallowSize:Number.withThousandsSeparator(this._shallowSize),retainedSize:Number.withThousandsSeparator(this._retainedSize),"shallowSize-percent":this._toPercentString(n),"retainedSize-percent":this._toPercentString(o)}}get name(){return this._name}createProvider(){return this._dataGrid.snapshot.createNodesProviderForClass(this._name,this._nodeFilter)}async populateNodeBySnapshotObjectId(e){this._dataGrid.resetNameFilter(),await this.expandWithoutPopulate();const t=await this._provider().nodePosition(e);if(-1===t)return this.collapse(),[];await this._populateChildren(t,null);const i=this.childForPosition(t);return i?[this,i]:[]}filteredOut(e){return-1===this._name.toLowerCase().indexOf(e)}createCell(e){const t="object"===e?super.createCell(e):this._createValueCell(e);return"object"===e&&this._count>1&&t.appendChild(P.html`<span class="objects-count">×${this._count}</span>`),t}_createChildNode(e){return new Jt(this._dataGrid,this._dataGrid.snapshot,e,!1)}comparator(){const e=this._dataGrid.isSortOrderAscending(),t=this._dataGrid.sortColumnId();switch(t){case"object":return new le.ComparatorConfig("name",e,"id",!0);case"distance":return new le.ComparatorConfig("distance",e,"retainedSize",!1);case"shallowSize":return new le.ComparatorConfig("selfSize",e,"id",!0);case"retainedSize":return new le.ComparatorConfig("retainedSize",e,"id",!0);default:throw new Error("Invalid sort column id "+t)}}}class $t{constructor(e,t,i,s){this._addedNodesProvider=e,this._deletedNodesProvider=t,this._addedCount=i,this._removedCount=s}dispose(){this._addedNodesProvider.dispose(),this._deletedNodesProvider.dispose()}nodePosition(e){throw new Error("Unreachable")}isEmpty(){return Promise.resolve(!1)}async serializeItemsRange(e,t){let i,s;if(e<this._addedCount){i=await this._addedNodesProvider.serializeItemsRange(e,t);for(const e of i.items)e.isAddedNotRemoved=!0;if(i.endPosition>=t)return i.totalLength=this._addedCount+this._removedCount,i;s=i,i=await this._deletedNodesProvider.serializeItemsRange(0,t-i.endPosition)}else s=new le.ItemsRange(0,0,0,[]),i=await this._deletedNodesProvider.serializeItemsRange(e-this._addedCount,t-this._addedCount);s.items.length||(s.startPosition=this._addedCount+i.startPosition);for(const e of i.items)e.isAddedNotRemoved=!1;return s.items.push(...i.items),s.endPosition=this._addedCount+i.endPosition,s.totalLength=this._addedCount+this._removedCount,s}async sortAndRewind(e){await this._addedNodesProvider.sortAndRewind(e),await this._deletedNodesProvider.sortAndRewind(e)}}class Qt extends Gt{constructor(e,t,i){super(e,!0),this._name=t,this._addedCount=i.addedCount,this._removedCount=i.removedCount,this._countDelta=i.countDelta,this._addedSize=i.addedSize,this._removedSize=i.removedSize,this._sizeDelta=i.sizeDelta,this._deletedIndexes=i.deletedIndexes,this.data={object:t,addedCount:Number.withThousandsSeparator(this._addedCount),removedCount:Number.withThousandsSeparator(this._removedCount),countDelta:this._signForDelta(this._countDelta)+Number.withThousandsSeparator(Math.abs(this._countDelta)),addedSize:Number.withThousandsSeparator(this._addedSize),removedSize:Number.withThousandsSeparator(this._removedSize),sizeDelta:this._signForDelta(this._sizeDelta)+Number.withThousandsSeparator(Math.abs(this._sizeDelta))}}get name(){return this._name}createProvider(){const e=this._dataGrid;if(null===e.snapshot||void 0===e.baseSnapshot||void 0===e.baseSnapshot.uid)throw new Error("Data sources have not been set correctly");const t=e.snapshot.createAddedNodesProvider(e.baseSnapshot.uid,this._name),i=e.baseSnapshot.createDeletedNodesProvider(this._deletedIndexes);if(!t||!i)throw new Error("Failed to create node providers");return new $t(t,i,this._addedCount,this._removedCount)}createCell(e){const t=super.createCell(e);return"object"!==e&&t.classList.add("numeric-column"),t}_createChildNode(e){const t=this._dataGrid;if(e.isAddedNotRemoved){if(null===t.snapshot)throw new Error("Data sources have not been set correctly");return new Jt(this._dataGrid,t.snapshot,e,!1)}if(void 0===t.baseSnapshot)throw new Error("Data sources have not been set correctly");return new Jt(this._dataGrid,t.baseSnapshot,e,!0)}comparator(){const e=this._dataGrid.isSortOrderAscending(),t=this._dataGrid.sortColumnId();switch(t){case"object":return new le.ComparatorConfig("name",e,"id",!0);case"addedCount":case"removedCount":case"countDelta":return new le.ComparatorConfig("name",!0,"id",!0);case"addedSize":case"removedSize":case"sizeDelta":return new le.ComparatorConfig("selfSize",e,"id",!0);default:throw new Error("Invalid sort column "+t)}}filteredOut(e){return-1===this._name.toLowerCase().indexOf(e)}_signForDelta(e){return 0===e?"":e>0?"+":"−"}}class Kt extends Gt{constructor(e,t){super(e,t.hasChildren),this._populated=!1,this._allocationNode=t,this.data={liveCount:Number.withThousandsSeparator(t.liveCount),count:Number.withThousandsSeparator(t.count),liveSize:Number.withThousandsSeparator(t.liveSize),size:Number.withThousandsSeparator(t.size),name:t.name}}populate(){this._populated||this._doPopulate()}async _doPopulate(){this._populated=!0;const e=await this._dataGrid.snapshot.allocationNodeCallers(this._allocationNode.id),t=e.nodesWithSingleCaller;let i=this;const s=this._dataGrid;for(const e of t){const t=new Kt(s,e);s.appendNode(i,t),i=t,i._populated=!0,this.expanded&&i.expand()}const r=e.branchingCallers;r.sort(this._dataGrid.createComparator());for(const e of r)s.appendNode(i,new Kt(s,e));s.updateVisibleNodes(!0)}expand(){super.expand(),1===this.children.length&&this.children[0].expand()}createCell(e){if("name"!==e)return this._createValueCell(e);const t=super.createCell(e),i=this._allocationNode,s=this._dataGrid.heapProfilerModel();if(i.scriptId){const e=this._dataGrid.linkifier.linkifyScriptLocation(s?s.target():null,String(i.scriptId),i.scriptName,i.line-1,{columnNumber:i.column-1,className:"profile-node-file",tabStop:void 0});e.style.maxWidth="75%",t.insertBefore(e,t.firstChild)}return t}allocationNodeId(){return this._allocationNode.id}}var Xt=Object.freeze({__proto__:null,UIStrings:Bt,HeapSnapshotGridNode:Gt,HeapSnapshotGenericObjectNode:At,HeapSnapshotObjectNode:Wt,HeapSnapshotRetainingObjectNode:Ut,HeapSnapshotInstanceNode:Jt,HeapSnapshotConstructorNode:qt,HeapSnapshotDiffNodesProvider:$t,HeapSnapshotDiffNode:Qt,AllocationGridNode:Kt});const Yt={distanceFromWindowObject:"Distance from window object",sizeOfTheObjectItselfInBytes:"Size of the object itself in bytes",sizeOfTheObjectPlusTheGraphIt:"Size of the object plus the graph it retains in bytes",object:"Object",distance:"Distance",shallowSize:"Shallow Size",retainedSize:"Retained Size",heapSnapshotRetainment:"Heap Snapshot Retainment",constructorString:"Constructor",heapSnapshotConstructors:"Heap Snapshot Constructors",New:"# New",Deleted:"# Deleted",Delta:"# Delta",allocSize:"Alloc. Size",freedSize:"Freed Size",sizeDelta:"Size Delta",heapSnapshotDiff:"Heap Snapshot Diff",liveCount:"Live Count",count:"Count",liveSize:"Live Size",size:"Size",function:"Function",allocation:"Allocation"},Zt=a.registerUIStrings("profiler/HeapSnapshotDataGrids.js",Yt),ei=a.getLocalizedString.bind(void 0,Zt),ti=new WeakMap;class ii extends r.DataGridImpl{constructor(e,t,i){super(i),this.snapshot=null,this.selectedNode=null,this._heapProfilerModel=e,this._dataDisplayDelegate=t;const s=[["distance",ei(Yt.distanceFromWindowObject)],["shallowSize",ei(Yt.sizeOfTheObjectItselfInBytes)],["retainedSize",ei(Yt.sizeOfTheObjectPlusTheGraphIt)]];for(const e of s){const t=this.headerTableHeader(e[0]);t&&t.setAttribute("title",e[1])}this._recursiveSortingDepth=0,this._highlightedNode=null,this._populatedAndSorted=!1,this._nameFilter=null,this._nodeFilter=new le.NodeFilter,this.addEventListener(si.SortingComplete,this._sortingComplete,this),this.addEventListener(r.Events.SortingChanged,this.sortingChanged,this),this.setRowContextMenuCallback(this._populateContextMenu.bind(this))}async setDataSource(e,t){}_isFilteredOut(e){const t=this._nameFilter?this._nameFilter.value().toLowerCase():"";return!!(t&&(e instanceof Qt||e instanceof qt)&&e.filteredOut(t))}heapProfilerModel(){return this._heapProfilerModel}dataDisplayDelegate(){return this._dataDisplayDelegate}nodeFilter(){return this._nodeFilter}setNameFilter(e){this._nameFilter=e}defaultPopulateCount(){return 100}_disposeAllNodes(){const e=this.topLevelNodes();for(let t=0,i=e.length;t<i;++t)e[t].dispose()}wasShown(){this._nameFilter&&(this._nameFilter.addEventListener(v.ToolbarInput.Event.TextChanged,this._onNameFilterChanged,this),this.updateVisibleNodes(!0)),this._populatedAndSorted&&this.dispatchEventToListeners(si.ContentShown,this)}_sortingComplete(){this.removeEventListener(si.SortingComplete,this._sortingComplete,this),this._populatedAndSorted=!0,this.dispatchEventToListeners(si.ContentShown,this)}willHide(){this._nameFilter&&this._nameFilter.removeEventListener(v.ToolbarInput.Event.TextChanged,this._onNameFilterChanged,this),this._clearCurrentHighlight()}_populateContextMenu(e,t){const i=t;i.populateContextMenu(e,this._dataDisplayDelegate,this.heapProfilerModel()),i instanceof At&&i.linkElement&&!e.containsTarget(i.linkElement)&&e.appendApplicableItems(i.linkElement)}resetSortingCache(){delete this._lastSortColumnId,delete this._lastSortAscending}topLevelNodes(){return this.rootNode().children}revealObjectByHeapSnapshotId(e){return Promise.resolve(null)}highlightNode(e){this._clearCurrentHighlight(),this._highlightedNode=e,l.runCSSAnimationOnce(this._highlightedNode.element(),"highlighted-row")}_clearCurrentHighlight(){this._highlightedNode&&(this._highlightedNode.element().classList.remove("highlighted-row"),this._highlightedNode=null)}resetNameFilter(){this._nameFilter&&this._nameFilter.setValue("")}_onNameFilterChanged(){this.updateVisibleNodes(!0),this._deselectFilteredNodes()}_deselectFilteredNodes(){let e=this.selectedNode;for(;e;){if(this.selectedNode&&this._isFilteredOut(e))return this.selectedNode.deselect(),void(this.selectedNode=null);e=e.parent}}_sortFields(e,t){throw new Error("Not implemented")}sortingChanged(){const e=this.isSortOrderAscending(),t=this.sortColumnId();if(this._lastSortColumnId===t&&this._lastSortAscending===e)return;this._lastSortColumnId=t,this._lastSortAscending=e;const i=this._sortFields(t||"",e);this._performSorting((function(e,t){let s=e[i.fieldName1],r=t[i.fieldName1],o=s<r?-1:s>r?1:0;return i.ascending1||(o=-o),0!==o||(s=e[i.fieldName2],r=t[i.fieldName2],o=s<r?-1:s>r?1:0,i.ascending2||(o=-o)),o}))}_performSorting(e){this.recursiveSortingEnter();const t=this.allChildren(this.rootNode());this.rootNode().removeChildren(),t.sort(e);for(let e=0,i=t.length;e<i;++e){const i=t[e];this.appendChildAfterSorting(i),i.expanded&&i.sort()}this.recursiveSortingLeave()}appendChildAfterSorting(e){const t=e.revealed;this.rootNode().appendChild(e),e.revealed=t}recursiveSortingEnter(){++this._recursiveSortingDepth}recursiveSortingLeave(){this._recursiveSortingDepth&&(--this._recursiveSortingDepth||(this.updateVisibleNodes(!0),this.dispatchEventToListeners(si.SortingComplete)))}updateVisibleNodes(e){}allChildren(e){return e.children}insertChild(e,t,i){e.insertChild(t,i)}removeChildByIndex(e,t){e.removeChild(e.children[t])}removeAllChildren(e){e.removeChildren()}}const si={ContentShown:Symbol("ContentShown"),SortingComplete:Symbol("SortingComplete")};class ri extends ii{constructor(e,t,i){super(e,t,i),this.scrollContainer.addEventListener("scroll",this._onScroll.bind(this),!0),this._topPaddingHeight=0,this._bottomPaddingHeight=0,this.selectedNode=null}topLevelNodes(){return this.allChildren(this.rootNode())}appendChildAfterSorting(e){}updateVisibleNodes(e){const t=this.scrollContainer.scrollHeight;let i=this.scrollContainer.scrollTop,s=t-i-this.scrollContainer.offsetHeight;i=Math.max(0,i-40),s=Math.max(0,s-40);let r=t-i-s;if(!e&&i>=this._topPaddingHeight&&s>=this._bottomPaddingHeight)return;i-=500,r+=1e3;const o=this.selectedNode;this.rootNode().removeChildren(),this._topPaddingHeight=0,this._bottomPaddingHeight=0,this._addVisibleNodes(this.rootNode(),i,i+r),this.setVerticalPadding(this._topPaddingHeight,this._bottomPaddingHeight),o&&(o.parent?o.select(!0):this.selectedNode=o)}_addVisibleNodes(e,t,i){if(!e.expanded)return 0;const s=this.allChildren(e);let r=0,o=0;for(;o<s.length;++o){const e=s[o];if(this._isFilteredOut(e))continue;const i=r+this._nodeHeight(e);if(i>t)break;r=i}let n=r;for(;o<s.length&&n<i;++o){const r=s[o];if(this._isFilteredOut(r))continue;const a=r.hasChildren();r.removeChildren(),r.setHasChildren(a),e.appendChild(r),n+=r.nodeSelfHeight(),n+=this._addVisibleNodes(r,t-n,i-n)}let a=0;for(;o<s.length;++o){const e=s[o];this._isFilteredOut(e)||(a+=this._nodeHeight(e))}return this._topPaddingHeight+=r,this._bottomPaddingHeight+=a,n+a}_nodeHeight(e){let t=e.nodeSelfHeight();if(!e.expanded)return t;const i=this.allChildren(e);for(let e=0;e<i.length;e++)t+=this._nodeHeight(i[e]);return t}revealTreeNode(e){const t=this._calculateOffset(e),i=e[e.length-1],s=this.scrollContainer.scrollTop,r=s+this.scrollContainer.offsetHeight;if(t>=s&&t<r)return Promise.resolve(i);return this.scrollContainer.scrollTop=Math.max(0,t-40),new Promise((e=>{console.assert(!this._scrollToResolveCallback),this._scrollToResolveCallback=e.bind(null,i),this.scrollContainer.window().requestAnimationFrame((()=>{this._scrollToResolveCallback&&(this._scrollToResolveCallback(),this._scrollToResolveCallback=null)}))}))}_calculateOffset(e){let t=this.rootNode(),i=0;if(0===e.length)return 0;for(let s=0;s<e.length;++s){const r=e[s],o=this.allChildren(t);for(let e=0;e<o.length;++e){const t=o[e];if(r===t){i+=r.nodeSelfHeight();break}i+=this._nodeHeight(t)}t=r}return i-e[e.length-1].nodeSelfHeight()}allChildren(e){const t=ti.get(e)||[];return ti.has(e)||ti.set(e,t),t}appendNode(e,t){this.allChildren(e).push(t)}insertChild(e,t,i){this.allChildren(e).splice(i,0,t)}removeChildByIndex(e,t){this.allChildren(e).splice(t,1)}removeAllChildren(e){ti.delete(e)}removeTopLevelNodes(){this._disposeAllNodes(),this.rootNode().removeChildren(),this.removeAllChildren(this.rootNode())}_isScrolledIntoView(e){const t=this.scrollContainer.scrollTop,i=t+this.scrollContainer.clientHeight,s=e.offsetTop;return s+e.offsetHeight<=i&&s>=t}onResize(){super.onResize(),this.updateVisibleNodes(!1)}_onScroll(e){this.updateVisibleNodes(!1),this._scrollToResolveCallback&&(this._scrollToResolveCallback(),this._scrollToResolveCallback=null)}}class oi extends ii{constructor(e,t,i,s){super(e,t,{displayName:i,columns:s=s||[{id:"object",title:ei(Yt.object),disclosure:!0,sortable:!0},{id:"distance",title:ei(Yt.distance),width:"70px",sortable:!0,fixedWidth:!0},{id:"shallowSize",title:ei(Yt.shallowSize),width:"110px",sortable:!0,fixedWidth:!0},{id:"retainedSize",title:ei(Yt.retainedSize),width:"110px",sortable:!0,fixedWidth:!0,sort:r.Order.Descending}]})}async setDataSource(e,t){this.snapshot=e;const i=new le.Node(-1,"root",0,t||e.rootNodeIndex,0,0,"");this.setRootNode(this._createRootNode(e,i)),this.rootNode().sort()}_createRootNode(e,t){const i=new le.Edge("",t,"",-1);return new Wt(this,e,i,null)}sortingChanged(){const e=this.rootNode();e.hasChildren()&&e.sort()}}class ni extends oi{constructor(e,t){const i=[{id:"object",title:ei(Yt.object),disclosure:!0,sortable:!0},{id:"distance",title:ei(Yt.distance),width:"70px",sortable:!0,fixedWidth:!0,sort:r.Order.Ascending},{id:"shallowSize",title:ei(Yt.shallowSize),width:"110px",sortable:!0,fixedWidth:!0},{id:"retainedSize",title:ei(Yt.retainedSize),width:"110px",sortable:!0,fixedWidth:!0}];super(e,t,ei(Yt.heapSnapshotRetainment),i)}_createRootNode(e,t){const i=new le.Edge("",t,"",-1);return new Ut(this,e,i,null)}_sortFields(e,t){switch(e){case"object":return new le.ComparatorConfig("_name",t,"_count",!1);case"count":return new le.ComparatorConfig("_count",t,"_name",!0);case"shallowSize":return new le.ComparatorConfig("_shallowSize",t,"_name",!0);case"retainedSize":return new le.ComparatorConfig("_retainedSize",t,"_name",!0);case"distance":return new le.ComparatorConfig("_distance",t,"_name",!0);default:throw new Error("Unknown column "+e)}}reset(){this.rootNode().removeChildren(),this.resetSortingCache()}async setDataSource(e,t){await super.setDataSource(e,t),this.rootNode().expand()}}const ai={ExpandRetainersComplete:Symbol("ExpandRetainersComplete")};class li extends ri{constructor(e,t){const i=[{id:"object",title:ei(Yt.constructorString),disclosure:!0,sortable:!0},{id:"distance",title:ei(Yt.distance),width:"70px",sortable:!0,fixedWidth:!0},{id:"shallowSize",title:ei(Yt.shallowSize),width:"110px",sortable:!0,fixedWidth:!0},{id:"retainedSize",title:ei(Yt.retainedSize),width:"110px",sort:r.Order.Descending,sortable:!0,fixedWidth:!0}];super(e,t,{displayName:ei(Yt.heapSnapshotConstructors).toString(),columns:i}),this._profileIndex=-1,this._objectIdToSelect=null,this._nextRequestedFilter=null}_sortFields(e,t){switch(e){case"object":return new le.ComparatorConfig("_name",t,"_retainedSize",!1);case"distance":return new le.ComparatorConfig("_distance",t,"_retainedSize",!1);case"shallowSize":return new le.ComparatorConfig("_shallowSize",t,"_name",!0);case"retainedSize":return new le.ComparatorConfig("_retainedSize",t,"_name",!0);default:throw new Error("Unknown column "+e)}}async revealObjectByHeapSnapshotId(e){if(!this.snapshot)return this._objectIdToSelect=e,null;const t=await this.snapshot.nodeClassName(parseInt(e,10));if(!t)return null;const i=this.topLevelNodes().find((e=>e.name===t));if(!i)return null;const s=await i.populateNodeBySnapshotObjectId(parseInt(e,10));return s.length?this.revealTreeNode(s):null}clear(){this._nextRequestedFilter=null,this._lastFilter=null,this.removeTopLevelNodes()}async setDataSource(e,t){this.snapshot=e,-1===this._profileIndex&&this._populateChildren(),this._objectIdToSelect&&(this.revealObjectByHeapSnapshotId(this._objectIdToSelect),this._objectIdToSelect=null)}setSelectionRange(e,t){this._nodeFilter=new le.NodeFilter(e,t),this._populateChildren(this._nodeFilter)}setAllocationNodeId(e){this._nodeFilter=new le.NodeFilter,this._nodeFilter.allocationNodeId=e,this._populateChildren(this._nodeFilter)}_aggregatesReceived(e,t){this._filterInProgress=null,this._nextRequestedFilter&&this.snapshot&&(this.snapshot.aggregatesWithFilter(this._nextRequestedFilter).then(this._aggregatesReceived.bind(this,this._nextRequestedFilter)),this._filterInProgress=this._nextRequestedFilter,this._nextRequestedFilter=null),this.removeTopLevelNodes(),this.resetSortingCache();for(const i in t)this.appendNode(this.rootNode(),new qt(this,i,t[i],e));this.sortingChanged(),this._lastFilter=e}async _populateChildren(e){const t=e||new le.NodeFilter;if(this._filterInProgress)this._nextRequestedFilter=this._filterInProgress.equals(t)?null:t;else if((!this._lastFilter||!this._lastFilter.equals(t))&&(this._filterInProgress=t,this.snapshot)){const e=await this.snapshot.aggregatesWithFilter(t);this._aggregatesReceived(t,e)}}filterSelectIndexChanged(e,t){if(this._profileIndex=t,this._nodeFilter=void 0,-1!==t){const i=t>0?e[t-1].maxJSObjectId:0,s=e[t].maxJSObjectId;this._nodeFilter=new le.NodeFilter(i,s)}this._populateChildren(this._nodeFilter)}}class di extends ri{constructor(e,t){const i=[{id:"object",title:ei(Yt.constructorString),disclosure:!0,sortable:!0},{id:"addedCount",title:ei(Yt.New),width:"75px",sortable:!0,fixedWidth:!0},{id:"removedCount",title:ei(Yt.Deleted),width:"75px",sortable:!0,fixedWidth:!0},{id:"countDelta",title:ei(Yt.Delta),width:"65px",sortable:!0,fixedWidth:!0},{id:"addedSize",title:ei(Yt.allocSize),width:"75px",sortable:!0,fixedWidth:!0,sort:r.Order.Descending},{id:"removedSize",title:ei(Yt.freedSize),width:"75px",sortable:!0,fixedWidth:!0},{id:"sizeDelta",title:ei(Yt.sizeDelta),width:"75px",sortable:!0,fixedWidth:!0}];super(e,t,{displayName:ei(Yt.heapSnapshotDiff).toString(),columns:i})}defaultPopulateCount(){return 50}_sortFields(e,t){switch(e){case"object":return new le.ComparatorConfig("_name",t,"_count",!1);case"addedCount":return new le.ComparatorConfig("_addedCount",t,"_name",!0);case"removedCount":return new le.ComparatorConfig("_removedCount",t,"_name",!0);case"countDelta":return new le.ComparatorConfig("_countDelta",t,"_name",!0);case"addedSize":return new le.ComparatorConfig("_addedSize",t,"_name",!0);case"removedSize":return new le.ComparatorConfig("_removedSize",t,"_name",!0);case"sizeDelta":return new le.ComparatorConfig("_sizeDelta",t,"_name",!0);default:throw new Error("Unknown column "+e)}}async setDataSource(e,t){this.snapshot=e}setBaseDataSource(e){this.baseSnapshot=e,this.removeTopLevelNodes(),this.resetSortingCache(),this.baseSnapshot!==this.snapshot?this._populateChildren():this.dispatchEventToListeners(si.SortingComplete)}async _populateChildren(){if(null===this.snapshot||void 0===this.baseSnapshot||void 0===this.baseSnapshot.uid)throw new Error("Data sources have not been set correctly");const e=await this.baseSnapshot.aggregatesForDiff(),t=await this.snapshot.calculateSnapshotDiff(this.baseSnapshot.uid,e);for(const e in t){const i=t[e];this.appendNode(this.rootNode(),new Qt(this,e,i))}this.sortingChanged()}}class hi extends ri{constructor(e,t){const i=[{id:"liveCount",title:ei(Yt.liveCount),width:"75px",sortable:!0,fixedWidth:!0},{id:"count",title:ei(Yt.count),width:"65px",sortable:!0,fixedWidth:!0},{id:"liveSize",title:ei(Yt.liveSize),width:"75px",sortable:!0,fixedWidth:!0},{id:"size",title:ei(Yt.size),width:"75px",sortable:!0,fixedWidth:!0,sort:r.Order.Descending},{id:"name",title:ei(Yt.function),disclosure:!0,sortable:!0}];super(e,t,{displayName:ei(Yt.allocation).toString(),columns:i}),this._linkifier=new q.Linkifier}get linkifier(){return this._linkifier}dispose(){this._linkifier.reset()}async setDataSource(e,t){this.snapshot=e,this._topNodes=await this.snapshot.allocationTracesTops(),this._populateChildren()}_populateChildren(){this.removeTopLevelNodes();const e=this.rootNode(),t=this._topNodes||[];for(const i of t)this.appendNode(e,new Kt(this,i));this.updateVisibleNodes(!0)}sortingChanged(){void 0!==this._topNodes&&(this._topNodes.sort(this.createComparator()),this.rootNode().removeChildren(),this._populateChildren())}createComparator(){const e=this.sortColumnId(),t=this.sortOrder()===r.Order.Ascending?1:-1;return function(i,s){return i[e]>s[e]?t:i[e]<s[e]?-t:0}}}var ci=Object.freeze({__proto__:null,UIStrings:Yt,HeapSnapshotSortableDataGrid:ii,HeapSnapshotSortableDataGridEvents:si,HeapSnapshotViewportDataGrid:ri,HeapSnapshotContainmentDataGrid:oi,HeapSnapshotRetainmentDataGrid:ni,HeapSnapshotRetainmentDataGridEvents:ai,HeapSnapshotConstructorsDataGrid:li,HeapSnapshotDiffDataGrid:di,AllocationDataGrid:hi});const pi={anErrorOccurredWhenACallToMethod:"An error occurred when a call to method '{PH1}' was requested"},ui=a.registerUIStrings("profiler/HeapSnapshotProxy.js",pi),_i=a.getLocalizedString.bind(void 0,ui);class mi extends F.ObjectWrapper{constructor(e){super(),this._eventHandler=e,this._nextObjectId=1,this._nextCallId=1,this._callbacks=new Map,this._previousCallbacks=new Set,this._worker=z.WorkerWrapper.fromURL(new URL("../heap_snapshot_worker/heap_snapshot_worker-legacy.js",import.meta.url)),this._worker.onmessage=this._messageReceived.bind(this)}createLoader(e,t){const i=this._nextObjectId++,s=new gi(this,i,e,t);return this._postMessage({callId:this._nextCallId++,disposition:"create",objectId:i,methodName:"HeapSnapshotWorker.HeapSnapshotLoader"}),s}dispose(){this._worker.terminate(),this._interval&&clearInterval(this._interval)}disposeObject(e){this._postMessage({callId:this._nextCallId++,disposition:"dispose",objectId:e})}evaluateForTest(e,t){const i=this._nextCallId++;this._callbacks.set(i,t),this._postMessage({callId:i,disposition:"evaluateForTest",source:e})}callFactoryMethod(e,t,i,s){const r=this._nextCallId++,o=Array.prototype.slice.call(arguments,4),n=this._nextObjectId++;return e?(this._callbacks.set(r,(t=>{e(t?new s(this,n):null)})),this._postMessage({callId:r,disposition:"factory",objectId:t,methodName:i,methodArguments:o,newObjectId:n}),null):(this._postMessage({callId:r,disposition:"factory",objectId:t,methodName:i,methodArguments:o,newObjectId:n}),new s(this,n))}callMethod(e,t,i){const s=this._nextCallId++,r=Array.prototype.slice.call(arguments,3);e&&this._callbacks.set(s,e),this._postMessage({callId:s,disposition:"method",objectId:t,methodName:i,methodArguments:r})}startCheckingForLongRunningCalls(){this._interval||(this._checkLongRunningCalls(),this._interval=setInterval(this._checkLongRunningCalls.bind(this),300))}_checkLongRunningCalls(){for(const e of this._previousCallbacks)this._callbacks.has(e)||this._previousCallbacks.delete(e);const e=Boolean(this._previousCallbacks.size);this.dispatchEventToListeners(mi.Events.Wait,e);for(const e of this._callbacks.keys())this._previousCallbacks.add(e)}_messageReceived(e){const t=e.data;if(t.eventName)return void(this._eventHandler&&this._eventHandler(t.eventName,t.data));if(t.error)return t.errorMethodName&&O.Console.instance().error(_i(pi.anErrorOccurredWhenACallToMethod,{PH1:t.errorMethodName})),O.Console.instance().error(t.errorCallStack),void this._callbacks.delete(t.callId);const i=this._callbacks.get(t.callId);i&&(this._callbacks.delete(t.callId),i(t.result))}_postMessage(e){this._worker.postMessage(e)}}mi.Events={Wait:Symbol("Wait")};class fi{constructor(e,t){this._worker=e,this._objectId=t}_callWorker(e,t){t.splice(1,0,this._objectId);const i=this._worker[e];if(!i)throw new Error(`Could not find worker with name ${e}.`);return i.apply(this._worker,t)}dispose(){this._worker.disposeObject(this._objectId)}disposeWorker(){this._worker.dispose()}callFactoryMethod(e,t,i,...s){return this._callWorker("callFactoryMethod",Array.prototype.slice.call(arguments,0))}_callMethodPromise(e,...t){const i=Array.prototype.slice.call(arguments);return new Promise((e=>this._callWorker("callMethod",[e,...i])))}}class gi extends fi{constructor(e,t,i,s){super(e,t),this._profileUid=i,this._snapshotReceivedCallback=s}async write(e){await this._callMethodPromise("write",e)}async close(){await this._callMethodPromise("close");const e=await new Promise((e=>this.callFactoryMethod(e,"buildSnapshot",vi)));this.dispose(),e.setProfileUid(this._profileUid),await e.updateStaticData(),this._snapshotReceivedCallback(e)}}class vi extends fi{constructor(e,t){super(e,t),this._staticData=null}search(e,t){return this._callMethodPromise("search",e,t)}aggregatesWithFilter(e){return this._callMethodPromise("aggregatesWithFilter",e)}aggregatesForDiff(){return this._callMethodPromise("aggregatesForDiff")}calculateSnapshotDiff(e,t){return this._callMethodPromise("calculateSnapshotDiff",e,t)}nodeClassName(e){return this._callMethodPromise("nodeClassName",e)}createEdgesProvider(e){return this.callFactoryMethod(null,"createEdgesProvider",Si,e)}createRetainingEdgesProvider(e){return this.callFactoryMethod(null,"createRetainingEdgesProvider",Si,e)}createAddedNodesProvider(e,t){return this.callFactoryMethod(null,"createAddedNodesProvider",Si,e,t)}createDeletedNodesProvider(e){return this.callFactoryMethod(null,"createDeletedNodesProvider",Si,e)}createNodesProvider(e){return this.callFactoryMethod(null,"createNodesProvider",Si,e)}createNodesProviderForClass(e,t){return this.callFactoryMethod(null,"createNodesProviderForClass",Si,e,t)}allocationTracesTops(){return this._callMethodPromise("allocationTracesTops")}allocationNodeCallers(e){return this._callMethodPromise("allocationNodeCallers",e)}allocationStack(e){return this._callMethodPromise("allocationStack",e)}dispose(){throw new Error("Should never be called")}get nodeCount(){return this._staticData?this._staticData.nodeCount:0}get rootNodeIndex(){return this._staticData?this._staticData.rootNodeIndex:0}async updateStaticData(){this._staticData=await this._callMethodPromise("updateStaticData")}getStatistics(){return this._callMethodPromise("getStatistics")}getLocation(e){return this._callMethodPromise("getLocation",e)}getSamples(){return this._callMethodPromise("getSamples")}get totalSize(){return this._staticData?this._staticData.totalSize:0}get uid(){return this._profileUid}setProfileUid(e){this._profileUid=e}maxJSObjectId(){return this._staticData?this._staticData.maxJSObjectId:0}}class Si extends fi{constructor(e,t){super(e,t)}nodePosition(e){return this._callMethodPromise("nodePosition",e)}isEmpty(){return this._callMethodPromise("isEmpty")}serializeItemsRange(e,t){return this._callMethodPromise("serializeItemsRange",e,t)}async sortAndRewind(e){await this._callMethodPromise("sortAndRewind",e)}}var wi=Object.freeze({__proto__:null,UIStrings:pi,HeapSnapshotWorkerProxy:mi,HeapSnapshotProxyObject:fi,HeapSnapshotLoaderProxy:gi,HeapSnapshotProxy:vi,HeapSnapshotProviderProxy:Si});const bi={find:"Find",containment:"Containment",retainers:"Retainers",allocationStack:"Allocation stack",perspective:"Perspective",baseSnapshot:"Base snapshot",filter:"Filter",classFilter:"Class filter",code:"Code",strings:"Strings",jsArrays:"JS arrays",typedArrays:"Typed arrays",systemObjects:"System objects",selectedSizeS:"Selected size: {PH1}",allObjects:"All objects",objectsAllocatedBeforeS:"Objects allocated before {PH1}",objectsAllocatedBetweenSAndS:"Objects allocated between {PH1} and {PH2}",summary:"Summary",comparison:"Comparison",allocation:"Allocation",liveObjects:"Live objects",statistics:"Statistics",heapSnapshot:"Heap snapshot",takeHeapSnapshot:"Take heap snapshot",heapSnapshots:"HEAP SNAPSHOTS",heapSnapshotProfilesShowMemory:"Heap snapshot profiles show memory distribution among your page's JavaScript objects and related DOM nodes.",treatGlobalObjectsAsRoots:"Treat global objects as roots (recommended, unchecking this exposes internal nodes and introduces excessive detail, but might help debugging cycles in retaining paths)",snapshotting:"Snapshotting…",snapshotD:"Snapshot {PH1}",percentagePlaceholder:"{PH1}%",allocationInstrumentationOn:"Allocation instrumentation on timeline",stopRecordingHeapProfile:"Stop recording heap profile",startRecordingHeapProfile:"Start recording heap profile",recordAllocationStacksExtra:"Record allocation stacks (extra performance overhead)",recording:"Recording…",allocationTimelines:"ALLOCATION TIMELINES",AllocationTimelinesShow:"\n        Allocation timelines show instrumented JavaScript memory allocations over time.\n        Once profile is recorded you can select a time interval to see objects that\n        were allocated within it and still alive by the end of recording.\n        Use this profile type to isolate memory leaks.",loading:"Loading…",savingD:"Saving… {PH1}%",sKb:"{PH1} kB",heapMemoryUsage:"Heap memory usage",stackWasNotRecordedForThisObject:"Stack was not recorded for this object because it had been allocated before this profile recording started."},Ci=a.registerUIStrings("profiler/HeapSnapshotView.js",bi),Pi=a.getLocalizedString.bind(void 0,Ci),Ti=a.registerUIStrings("profiler/ModuleUIStrings.js",{buildingEdgeIndexes:"Building edge indexes…",buildingRetainers:"Building retainers…",propagatingDomState:"Propagating DOM state…",calculatingNodeFlags:"Calculating node flags…",calculatingDistances:"Calculating distances…",buildingPostorderIndex:"Building postorder index…",buildingDominatorTree:"Building dominator tree…",calculatingRetainedSizes:"Calculating retained sizes…",buildingDominatedNodes:"Building dominated nodes…",calculatingStatistics:"Calculating statistics…",calculatingSamples:"Calculating samples…",buildingLocations:"Building locations…",finishedProcessing:"Finished processing.",buildingAllocationStatistics:"Building allocation statistics…",done:"Done",processingSnapshot:"Processing snapshot…",parsingStrings:"Parsing strings…",loadingSnapshotInfo:"Loading snapshot info…",loadingNodesD:"Loading nodes… {PH1}%",loadingEdgesD:"Loading edges… {PH1}%",loadingAllocationTracesD:"Loading allocation traces… {PH1}%",loadingSamples:"Loading samples…",loadingLocations:"Loading locations…",loadingStrings:"Loading strings…"}),yi=a.getLocalizedString.bind(void 0,Ti);class xi extends f.SimpleView{constructor(e,t){super(Pi(bi.heapSnapshot)),this._searchResults=[],this.element.classList.add("heap-snapshot-view"),this._profile=t,this._linkifier=new q.Linkifier;const i=t.profileType();i.addEventListener(Li.SnapshotReceived,this._onReceiveSnapshot,this),i.addEventListener(De.RemoveProfileHeader,this._onProfileHeaderRemoved,this);const s=i.id===Hi.TypeId;s&&this._createOverview(),this._parentDataDisplayDelegate=e,this._searchableView=new g.SearchableView(this,null),this._searchableView.setPlaceholder(Pi(bi.find),Pi(bi.find)),this._searchableView.show(this.element),this._splitWidget=new T.SplitWidget(!1,!0,"heapSnapshotSplitViewState",200,200),this._splitWidget.show(this._searchableView.element);const o=t.heapProfilerModel();let n;if(this._containmentDataGrid=new oi(o,this,Pi(bi.containment)),this._containmentDataGrid.addEventListener(r.Events.SelectedNode,this._selectionChanged,this),this._containmentWidget=this._containmentDataGrid.asWidget(),this._containmentWidget.setMinimumSize(50,25),this._statisticsView=new Mi,this._constructorsDataGrid=new li(o,this),this._constructorsDataGrid.addEventListener(r.Events.SelectedNode,this._selectionChanged,this),this._constructorsWidget=this._constructorsDataGrid.asWidget(),this._constructorsWidget.setMinimumSize(50,25),this._diffDataGrid=new di(o,this),this._diffDataGrid.addEventListener(r.Events.SelectedNode,this._selectionChanged,this),this._diffWidget=this._diffDataGrid.asWidget(),this._diffWidget.setMinimumSize(50,25),this._allocationDataGrid=null,s&&(this._allocationDataGrid=new hi(o,this),this._allocationDataGrid.addEventListener(r.Events.SelectedNode,this._onSelectAllocationNode,this),this._allocationWidget=this._allocationDataGrid.asWidget(),this._allocationWidget.setMinimumSize(50,25),this._allocationStackView=new Oi(o),this._allocationStackView.setMinimumSize(50,25),this._tabbedPane=new y.TabbedPane),this._retainmentDataGrid=new ni(o,this),this._retainmentWidget=this._retainmentDataGrid.asWidget(),this._retainmentWidget.setMinimumSize(50,21),this._retainmentWidget.element.classList.add("retaining-paths-view"),this._allocationStackView)this._tabbedPane=new y.TabbedPane,this._tabbedPane.appendTab("retainers",Pi(bi.retainers),this._retainmentWidget),this._tabbedPane.appendTab("allocation-stack",Pi(bi.allocationStack),this._allocationStackView),n=this._tabbedPane.headerElement(),this._objectDetailsView=this._tabbedPane;else{const e=document.createElement("div");e.classList.add("heap-snapshot-view-resizer");e.createChild("div","title").createChild("span").textContent=Pi(bi.retainers),n=e,this._objectDetailsView=new c.VBox,this._objectDetailsView.element.appendChild(e),this._retainmentWidget.show(this._objectDetailsView.element)}this._splitWidget.hideDefaultResizer(),this._splitWidget.installResizer(n),this._retainmentDataGrid.addEventListener(r.Events.SelectedNode,this._inspectedObjectChanged,this),this._retainmentDataGrid.reset(),this._perspectives=[],this._comparisonPerspective=new Ni,this._perspectives.push(new Ii),t.profileType()!==Vi.trackingHeapSnapshotProfileType&&this._perspectives.push(this._comparisonPerspective),this._perspectives.push(new Ri),this._allocationWidget&&this._perspectives.push(new Di),this._perspectives.push(new Fi),this._perspectiveSelect=new v.ToolbarComboBox(this._onSelectedPerspectiveChanged.bind(this),Pi(bi.perspective)),this._updatePerspectiveOptions(),this._baseSelect=new v.ToolbarComboBox(this._changeBase.bind(this),Pi(bi.baseSnapshot)),this._baseSelect.setVisible(!1),this._updateBaseOptions(),this._filterSelect=new v.ToolbarComboBox(this._changeFilter.bind(this),Pi(bi.filter)),this._filterSelect.setVisible(!1),this._updateFilterOptions(),this._classNameFilter=new v.ToolbarInput(Pi(bi.classFilter)),this._classNameFilter.setVisible(!1),this._constructorsDataGrid.setNameFilter(this._classNameFilter),this._diffDataGrid.setNameFilter(this._classNameFilter),this._selectedSizeText=new v.ToolbarText,this._popoverHelper=new x.PopoverHelper(this.element,this._getPopoverRequest.bind(this)),this._popoverHelper.setDisableOnClick(!0),this._popoverHelper.setHasPadding(!0),this.element.addEventListener("scroll",this._popoverHelper.hidePopover.bind(this._popoverHelper),!0),this._currentPerspectiveIndex=0,this._currentPerspective=this._perspectives[0],this._currentPerspective.activate(this),this._dataGrid=this._currentPerspective.masterGrid(this),this._populate(),this._searchThrottler=new B.Throttler(0);for(const e of this._profiles())e.addEventListener(Ne.ProfileTitleChanged,this._updateControls,this);this._baseProfile}_createOverview(){const e=this._profile.profileType();this._trackingOverviewGrid=new St,this._trackingOverviewGrid.addEventListener(wt,this._onIdsRangeChanged.bind(this)),this._profile.fromFile()||e.profileBeingRecorded()!==this._profile||(e.addEventListener(Hi.HeapStatsUpdate,this._onHeapStatsUpdate,this),e.addEventListener(Hi.TrackingStopped,this._onStopTracking,this),this._trackingOverviewGrid.start())}_onStopTracking(){this._profile.profileType().removeEventListener(Hi.HeapStatsUpdate,this._onHeapStatsUpdate,this),this._profile.profileType().removeEventListener(Hi.TrackingStopped,this._onStopTracking,this),this._trackingOverviewGrid&&this._trackingOverviewGrid.stop()}_onHeapStatsUpdate(e){e.data&&this._trackingOverviewGrid&&this._trackingOverviewGrid.setSamples(e.data)}searchableView(){return this._searchableView}showProfile(e){return this._parentDataDisplayDelegate.showProfile(e)}showObject(e,t){Number(e)<=this._profile.maxJSObjectId?this.selectLiveObject(t,e):this._parentDataDisplayDelegate.showObject(e,t)}async linkifyObject(e){const t=this._profile.heapProfilerModel();if(!t)return null;const i=await this._profile.getLocation(e);if(!i)return null;const s=t.runtimeModel().debuggerModel().createRawLocationByScriptId(String(i.scriptId),i.lineNumber,i.columnNumber);if(!s)return null;const r=s.script(),o=r&&r.sourceURL;return o&&this._linkifier?this._linkifier.linkifyRawLocation(s,o):null}async _populate(){const e=await this._profile._loadPromise;if(this._retrieveStatistics(e),this._dataGrid&&this._dataGrid.setDataSource(e,0),this._profile.profileType().id===Hi.TypeId&&this._profile.fromFile()){const t=await e.getSamples();if(t){console.assert(Boolean(t.timestamps.length));const e=new Ct;e.sizes=t.sizes,e.ids=t.lastAssignedIds,e.timestamps=t.timestamps,e.max=t.sizes,e.totalTime=Math.max(t.timestamps[t.timestamps.length-1]||0,1e4),this._trackingOverviewGrid&&this._trackingOverviewGrid.setSamples(e)}}const t=this._profiles().indexOf(this._profile);this._baseSelect.setSelectedIndex(Math.max(0,t-1)),this._trackingOverviewGrid&&this._trackingOverviewGrid.updateGrid()}async _retrieveStatistics(e){const t=await e.getStatistics(),i=[{value:t.code,color:"#f77",title:Pi(bi.code)},{value:t.strings,color:"#5e5",title:Pi(bi.strings)},{value:t.jsArrays,color:"#7af",title:Pi(bi.jsArrays)},{value:t.native,color:"#fc5",title:Pi(bi.typedArrays)},{value:t.system,color:"#98f",title:Pi(bi.systemObjects)}];return this._statisticsView.setTotalAndRecords(t.total,i),t}_onIdsRangeChanged(e){const i=e.data.minId,s=e.data.maxId;this._selectedSizeText.setText(Pi(bi.selectedSizeS,{PH1:t.bytesToString(e.data.size)})),this._constructorsDataGrid.snapshot&&this._constructorsDataGrid.setSelectionRange(i,s)}async toolbarItems(){const e=[this._perspectiveSelect,this._classNameFilter];return this._profile.profileType()!==Vi.trackingHeapSnapshotProfileType&&e.push(this._baseSelect,this._filterSelect),e.push(this._selectedSizeText),e}willHide(){this._currentSearchResultIndex=-1,this._popoverHelper.hidePopover()}supportsCaseSensitiveSearch(){return!0}supportsRegexSearch(){return!1}searchCanceled(){this._currentSearchResultIndex=-1,this._searchResults=[]}_selectRevealedNode(e){e&&e.select()}performSearch(e,t,i){const s=new le.SearchConfig(e.query.trim(),e.caseSensitive,e.isRegex,t,i||!1);this._searchThrottler.schedule(this._performSearch.bind(this,s))}async _performSearch(e){if(this.searchCanceled(),!this._currentPerspective.supportsSearch())return;this.currentQuery=e;const t=e.query.trim();if(!t)return;if("@"===t.charAt(0)){const e=parseInt(t.substring(1),10);if(isNaN(e))return;if(!this._dataGrid)return;const i=await this._dataGrid.revealObjectByHeapSnapshotId(String(e));return void this._selectRevealedNode(i)}if(!this._profile._snapshotProxy||!this._dataGrid)return;const i=this._dataGrid.nodeFilter();this._searchResults=i?await this._profile._snapshotProxy.search(this.currentQuery,i):[],this._searchableView.updateSearchMatchesCount(this._searchResults.length),this._searchResults.length&&(this._currentSearchResultIndex=e.jumpBackward?this._searchResults.length-1:0),await this._jumpToSearchResult(this._currentSearchResultIndex)}jumpToNextSearchResult(){this._searchResults.length&&(this._currentSearchResultIndex=(this._currentSearchResultIndex+1)%this._searchResults.length,this._searchThrottler.schedule(this._jumpToSearchResult.bind(this,this._currentSearchResultIndex)))}jumpToPreviousSearchResult(){this._searchResults.length&&(this._currentSearchResultIndex=(this._currentSearchResultIndex+this._searchResults.length-1)%this._searchResults.length,this._searchThrottler.schedule(this._jumpToSearchResult.bind(this,this._currentSearchResultIndex)))}async _jumpToSearchResult(e){if(this._searchableView.updateCurrentMatchIndex(e),-1===e)return;if(!this._dataGrid)return;const t=await this._dataGrid.revealObjectByHeapSnapshotId(String(this._searchResults[e]));this._selectRevealedNode(t)}refreshVisibleData(){if(!this._dataGrid)return;let e=this._dataGrid.rootNode().children[0];for(;e;)e.refresh(),e=e.traverseNextNode(!1,null,!0)}_changeBase(){if(this._baseProfile===this._profiles()[this._baseSelect.selectedIndex()])return;this._baseProfile=this._profiles()[this._baseSelect.selectedIndex()];const e=this._dataGrid;e.snapshot&&this._baseProfile._loadPromise.then(e.setBaseDataSource.bind(e)),this.currentQuery&&this._searchResults&&this.performSearch(this.currentQuery,!1)}_changeFilter(){const e=this._filterSelect.selectedIndex()-1;this._dataGrid&&(this._dataGrid.filterSelectIndexChanged(this._profiles(),e),this.currentQuery&&this._searchResults&&this.performSearch(this.currentQuery,!1))}_profiles(){return this._profile.profileType().getProfiles()}_selectionChanged(e){const t=e.data;this._setSelectedNodeForDetailsView(t),this._inspectedObjectChanged(e)}_onSelectAllocationNode(e){const t=e.data;this._constructorsDataGrid.setAllocationNodeId(t.allocationNodeId()),this._setSelectedNodeForDetailsView(null)}_inspectedObjectChanged(e){const t=e.data,i=this._profile.heapProfilerModel();i&&t instanceof At&&i.addInspectedHeapObject(String(t.snapshotNodeId))}_setSelectedNodeForDetailsView(e){const t=e&&e.retainersDataSource();t?(this._retainmentDataGrid.setDataSource(t.snapshot,t.snapshotNodeIndex),this._allocationStackView&&this._allocationStackView.setAllocatedObject(t.snapshot,t.snapshotNodeIndex)):(this._allocationStackView&&this._allocationStackView.clear(),this._retainmentDataGrid.reset())}async _changePerspectiveAndWait(e){const t=this._perspectives.findIndex((t=>t.title()===e));if(-1===t||this._currentPerspectiveIndex===t)return;const i=this._perspectives[t].masterGrid(this);if(!i)return;const s=i.once(si.ContentShown),r=this._perspectiveSelect.options().find((e=>e.value===String(t)));return this._perspectiveSelect.select(r),this._changePerspective(t),s}async _updateDataSourceAndView(){const e=this._dataGrid;if(!e||e.snapshot)return;const t=await this._profile._loadPromise;if(this._dataGrid!==e)return;if(e.snapshot!==t&&e.setDataSource(t,0),e!==this._diffDataGrid)return;this._baseProfile||(this._baseProfile=this._profiles()[this._baseSelect.selectedIndex()]);const i=await this._baseProfile._loadPromise;this._diffDataGrid.baseSnapshot!==i&&this._diffDataGrid.setBaseDataSource(i)}_onSelectedPerspectiveChanged(e){this._changePerspective(Number(e.target.selectedOptions[0].value))}_changePerspective(e){if(e===this._currentPerspectiveIndex)return;this._currentPerspectiveIndex=e,this._currentPerspective.deactivate(this);const t=this._perspectives[e];this._currentPerspective=t,this._dataGrid=t.masterGrid(this),t.activate(this),this.refreshVisibleData(),this._dataGrid&&this._dataGrid.updateWidths(),this._updateDataSourceAndView(),this.currentQuery&&this._searchResults&&this.performSearch(this.currentQuery,!1)}async selectLiveObject(e,t){if(await this._changePerspectiveAndWait(e),!this._dataGrid)return;const i=await this._dataGrid.revealObjectByHeapSnapshotId(t);i?i.select():O.Console.instance().error("Cannot find corresponding heap snapshot node")}_getPopoverRequest(e){const t=l.enclosingNodeOrSelfWithNodeName(e.target,"span"),i=l.enclosingNodeOrSelfWithNodeName(e.target,"row");if(!i)return null;if(!this._dataGrid)return null;const s=this._dataGrid.dataGridNodeFromNode(i)||this._containmentDataGrid.dataGridNodeFromNode(i)||this._constructorsDataGrid.dataGridNodeFromNode(i)||this._diffDataGrid.dataGridNodeFromNode(i)||this._allocationDataGrid&&this._allocationDataGrid.dataGridNodeFromNode(i)||this._retainmentDataGrid.dataGridNodeFromNode(i),r=this._profile.heapProfilerModel();if(!s||!t||!r)return null;let o;return{box:t.boxInWindow(),show:async e=>{if(!r)return!1;const t=await s.queryObjectContent(r,"popover");return!!t&&(o=await de.ObjectPopoverHelper.buildObjectPopover(t,e),!!o||(r.runtimeModel().releaseObjectGroup("popover"),!1))},hide:()=>{r.runtimeModel().releaseObjectGroup("popover"),o&&o.dispose()}}}_updatePerspectiveOptions(){const e=this._profiles().length>1;this._perspectiveSelect.removeOptions(),this._perspectives.forEach(((t,i)=>{(e||t!==this._comparisonPerspective)&&this._perspectiveSelect.createOption(t.title(),String(i))}))}_updateBaseOptions(){const e=this._profiles(),t=this._baseSelect.selectedIndex();this._baseSelect.removeOptions();for(const t of e)this._baseSelect.createOption(t.title);t>-1&&this._baseSelect.setSelectedIndex(t)}_updateFilterOptions(){const e=this._profiles(),t=this._filterSelect.selectedIndex();this._filterSelect.removeOptions(),this._filterSelect.createOption(Pi(bi.allObjects));for(let t=0;t<e.length;++t){let i;i=t?Pi(bi.objectsAllocatedBetweenSAndS,{PH1:e[t-1].title,PH2:e[t].title}):Pi(bi.objectsAllocatedBeforeS,{PH1:e[t].title}),this._filterSelect.createOption(i)}t>-1&&this._filterSelect.setSelectedIndex(t)}_updateControls(){this._updatePerspectiveOptions(),this._updateBaseOptions(),this._updateFilterOptions()}_onReceiveSnapshot(e){this._updateControls();e.data.addEventListener(Ne.ProfileTitleChanged,this._updateControls,this)}_onProfileHeaderRemoved(e){const t=e.data;t.removeEventListener(Ne.ProfileTitleChanged,this._updateControls,this),this._profile===t?(this.detach(),this._profile.profileType().removeEventListener(Li.SnapshotReceived,this._onReceiveSnapshot,this),this._profile.profileType().removeEventListener(De.RemoveProfileHeader,this._onProfileHeaderRemoved,this),this.dispose()):this._updateControls()}dispose(){this._linkifier.dispose(),this._popoverHelper.dispose(),this._allocationStackView&&(this._allocationStackView.clear(),this._allocationDataGrid&&this._allocationDataGrid.dispose()),this._onStopTracking(),this._trackingOverviewGrid&&this._trackingOverviewGrid.removeEventListener(wt,this._onIdsRangeChanged.bind(this))}}class Ei{constructor(e){this._title=e}activate(e){}deactivate(e){e._baseSelect.setVisible(!1),e._filterSelect.setVisible(!1),e._classNameFilter.setVisible(!1),e._trackingOverviewGrid&&e._trackingOverviewGrid.detach(),e._allocationWidget&&e._allocationWidget.detach(),e._statisticsView&&e._statisticsView.detach(),e._splitWidget.detach(),e._splitWidget.detachChildWidgets()}masterGrid(e){return null}title(){return this._title}supportsSearch(){return!1}}class Ii extends Ei{constructor(){super(Pi(bi.summary))}activate(e){e._splitWidget.setMainWidget(e._constructorsWidget),e._splitWidget.setSidebarWidget(e._objectDetailsView),e._splitWidget.show(e._searchableView.element),e._filterSelect.setVisible(!0),e._classNameFilter.setVisible(!0),e._trackingOverviewGrid&&(e._trackingOverviewGrid.show(e._searchableView.element,e._splitWidget.element),e._trackingOverviewGrid.update(),e._trackingOverviewGrid.updateGrid())}masterGrid(e){return e._constructorsDataGrid}supportsSearch(){return!0}}class Ni extends Ei{constructor(){super(Pi(bi.comparison))}activate(e){e._splitWidget.setMainWidget(e._diffWidget),e._splitWidget.setSidebarWidget(e._objectDetailsView),e._splitWidget.show(e._searchableView.element),e._baseSelect.setVisible(!0),e._classNameFilter.setVisible(!0)}masterGrid(e){return e._diffDataGrid}supportsSearch(){return!0}}class Ri extends Ei{constructor(){super(Pi(bi.containment))}activate(e){e._splitWidget.setMainWidget(e._containmentWidget),e._splitWidget.setSidebarWidget(e._objectDetailsView),e._splitWidget.show(e._searchableView.element)}masterGrid(e){return e._containmentDataGrid}}class Di extends Ei{constructor(){super(Pi(bi.allocation)),this._allocationSplitWidget=new T.SplitWidget(!1,!0,"heapSnapshotAllocationSplitViewState",200,200),this._allocationSplitWidget.setSidebarWidget(new c.VBox)}activate(e){e._allocationWidget&&this._allocationSplitWidget.setMainWidget(e._allocationWidget),e._splitWidget.setMainWidget(e._constructorsWidget),e._splitWidget.setSidebarWidget(e._objectDetailsView);const t=new c.VBox,i=document.createElement("div");i.classList.add("heap-snapshot-view-resizer");if(i.createChild("div","title").createChild("span").textContent=Pi(bi.liveObjects),this._allocationSplitWidget.hideDefaultResizer(),this._allocationSplitWidget.installResizer(i),t.element.appendChild(i),e._splitWidget.show(t.element),this._allocationSplitWidget.setSidebarWidget(t),this._allocationSplitWidget.show(e._searchableView.element),e._constructorsDataGrid.clear(),e._allocationDataGrid){const t=e._allocationDataGrid.selectedNode;t&&e._constructorsDataGrid.setAllocationNodeId(t.allocationNodeId())}}deactivate(e){this._allocationSplitWidget.detach(),super.deactivate(e)}masterGrid(e){return e._allocationDataGrid}}class Fi extends Ei{constructor(){super(Pi(bi.statistics))}activate(e){e._statisticsView.show(e._searchableView.element)}masterGrid(e){return null}}class Li extends Re{constructor(e,t){super(e||Li.TypeId,t||Pi(bi.heapSnapshot)),$.TargetManager.instance().observeModels(Z.HeapProfilerModel,this),$.TargetManager.instance().addModelListener(Z.HeapProfilerModel,Z.Events.ResetProfiles,this._resetProfiles,this),$.TargetManager.instance().addModelListener(Z.HeapProfilerModel,Z.Events.AddHeapSnapshotChunk,this._addHeapSnapshotChunk,this),$.TargetManager.instance().addModelListener(Z.HeapProfilerModel,Z.Events.ReportHeapSnapshotProgress,this._reportHeapSnapshotProgress,this),this._treatGlobalObjectsAsRoots=L.Settings.instance().createSetting("treatGlobalObjectsAsRoots",!0),this._customContent=null}modelAdded(e){e.enable()}modelRemoved(e){}getProfiles(){return super.getProfiles()}fileExtension(){return".heapsnapshot"}get buttonTooltip(){return Pi(bi.takeHeapSnapshot)}isInstantProfile(){return!0}buttonClicked(){return this._takeHeapSnapshot(),V.actionTaken(G.Action.ProfilesHeapProfileTaken),!1}get treeItemTitle(){return Pi(bi.heapSnapshots)}get description(){return Pi(bi.heapSnapshotProfilesShowMemory)}customContent(){const e=E.createSettingCheckbox(Pi(bi.treatGlobalObjectsAsRoots),this._treatGlobalObjectsAsRoots,!0);this._customContent=e;return ae.experiments.isEnabled("showOptionToNotTreatGlobalObjectsAsRoots")?e:null}setCustomContentEnabled(e){this._customContent&&(this._customContent.checkboxElement.disabled=!e)}createProfileLoadedFromFile(e){return new ki(null,this,e)}async _takeHeapSnapshot(){if(this.profileBeingRecorded())return;const e=S.Context.instance().flavor(Z.HeapProfilerModel);if(!e)return;let t=new ki(e,this);this.setProfileBeingRecorded(t),this.addProfile(t),t.updateStatus(Pi(bi.snapshotting)),await e.takeHeapSnapshot(!0,this._treatGlobalObjectsAsRoots.get()),t=this.profileBeingRecorded(),t.title=Pi(bi.snapshotD,{PH1:t.uid}),t._finishLoad(),this.setProfileBeingRecorded(null),this.dispatchEventToListeners(De.ProfileComplete,t)}_addHeapSnapshotChunk(e){const t=this.profileBeingRecorded();if(!t)return;const i=e.data;t.transferChunk(i)}_reportHeapSnapshotProgress(e){const t=this.profileBeingRecorded();if(!t)return;const i=e.data;t.updateStatus(Pi(bi.percentagePlaceholder,{PH1:(i.done/i.total*100).toFixed(0)}),!0),i.finished&&t._prepareToLoad()}_resetProfiles(e){const t=e.data;for(const e of this.getProfiles())e.heapProfilerModel()===t&&this.removeProfile(e)}_snapshotReceived(e){this.profileBeingRecorded()===e&&this.setProfileBeingRecorded(null),this.dispatchEventToListeners(Li.SnapshotReceived,e)}}Li.TypeId="HEAP",Li.SnapshotReceived="SnapshotReceived";class Hi extends Li{constructor(){super(Hi.TypeId,Pi(bi.allocationInstrumentationOn)),this._recordAllocationStacksSetting=L.Settings.instance().createSetting("recordAllocationStacks",!1),this._customContent=null,this._recording=!1}modelAdded(e){super.modelAdded(e),e.addEventListener(Z.Events.HeapStatsUpdate,this._heapStatsUpdate,this),e.addEventListener(Z.Events.LastSeenObjectId,this._lastSeenObjectId,this)}modelRemoved(e){super.modelRemoved(e),e.removeEventListener(Z.Events.HeapStatsUpdate,this._heapStatsUpdate,this),e.removeEventListener(Z.Events.LastSeenObjectId,this._lastSeenObjectId,this)}_heapStatsUpdate(e){if(!this._profileSamples)return;const t=e.data;let i;for(let e=0;e<t.length;e+=3){i=t[e];const s=t[e+2];this._profileSamples.sizes[i]=s,this._profileSamples.max[i]||(this._profileSamples.max[i]=s)}}_lastSeenObjectId(e){const t=this._profileSamples;if(!t)return;const i=e.data,s=Math.max(t.ids.length,t.max.length-1);t.ids[s]=i.lastSeenObjectId,t.max[s]||(t.max[s]=0,t.sizes[s]=0),t.timestamps[s]=i.timestamp,t.totalTime<i.timestamp-t.timestamps[0]&&(t.totalTime*=2),this.dispatchEventToListeners(Hi.HeapStatsUpdate,this._profileSamples);const r=this.profileBeingRecorded();r&&r.updateStatus(null,!0)}hasTemporaryView(){return!0}get buttonTooltip(){return this._recording?Pi(bi.stopRecordingHeapProfile):Pi(bi.startRecordingHeapProfile)}isInstantProfile(){return!1}buttonClicked(){return this._toggleRecording()}_startRecordingProfile(){if(this.profileBeingRecorded())return;const e=this._addNewProfile();e&&e.startTrackingHeapObjects(this._recordAllocationStacksSetting.get())}customContent(){const e=E.createSettingCheckbox(Pi(bi.recordAllocationStacksExtra),this._recordAllocationStacksSetting,!0);return this._customContent=e,e}setCustomContentEnabled(e){this._customContent&&(this._customContent.checkboxElement.disabled=!e)}_addNewProfile(){const e=S.Context.instance().flavor(Z.HeapProfilerModel);return e?(this.setProfileBeingRecorded(new ki(e,this,void 0)),this._profileSamples=new Ct,this.profileBeingRecorded()._profileSamples=this._profileSamples,this._recording=!0,this.addProfile(this.profileBeingRecorded()),this.profileBeingRecorded().updateStatus(Pi(bi.recording)),this.dispatchEventToListeners(Hi.TrackingStarted),e):null}async _stopRecordingProfile(){let e=this.profileBeingRecorded();e.updateStatus(Pi(bi.snapshotting));const t=e.heapProfilerModel().stopTrackingHeapObjects(!0);this._recording=!1,this.dispatchEventToListeners(Hi.TrackingStopped),await t,e=this.profileBeingRecorded(),e&&(e._finishLoad(),this._profileSamples=null,this.setProfileBeingRecorded(null),this.dispatchEventToListeners(De.ProfileComplete,e))}_toggleRecording(){return this._recording?this._stopRecordingProfile():this._startRecordingProfile(),this._recording}fileExtension(){return".heaptimeline"}get treeItemTitle(){return Pi(bi.allocationTimelines)}get description(){return Pi(bi.AllocationTimelinesShow)}_resetProfiles(e){const t=this._recording;this.setProfileBeingRecorded(null),super._resetProfiles(e),this._profileSamples=null,t&&this._addNewProfile()}profileBeingRecordedRemoved(){this._stopRecordingProfile(),this._profileSamples=null}}Hi.TypeId="HEAP-RECORD",Hi.HeapStatsUpdate="HeapStatsUpdate",Hi.TrackingStarted="TrackingStarted",Hi.TrackingStopped="TrackingStopped";class ki extends Ee{constructor(e,t,i){super(t,i||Pi(bi.snapshotD,{PH1:t.nextProfileUid()})),this._heapProfilerModel=e,this.maxJSObjectId=-1,this._workerProxy=null,this._receiver=null,this._snapshotProxy=null,this._loadPromise=new Promise((e=>{this._fulfillLoad=e})),this._totalNumberOfChunks=0,this._bufferedWriter=null,this._onTempFileReady=null}heapProfilerModel(){return this._heapProfilerModel}async getLocation(e){return this._snapshotProxy?this._snapshotProxy.getLocation(e):null}createSidebarTreeElement(e){return new Be(e,this,"heap-snapshot-sidebar-tree-item")}createView(e){return new xi(e,this)}_prepareToLoad(){console.assert(!this._receiver,"Already loading"),this._setupWorker(),this.updateStatus(Pi(bi.loading),!0)}_finishLoad(){!this._wasDisposed&&this._receiver&&this._receiver.close(),this._bufferedWriter&&this._didWriteToTempFile(this._bufferedWriter)}_didWriteToTempFile(e){this._wasDisposed?e&&e.remove():(this.tempFile=e,e||(this._failedToCreateTempFile=!0),this._onTempFileReady&&(this._onTempFileReady(),this._onTempFileReady=null))}_setupWorker(){console.assert(!this._workerProxy,"HeapSnapshotWorkerProxy already exists"),this._workerProxy=new mi(this._handleWorkerEvent.bind(this)),this._workerProxy.addEventListener(mi.Events.Wait,(e=>{this.updateStatus(null,e.data)}),this),this._receiver=this._workerProxy.createLoader(this.uid,this._snapshotReceived.bind(this))}_handleWorkerEvent(e,t){if(le.HeapSnapshotProgressEvent.BrokenSnapshot===e){const e=t;return void O.Console.instance().error(e)}if(le.HeapSnapshotProgressEvent.Update!==e)return;const i=t,s=a.deserializeUIString(i);this.updateStatus(yi(s.messageParts,s.values))}dispose(){this._workerProxy&&this._workerProxy.dispose(),this.removeTempFile(),this._wasDisposed=!0}_didCompleteSnapshotTransfer(){this._snapshotProxy&&this.updateStatus(t.bytesToString(this._snapshotProxy.totalSize),!1)}transferChunk(e){this._bufferedWriter||(this._bufferedWriter=new ne.TempFile),this._bufferedWriter.write([e]),++this._totalNumberOfChunks,this._receiver&&this._receiver.write(e)}_snapshotReceived(e){this._wasDisposed||(this._receiver=null,this._snapshotProxy=e,this.maxJSObjectId=e.maxJSObjectId(),this._didCompleteSnapshotTransfer(),this._workerProxy&&this._workerProxy.startCheckingForLongRunningCalls(),this.notifySnapshotReceived())}notifySnapshotReceived(){this._snapshotProxy&&this._fulfillLoad(this._snapshotProxy),this.profileType()._snapshotReceived(this),this.canSaveToFile()&&this.dispatchEventToListeners(Ne.ProfileReceived)}canSaveToFile(){return!this.fromFile()&&Boolean(this._snapshotProxy)}saveToFile(){const e=new oe.FileOutputStream;this._fileName=this._fileName||"Heap-"+i.toISO8601Compact(new Date)+this.profileType().fileExtension();const t=async i=>{if(i){if(this._failedToCreateTempFile)return O.Console.instance().error("Failed to open temp file with heap snapshot"),void e.close();if(this.tempFile){const t=await this.tempFile.copyToOutputStream(e,this._onChunkTransferred.bind(this));return t&&O.Console.instance().error("Failed to read heap snapshot from temp file: "+t.message),void this._didCompleteSnapshotTransfer()}this._onTempFileReady=()=>{t(i)},this._updateSaveProgress(0,1)}};e.open(this._fileName).then(t.bind(this))}_onChunkTransferred(e){this._updateSaveProgress(e.loadedSize(),e.fileSize())}_updateSaveProgress(e,t){const i=(100*(t&&e/t)).toFixed(0);this.updateStatus(Pi(bi.savingD,{PH1:i}))}async loadFromFile(e){this.updateStatus(Pi(bi.loading),!0),this._setupWorker();const t=new oe.ChunkedFileReader(e,1e7),i=await t.read(this._receiver);if(!i){const e=t.error();e&&this.updateStatus(e.message)}return i?null:t.error()}}class Mi extends c.VBox{constructor(){super(),this.element.classList.add("heap-snapshot-statistics-view"),this._pieChart=new J.PieChart,this.setTotalAndRecords(0,[]),this._pieChart.classList.add("heap-snapshot-stats-pie-chart"),this.element.appendChild(this._pieChart)}static _valueFormatter(e){return Pi(bi.sKb,{PH1:Number.withThousandsSeparator(Math.round(e/1e3))})}setTotalAndRecords(e,t){this._pieChart.data={chartName:Pi(bi.heapMemoryUsage),size:150,formatter:Mi._valueFormatter,showLegend:!0,total:e,slices:t}}}class Oi extends c.Widget{constructor(e){super(),this._heapProfilerModel=e,this._linkifier=new q.Linkifier,this._frameElements=[]}_onContextMenu(e,t){const i=new m.ContextMenu(t);i.containsTarget(e)||i.appendApplicableItems(e),i.show(),t.consume(!0)}_onStackViewKeydown(e){const t=e.target;if(!t)return;if("Enter"===e.key){const i=zi.get(t);if(!i)return;const s=q.Linkifier.linkInfo(i);if(!s)return;return void(q.Linkifier.invokeFirstAction(s)&&e.consume(!0))}let i;const s=e;if("ArrowUp"===s.key)i=!1;else{if("ArrowDown"!==s.key)return;i=!0}const r=this._frameElements.indexOf(t);if(-1===r)return;const o=i?r+1:r-1;if(o<0||o>=this._frameElements.length)return;const n=this._frameElements[o];n.tabIndex=0,t.tabIndex=-1,n.focus(),e.consume(!0)}async setAllocatedObject(e,t){this.clear();const i=await e.allocationStack(t);if(!i){const e=this.element.createChild("div","no-heap-allocation-stack");return void l.createTextChild(e,Pi(bi.stackWasNotRecordedForThisObject))}const s=this.element.createChild("div","heap-allocation-stack");s.addEventListener("keydown",this._onStackViewKeydown.bind(this),!1);for(const e of i){const t=s.createChild("div","stack-frame");this._frameElements.push(t),t.tabIndex=-1;if(t.createChild("div").textContent=l.beautifyFunctionName(e.functionName),!e.scriptId)continue;const i=this._heapProfilerModel?this._heapProfilerModel.target():null,r={columnNumber:e.column-1},o=this._linkifier.linkifyScriptLocation(i,String(e.scriptId),e.scriptName,e.line-1,r);t.appendChild(o),zi.set(t,o),t.addEventListener("contextmenu",this._onContextMenu.bind(this,o))}this._frameElements[0].tabIndex=0}clear(){this.element.removeChildren(),this._frameElements=[],this._linkifier.reset()}}const zi=new WeakMap;var Bi=Object.freeze({__proto__:null,UIStrings:bi,HeapSnapshotView:xi,Perspective:Ei,SummaryPerspective:Ii,ComparisonPerspective:Ni,ContainmentPerspective:Ri,AllocationPerspective:Di,StatisticsPerspective:Fi,HeapSnapshotProfileType:Li,TrackingHeapSnapshotProfileType:Hi,HeapProfileHeader:ki,HeapSnapshotStatisticsView:Mi,HeapAllocationStackView:Oi});class ji{constructor(){this.cpuProfileType=new it,this.heapSnapshotProfileType=new Li,this.samplingHeapProfileType=new Ft,this.trackingHeapSnapshotProfileType=new Hi}}const Vi=new ji;var Gi=Object.freeze({__proto__:null,ProfileTypeRegistry:ji,instance:Vi});const Ai={clearAllProfiles:"Clear all profiles",cantLoadFileSupportedFile:"Can’t load file. Supported file extensions: '{PH1}.'",cantLoadProfileWhileAnother:"Can’t load profile while another profile is being recorded.",profileLoadingFailedS:"Profile loading failed: {PH1}.",load:"Load…",runD:"Run {PH1}",profiles:"Profiles"},Wi=a.registerUIStrings("profiler/ProfilesPanel.js",Ai),Ui=a.getLocalizedString.bind(void 0,Wi);class Ji extends I.PanelWithSidebar{constructor(e,t,i){super(e),this._profileTypes=t,this.registerRequiredCSS("profiler/heapProfiler.css",{enableLegacyPatching:!0}),this.registerRequiredCSS("profiler/profilesPanel.css",{enableLegacyPatching:!0}),this.registerRequiredCSS("object_ui/objectValue.css",{enableLegacyPatching:!0});const s=new c.VBox;this.splitWidget().setMainWidget(s),this.profilesItemTreeElement=new Ki(this),this._sidebarTree=new p.TreeOutlineInShadow,this._sidebarTree.registerRequiredCSS("profiler/profilesSidebarTree.css",{enableLegacyPatching:!0}),this._sidebarTree.element.classList.add("profiles-sidebar-tree-box"),this.panelSidebarElement().appendChild(this._sidebarTree.element),this._sidebarTree.appendChild(this.profilesItemTreeElement),this._sidebarTree.element.addEventListener("keydown",this._onKeyDown.bind(this),!1),this.profileViews=document.createElement("div"),this.profileViews.id="profile-views",this.profileViews.classList.add("vbox"),s.element.appendChild(this.profileViews),this._toolbarElement=document.createElement("div"),this._toolbarElement.classList.add("profiles-toolbar"),s.element.insertBefore(this._toolbarElement,s.element.firstChild),this.panelSidebarElement().classList.add("profiles-tree-sidebar");const r=document.createElement("div");r.classList.add("profiles-toolbar"),this.panelSidebarElement().insertBefore(r,this.panelSidebarElement().firstChild);const o=new v.Toolbar("",r);this._toggleRecordAction=N.ActionRegistry.instance().action(i),this._toggleRecordButton=v.Toolbar.createActionButton(this._toggleRecordAction),o.appendToolbarItem(this._toggleRecordButton),this.clearResultsButton=new v.ToolbarButton(Ui(Ai.clearAllProfiles),"largeicon-clear"),this.clearResultsButton.addEventListener(v.ToolbarButton.Events.Click,this._reset,this),o.appendToolbarItem(this.clearResultsButton),o.appendSeparator(),o.appendToolbarItem(v.Toolbar.createActionButtonForId("components.collect-garbage")),this._profileViewToolbar=new v.Toolbar("",this._toolbarElement),this._profileGroups={},this._launcherView=new ft(this),this._launcherView.addEventListener(gt.ProfileTypeSelected,this._onProfileTypeSelected,this),this.visibleView,this._profileToView=[],this._typeIdToSidebarSection={};const n=this._profileTypes;for(let e=0;e<n.length;e++)this._registerProfileType(n[e]);this._launcherView.restoreSelectedProfileType(),this.profilesItemTreeElement.select(),this._showLauncherView(),this._fileSelectorElement,this._createFileSelectorElement(),this.element.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!1),$.TargetManager.instance().addEventListener($.Events.SuspendStateChanged,this._onSuspendStateChanged,this),S.Context.instance().addFlavorChangeListener(Q.CPUProfilerModel,this._updateProfileTypeSpecificUI,this),S.Context.instance().addFlavorChangeListener(Z.HeapProfilerModel,this._updateProfileTypeSpecificUI,this)}_onKeyDown(e){const t=e;let i=!1;"ArrowDown"!==t.key||t.altKey?"ArrowUp"!==t.key||t.altKey||(i=this._sidebarTree.selectPrevious()):i=this._sidebarTree.selectNext(),i&&t.consume(!0)}searchableView(){const e=this.visibleView;return e&&e.searchableView?e.searchableView():null}_createFileSelectorElement(){this._fileSelectorElement&&this.element.removeChild(this._fileSelectorElement),this._fileSelectorElement=l.createFileSelectorElement(this._loadFromFile.bind(this)),ze(this._fileSelectorElement),this.element.appendChild(this._fileSelectorElement)}_findProfileTypeByExtension(e){return this._profileTypes.find((t=>Boolean(t.fileExtension())&&e.endsWith(t.fileExtension()||"")))||null}async _loadFromFile(e){this._createFileSelectorElement();const t=this._findProfileTypeByExtension(e.name);if(!t){const e=new Set(this._profileTypes.map((e=>e.fileExtension())).filter((e=>e)));return void O.Console.instance().error(Ui(Ai.cantLoadFileSupportedFile,{PH1:Array.from(e).join("', '")}))}if(Boolean(t.profileBeingRecorded()))return void O.Console.instance().error(Ui(Ai.cantLoadProfileWhileAnother));const i=await t.loadFromFile(e);i&&"message"in i&&l.MessageDialog.show(Ui(Ai.profileLoadingFailedS,{PH1:i.message}))}toggleRecord(){if(!this._toggleRecordAction.enabled())return!0;const e=this.element.ownerDocument.deepActiveElement(),t=this._selectedProfileType;if(!t)return!0;const i=t.buttonClicked();return this._updateToggleRecordAction(i),i?(this._launcherView.profileStarted(),t.hasTemporaryView()&&this.showProfile(t.profileBeingRecorded())):this._launcherView.profileFinished(),e&&e.focus(),!0}_onSuspendStateChanged(){this._updateToggleRecordAction(this._toggleRecordAction.toggled())}_updateToggleRecordAction(e){const t=Boolean(S.Context.instance().flavor(Q.CPUProfilerModel)||S.Context.instance().flavor(Z.HeapProfilerModel)),i=e||!$.TargetManager.instance().allTargetsSuspended()&&t;this._toggleRecordAction.setEnabled(i),this._toggleRecordAction.setToggled(e),i?this._toggleRecordButton.setTitle(this._selectedProfileType?this._selectedProfileType.buttonTooltip:""):this._toggleRecordButton.setTitle(l.anotherProfilerActiveLabel()),this._selectedProfileType&&this._launcherView.updateProfileType(this._selectedProfileType,i)}_profileBeingRecordedRemoved(){this._updateToggleRecordAction(!1),this._launcherView.profileFinished()}_onProfileTypeSelected(e){this._selectedProfileType=e.data,this._updateProfileTypeSpecificUI()}_updateProfileTypeSpecificUI(){this._updateToggleRecordAction(this._toggleRecordAction.toggled())}_reset(){this._profileTypes.forEach((e=>e.reset())),delete this.visibleView,this._profileGroups={},this._updateToggleRecordAction(!1),this._launcherView.profileFinished(),this._sidebarTree.element.classList.remove("some-expandable"),this._launcherView.detach(),this.profileViews.removeChildren(),this._profileViewToolbar.removeToolbarItems(),this.clearResultsButton.element.classList.remove("hidden"),this.profilesItemTreeElement.select(),this._showLauncherView()}_showLauncherView(){this.closeVisibleView(),this._profileViewToolbar.removeToolbarItems(),this._launcherView.show(this.profileViews),this.visibleView=this._launcherView,this._toolbarElement.classList.add("hidden")}_registerProfileType(e){this._launcherView.addProfileType(e);const t=new qi(this,e);this._typeIdToSidebarSection[e.id]=t,this._sidebarTree.appendChild(t),t.childrenListElement.addEventListener("contextmenu",this._handleContextMenuEvent.bind(this),!1),e.addEventListener(De.ViewUpdated,this._updateProfileTypeSpecificUI,this),e.addEventListener(De.AddProfileHeader,(function(e){this._addProfileHeader(e.data)}),this),e.addEventListener(De.RemoveProfileHeader,(function(e){this._removeProfileHeader(e.data)}),this),e.addEventListener(De.ProfileComplete,(function(e){this.showProfile(e.data)}),this);const i=e.getProfiles();for(let e=0;e<i.length;e++)this._addProfileHeader(i[e])}_handleContextMenuEvent(e){const t=new m.ContextMenu(e);this.panelSidebarElement().isSelfOrAncestor(e.target)&&t.defaultSection().appendItem(Ui(Ai.load),this._fileSelectorElement.click.bind(this._fileSelectorElement)),t.show()}showLoadFromFileDialog(){this._fileSelectorElement.click()}_addProfileHeader(e){const t=e.profileType().id;this._typeIdToSidebarSection[t].addProfileHeader(e),this.visibleView&&this.visibleView!==this._launcherView||this.showProfile(e)}_removeProfileHeader(e){e.profileType().profileBeingRecorded()===e&&this._profileBeingRecordedRemoved();const t=this._indexOfViewForProfile(e);-1!==t&&this._profileToView.splice(t,1);const i=e.profileType().id;this._typeIdToSidebarSection[i].removeProfileHeader(e)&&(this.profilesItemTreeElement.select(),this._showLauncherView())}showProfile(e){if(!e||e.profileType().profileBeingRecorded()===e&&!e.profileType().hasTemporaryView())return null;const t=this.viewForProfile(e);if(t===this.visibleView)return t;this.closeVisibleView(),t.show(this.profileViews),this._toolbarElement.classList.remove("hidden"),this.visibleView=t;const i=this._typeIdToSidebarSection[e.profileType().id].sidebarElementForProfile(e);return i&&i.revealAndSelect(),this._profileViewToolbar.removeToolbarItems(),t.toolbarItems().then((e=>{e.map((e=>this._profileViewToolbar.appendToolbarItem(e)))})),t}showObject(e,t){}async linkifyObject(e){return null}viewForProfile(e){const t=this._indexOfViewForProfile(e);if(-1!==t)return this._profileToView[t].view;const i=e.createView(this);return i.element.classList.add("profile-view"),this._profileToView.push({profile:e,view:i}),i}_indexOfViewForProfile(e){return this._profileToView.findIndex((t=>t.profile===e))}closeVisibleView(){this.visibleView&&this.visibleView.detach(),delete this.visibleView}focus(){this._sidebarTree.focus()}}class qi extends p.TreeElement{constructor(e,t){super(t.treeItemTitle,!0),this.selectable=!1,this._dataDisplayDelegate=e,this._profileTreeElements=[],this._profileGroups={},this.expand(),this.hidden=!0,this.setCollapsible(!1)}addProfileHeader(e){this.hidden=!1;const t=e.profileType();let i=this;const s=e.createSidebarTreeElement(this._dataDisplayDelegate);if(this._profileTreeElements.push(s),!e.fromFile()&&t.profileBeingRecorded()!==e){const t=e.title;let r=this._profileGroups[t];r||(r=new $i,this._profileGroups[t]=r),r.profileSidebarTreeElements.push(s);const o=r.profileSidebarTreeElements.length;if(2===o){r.sidebarTreeElement=new Qi(this._dataDisplayDelegate,e.title);const t=r.profileSidebarTreeElements[0],i=this.children().indexOf(t);this.insertChild(r.sidebarTreeElement,i);const s=t.selected;this.removeChild(t),r.sidebarTreeElement.appendChild(t),s&&t.revealAndSelect(),t.setSmall(!0),t.setMainTitle(Ui(Ai.runD,{PH1:1})),this.treeOutline&&this.treeOutline.element.classList.add("some-expandable")}o>=2&&(i=r.sidebarTreeElement,s.setSmall(!0),s.setMainTitle(Ui(Ai.runD,{PH1:o})))}i&&i.appendChild(s)}removeProfileHeader(e){const t=this._sidebarElementIndex(e);if(-1===t)return!1;const i=this._profileTreeElements[t];this._profileTreeElements.splice(t,1);let s=this;const r=this._profileGroups[e.title];if(r){const t=r.profileSidebarTreeElements;if(t.splice(t.indexOf(i),1),1===t.length){const i=s.children().indexOf(r.sidebarTreeElement);r.sidebarTreeElement&&r.sidebarTreeElement.removeChild(t[0]),this.insertChild(t[0],i),t[0].setSmall(!1),t[0].setMainTitle(e.title),r.sidebarTreeElement&&this.removeChild(r.sidebarTreeElement)}0!==t.length&&(s=r.sidebarTreeElement)}return s&&s.removeChild(i),i.dispose(),!this.childCount()&&(this.hidden=!0,!0)}sidebarElementForProfile(e){const t=this._sidebarElementIndex(e);return-1===t?null:this._profileTreeElements[t]}_sidebarElementIndex(e){const t=this._profileTreeElements;for(let i=0;i<t.length;i++)if(t[i].profile===e)return i;return-1}onattach(){this.listItemElement.classList.add("profiles-tree-section")}}class $i{constructor(){this.profileSidebarTreeElements=[],this.sidebarTreeElement=null}}class Qi extends p.TreeElement{constructor(e,t){super("",!0),this.selectable=!1,this._dataDisplayDelegate=e,this._profileTitle=t,this.expand(),this.toggleOnClick=!0}onselect(){const e=this.childCount()>0;if(e){const e=this.lastChild();e instanceof Be&&this._dataDisplayDelegate.showProfile(e.profile)}return e}onattach(){this.listItemElement.classList.add("profile-group-sidebar-tree-item"),this.listItemElement.createChild("div","icon"),this.listItemElement.createChild("div","titles no-subtitle").createChild("span","title-container").createChild("span","title").textContent=this._profileTitle}}class Ki extends p.TreeElement{constructor(e){super("",!1),this.selectable=!0,this._panel=e}onselect(){return this._panel._showLauncherView(),!0}onattach(){this.listItemElement.classList.add("profile-launcher-view-tree-item"),this.listItemElement.createChild("div","icon"),this.listItemElement.createChild("div","titles no-subtitle").createChild("span","title-container").createChild("span","title").textContent=Ui(Ai.profiles)}}let Xi;class Yi extends Ji{constructor(){super("js_profiler",[Vi.cpuProfileType],"profiler.js-toggle-recording")}static instance(e={forceNew:null}){const{forceNew:t}=e;return Xi&&!t||(Xi=new Yi),Xi}wasShown(){S.Context.instance().setFlavor(Yi,this)}willHide(){S.Context.instance().setFlavor(Yi,null)}handleAction(e,t){const i=S.Context.instance().flavor(Yi);if(!(i instanceof Yi))throw new Error("non-null JSProfilerPanel expected!");return i.toggleRecord(),!0}}var Zi=Object.freeze({__proto__:null,UIStrings:Ai,ProfilesPanel:Ji,ProfileTypeSidebarSection:qi,ProfileGroup:$i,ProfileGroupSidebarTreeElement:Qi,ProfilesSidebarTreeElement:Ki,JSProfilerPanel:Yi});const es={revealInSummaryView:"Reveal in Summary view"},ts=a.registerUIStrings("profiler/HeapProfilerPanel.js",es),is=a.getLocalizedString.bind(void 0,ts);let ss;class rs extends Ji{constructor(){const e=Vi;super("heap_profiler",[e.heapSnapshotProfileType,e.trackingHeapSnapshotProfileType,e.samplingHeapProfileType],"profiler.heap-toggle-recording")}static instance(){return ss||(ss=new rs),ss}appendApplicableItems(e,t,i){if(!(i instanceof ie.RemoteObject))return;if(!this.isShowing())return;const s=i;if(!s.objectId)return;const r=s.objectId;if(!Vi.heapSnapshotProfileType.getProfiles().length)return;const o=s.runtimeModel().heapProfilerModel();o&&t.revealSection().appendItem(is(es.revealInSummaryView),function(e){o.snapshotObjectIdForObjectId(r).then((t=>{this.isShowing()&&t&&this.showObject(t,e)}))}.bind(this,"Summary"))}handleAction(e,t){const i=S.Context.instance().flavor(rs);return console.assert(Boolean(i)&&i instanceof rs),i&&i.toggleRecord(),!0}wasShown(){S.Context.instance().setFlavor(rs,this),V.panelLoaded("heap_profiler","DevTools.Launch.HeapProfiler")}willHide(){S.Context.instance().setFlavor(rs,null)}showObject(e,t){const i=Vi.heapSnapshotProfileType.getProfiles();for(let s=0;s<i.length;s++){const r=i[s];if(r.maxJSObjectId>=parseInt(e,10)){this.showProfile(r);this.viewForProfile(r).selectLiveObject(t,e);break}}}}var os=Object.freeze({__proto__:null,UIStrings:es,HeapProfilerPanel:rs});const ns={jsHeap:"JS Heap",allocatedJsHeapSizeCurrentlyIn:"Allocated JS heap size currently in use",vms:"VMs",numberOfVmsSharingTheSameScript:"Number of VMs sharing the same script source",scriptUrl:"Script URL",urlOfTheScriptSource:"URL of the script source",heapProfile:"Heap Profile",anonymousScriptS:"(Anonymous Script {PH1})",kb:"kB"},as=a.registerUIStrings("profiler/LiveHeapProfileView.js",ns),ls=a.getLocalizedString.bind(void 0,as);let ds,hs;class cs extends c.VBox{constructor(){super(!0),this._gridNodeByUrl=new Map,this.registerRequiredCSS("profiler/liveHeapProfile.css",{enableLegacyPatching:!0}),this._setting=L.Settings.instance().moduleSetting("memoryLiveHeapProfile");const e=new v.Toolbar("live-heap-profile-toolbar",this.contentElement);this._toggleRecordAction=N.ActionRegistry.instance().action("live-heap-profile.toggle-recording"),this._toggleRecordButton=v.Toolbar.createActionButton(this._toggleRecordAction),this._toggleRecordButton.setToggled(this._setting.get()),e.appendToolbarItem(this._toggleRecordButton);const t=$.TargetManager.instance().mainTarget();if(t&&t.model(se.ResourceTreeModel)){const t=N.ActionRegistry.instance().action("live-heap-profile.start-with-reload");this._startWithReloadButton=v.Toolbar.createActionButton(t),e.appendToolbarItem(this._startWithReloadButton)}this._dataGrid=this._createDataGrid(),this._dataGrid.asWidget().show(this.contentElement),this._currentPollId=0}static instance(){return ds||(ds=new cs),ds}_createDataGrid(){const e={id:"",title:k.LocalizedEmptyString,width:void 0,fixedWidth:!0,sortable:!0,align:r.Align.Right,sort:r.Order.Descending,titleDOMFragment:void 0,editable:void 0,nonSelectable:void 0,longText:void 0,disclosure:void 0,weight:void 0,allowInSortByEvenWhenHidden:void 0,dataType:void 0,defaultWeight:void 0},t=[{...e,id:"size",title:ls(ns.jsHeap),width:"72px",fixedWidth:!0,sortable:!0,align:r.Align.Right,sort:r.Order.Descending,tooltip:ls(ns.allocatedJsHeapSizeCurrentlyIn)},{...e,id:"isolates",title:ls(ns.vms),width:"40px",fixedWidth:!0,align:r.Align.Right,tooltip:ls(ns.numberOfVmsSharingTheSameScript)},{...e,id:"url",title:ls(ns.scriptUrl),fixedWidth:!1,sortable:!0,tooltip:ls(ns.urlOfTheScriptSource)}],i=new n.SortableDataGrid({displayName:ls(ns.heapProfile),columns:t,editCallback:void 0,deleteCallback:void 0,refreshCallback:void 0});i.setResizeMethod(r.ResizeMethod.Last),i.element.classList.add("flex-auto"),i.element.addEventListener("keydown",this._onKeyDown.bind(this),!1),i.addEventListener(r.Events.OpenedNode,this._revealSourceForSelectedNode,this),i.addEventListener(r.Events.SortingChanged,this._sortingChanged,this);for(const e of t){const t=i.headerTableHeader(e.id);t&&t.setAttribute("title",e.tooltip)}return i}wasShown(){this._poll(),this._setting.addChangeListener(this._settingChanged,this)}willHide(){++this._currentPollId,this._setting.removeChangeListener(this._settingChanged,this)}_settingChanged(e){this._toggleRecordButton.setToggled(e.data)}async _poll(){const e=this._currentPollId;do{const t=Array.from(X.IsolateManager.instance().isolates()),i=await Promise.all(t.map((e=>{const t=e.heapProfilerModel();return t?t.getSamplingProfile():null})));if(this._currentPollId!==e)return;this._update(t,i),await new Promise((e=>setTimeout(e,3e3)))}while(this._currentPollId===e)}_update(e,t){const i=new Map;t.forEach(((t,i)=>{t&&o(e[i],"",t.head)}));const s=this._dataGrid.rootNode(),r=new Set;for(const e of i){const t=e[0],i=e[1].size,o=e[1].isolates.size;if(!t){console.info(`Node with empty URL: ${i} bytes`);continue}let n=this._gridNodeByUrl.get(t);n?n.updateNode(i,o):(n=new ps(t,i,o),this._gridNodeByUrl.set(t,n),s.appendChild(n)),r.add(n)}for(const e of s.children.slice()){r.has(e)||e.remove();const t=e;this._gridNodeByUrl.delete(t._url)}function o(e,t,s){const r=s.callFrame.url||t||function(e){const t=e.callFrame.functionName;return t.startsWith("(")&&"(root)"!==t?t:""}(s)||function(e){return Number(e.callFrame.scriptId)?ls(ns.anonymousScriptS,{PH1:e.callFrame.scriptId}):""}(s);if(s.children.forEach(o.bind(null,e,r)),!s.selfSize)return;let n=i.get(r);n||(n={size:0,isolates:new Set},i.set(r,n)),n.size+=s.selfSize,n.isolates.add(e)}this._sortingChanged()}_onKeyDown(e){"Enter"===e.key&&(e.consume(!0),this._revealSourceForSelectedNode())}_revealSourceForSelectedNode(){const e=this._dataGrid.selectedNode;if(!e||!e._url)return;const t=he.WorkspaceImpl.instance().uiSourceCodeForURL(e._url);t&&H.reveal(t)}_sortingChanged(){const e=this._dataGrid.sortColumnId();if(!e)return;const t="url"===e?function(e,t){return t._url.localeCompare(e._url)}:function(e,t){return t._size-e._size};this._dataGrid.sortNodes(t,this._dataGrid.isSortOrderAscending())}_toggleRecording(){!this._setting.get()?this._startRecording(!1):this._stopRecording()}_startRecording(e){if(this._setting.set(!0),!e)return;const t=$.TargetManager.instance().mainTarget();if(!t)return;const i=t.model(se.ResourceTreeModel);i&&i.reloadPage()}async _stopRecording(){this._setting.set(!1)}}class ps extends n.SortableDataGridNode{constructor(e,t,i){super(),this._url=e,this._size=t,this._isolateCount=i}updateNode(e,t){this._size===e&&this._isolateCount===t||(this._size=e,this._isolateCount=t,this.refresh())}createCell(e){const t=this.createTD(e);switch(e){case"url":t.textContent=this._url;break;case"size":t.textContent=Number.withThousandsSeparator(Math.round(this._size/1e3)),t.createChild("span","size-units").textContent=ls(ns.kb);break;case"isolates":t.textContent=""+this._isolateCount}return t}}class us{static instance(e={forceNew:null}){const{forceNew:t}=e;return hs&&!t||(hs=new us),hs}handleAction(e,t){return(async()=>{const e="live_heap_profile";await R.ViewManager.instance().showView(e);const i=R.ViewManager.instance().view(e);if(i){const e=await i.widget();this._innerHandleAction(e,t)}})(),!0}_innerHandleAction(e,t){switch(t){case"live-heap-profile.toggle-recording":e._toggleRecording();break;case"live-heap-profile.start-with-reload":e._startRecording(!0);break;default:console.assert(!1,"Unknown action: "+t)}}}var _s=Object.freeze({__proto__:null,UIStrings:ns,LiveHeapProfileView:cs,GridNode:ps,ActionDelegate:us});export{Se as BottomUpProfileDataGrid,xe as CPUProfileFlameChart,nt as CPUProfileView,we as ChildrenProvider,zt as HeapProfileView,os as HeapProfilerPanel,ci as HeapSnapshotDataGrids,Xt as HeapSnapshotGridNodes,wi as HeapSnapshotProxy,Bi as HeapSnapshotView,Tt as HeapTimelineOverview,pt as IsolateSelector,_s as LiveHeapProfileView,fe as ProfileDataGrid,Fe as ProfileHeader,vt as ProfileLauncherView,je as ProfileSidebarTreeElement,Gi as ProfileTypeRegistry,Xe as ProfileView,Zi as ProfilesPanel,Ae as TopDownProfileDataGrid};
