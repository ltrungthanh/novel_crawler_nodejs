import{UIString as e,Settings as t}from"../common/common.js";import{Diff as i}from"../diff/diff.js";import{userMetrics as s,UserMetrics as r,InspectorFrontendHost as o}from"../host/host.js";import{ls as n,StringUtilities as a,NumberUtilities as l,ArrayUtilities as h}from"../platform/platform.js";import{Runtime as c}from"../root/root.js";import{Widget as d,ARIAUtils as m,TextPrompt as _,ListModel as u,ListControl as p,UIUtils as g,Dialog as f,Geometry as C,GlassPane as v,InspectorView as w,ShortcutRegistry as y,ViewManager as x,View as E,ActionRegistry as b}from"../ui/ui.js";import{TextRange as T}from"../text_utils/text_utils.js";class A extends d.VBox{constructor(e,t,i){super(!0),this._promptHistory=t||[],this._scoringTimer=0,this._filterTimer=0,this._loadTimeout=0,this._refreshListWithCurrentResult,this._dialog,this._query,this.contentElement.classList.add("filtered-list-widget");const s=this._onKeyDown.bind(this);this.contentElement.addEventListener("keydown",s,!0),m.markAsCombobox(this.contentElement),this.registerRequiredCSS("quick_open/filteredListWidget.css",{enableLegacyPatching:!0}),this._promptElement=this.contentElement.createChild("div","filtered-list-widget-input"),m.setAccessibleName(this._promptElement,n`Quick open prompt`),this._promptElement.setAttribute("spellcheck","false"),this._promptElement.setAttribute("contenteditable","plaintext-only"),this._prompt=new _.TextPrompt,this._prompt.initialize((()=>Promise.resolve([])));const r=this._prompt.attach(this._promptElement);r.addEventListener("input",this._onInput.bind(this),!1),r.classList.add("filtered-list-widget-prompt-element"),this._bottomElementsContainer=this.contentElement.createChild("div","vbox"),this._progressElement=this._bottomElementsContainer.createChild("div","filtered-list-widget-progress"),this._progressBarElement=this._progressElement.createChild("div","filtered-list-widget-progress-bar"),this._items=new u.ListModel,this._list=new p.ListControl(this._items,this,p.ListMode.EqualHeightItems),this._itemElementsContainer=this._list.element,this._itemElementsContainer.classList.add("container"),this._bottomElementsContainer.appendChild(this._itemElementsContainer),this._itemElementsContainer.addEventListener("click",this._onClick.bind(this),!1),m.markAsListBox(this._itemElementsContainer),m.setControls(this._promptElement,this._itemElementsContainer),m.setAutocomplete(this._promptElement,m.AutocompleteInteractionModel.list),this._notFoundElement=this._bottomElementsContainer.createChild("div","not-found-text"),this._notFoundElement.classList.add("hidden"),this.setDefaultFocusedElement(this._promptElement),this._prefix="",this._provider=e,this._queryChangedCallback=i}static highlightRanges(e,t,s){if(!t)return!1;function r(e,t){const s=i.DiffWrapper.charDiff(t,e);let r=0;const o=[];for(let e=0;e<s.length;++e){const t=s[e];if(t[0]===i.Operation.Equal)o.push(new T.SourceRange(r,t[1].length));else if(t[0]!==i.Operation.Insert)return null;r+=t[1].length}return o}if(null===e.textContent)return!1;const o=e.textContent;let n=r(o,t);return n&&!s||(n=r(o.toUpperCase(),t.toUpperCase())),!!n&&(g.highlightRangesWithStyleClass(e,n,"highlight"),!0)}setPlaceholder(e,t){this._prompt.setPlaceholder(e,t)}setPromptTitle(e){m.setAccessibleName(this._promptElement,e)}showAsDialog(e=n`Quick open`){this._dialog=new f.Dialog,m.setAccessibleName(this._dialog.contentElement,e),this._dialog.setMaxContentSize(new C.Size(504,340)),this._dialog.setSizeBehavior(v.SizeBehavior.SetExactWidthMaxHeight),this._dialog.setContentPosition(null,22),this.show(this._dialog.contentElement),m.setExpanded(this.contentElement,!0),this._dialog.once("hidden").then((()=>{this.dispatchEventToListeners("hidden")})),this._dialog.show()}setPrefix(e){this._prefix=e}setProvider(e){e!==this._provider&&(this._provider&&this._provider.detach(),this._clearTimers(),this._provider=e,this.isShowing()&&this._attachProvider())}setQuerySelectedRange(e,t){this._prompt.setSelectedRange(e,t)}_attachProvider(){this._items.replaceAll([]),this._list.invalidateItemHeight(),this._provider&&(this._provider.setRefreshCallback(this._itemsLoaded.bind(this,this._provider)),this._provider.attach()),this._itemsLoaded(this._provider)}_value(){return this._prompt.text().trim()}_cleanValue(){return this._value().substring(this._prefix.length)}wasShown(){this._attachProvider()}willHide(){this._provider&&this._provider.detach(),this._clearTimers(),m.setExpanded(this.contentElement,!1)}_clearTimers(){clearTimeout(this._filterTimer),clearTimeout(this._scoringTimer),clearTimeout(this._loadTimeout),this._filterTimer=0,this._scoringTimer=0,this._loadTimeout=0,this._refreshListWithCurrentResult=void 0}_onEnter(e){if(!this._provider)return;const t=this._provider.itemCount()?this._list.selectedItem():null;this._selectItem(t),this._dialog&&this._dialog.hide()}_itemsLoaded(e){this._loadTimeout||e!==this._provider||(this._loadTimeout=window.setTimeout(this._updateAfterItemsLoaded.bind(this),0))}_updateAfterItemsLoaded(){this._loadTimeout=0,this._filterItems()}createElementForItem(e){const t=document.createElement("div"),i=this._provider&&this._provider.renderAsTwoRows();t.className="filtered-list-widget-item "+(i?"two-rows":"one-row");const s=t.createChild("div","filtered-list-widget-title"),r=t.createChild("div","filtered-list-widget-subtitle");return r.textContent="​",this._provider&&this._provider.renderItem(e,this._cleanValue(),s,r),m.markAsOption(t),t}heightForItem(e){return 0}isItemSelectable(e){return!0}selectedItemChanged(e,t,i,s){i&&i.classList.remove("selected"),s&&s.classList.add("selected"),m.setActiveDescendant(this._promptElement,s)}_onClick(e){const t=this._list.itemForNode(e.target);null!==t&&(e.consume(!0),this._selectItem(t),this._dialog&&this._dialog.hide())}setQuery(e){this._prompt.focus(),this._prompt.setText(e),this._queryChanged(),this._prompt.autoCompleteSoon(!0),this._scheduleFilter()}_tabKeyPressed(){const e=this._prompt.text();let t;for(let i=this._promptHistory.length-1;i>=0;i--)if(this._promptHistory[i]!==e&&this._promptHistory[i].startsWith(e)){t=this._promptHistory[i];break}return!!t&&(this._prompt.focus(),this._prompt.setText(t),this._prompt.setDOMSelection(e.length,t.length),this._scheduleFilter(),!0)}_itemsFilteredForTest(){}_filterItems(){if(this._filterTimer=0,this._scoringTimer&&(clearTimeout(this._scoringTimer),this._scoringTimer=0,this._refreshListWithCurrentResult&&this._refreshListWithCurrentResult()),!this._provider)return this._bottomElementsContainer.classList.toggle("hidden",!0),void this._itemsFilteredForTest();this._bottomElementsContainer.classList.toggle("hidden",!1),this._progressBarElement.style.transform="scaleX(0)",this._progressBarElement.classList.remove("filtered-widget-progress-fade","hidden");const e=this._provider.rewriteQuery(this._cleanValue());this._query=e;const t=e?a.filterRegex(e):null,i=[],s=[],r=[],o=100;let n=0;const c=[],d=window.performance.now(),m=l.clamp(10,500,this._provider.itemCount()/10|0);function _(e,t){return t-e}(function a(l){if(!this._provider)return;this._scoringTimer=0;let u,p=0;for(u=l;u<this._provider.itemCount()&&p<m;++u){if(t&&!t.test(this._provider.itemKeyAt(u)))continue;const a=this._provider.itemScoreAt(u,e);if(e&&p++,a>n||s.length<o){const e=h.upperBound(s,a,_);if(s.splice(e,0,a),r.splice(e,0,u),s.length>o){const e=r[r.length-1];e&&c.push(e),s.length=o,r.length=o}const t=s[s.length-1];t&&(n=t)}else i.push(u)}if(this._refreshListWithCurrentResult=this._refreshList.bind(this,r,c,i),u<this._provider.itemCount())return this._scoringTimer=window.setTimeout(a.bind(this,u),0),void(window.performance.now()-d>50&&(this._progressBarElement.style.transform="scaleX("+u/this._provider.itemCount()+")"));window.performance.now()-d>100?(this._progressBarElement.style.transform="scaleX(1)",this._progressBarElement.classList.add("filtered-widget-progress-fade")):this._progressBarElement.classList.add("hidden");this._refreshListWithCurrentResult()}).call(this,0)}_refreshList(e,t,i){this._refreshListWithCurrentResult=void 0,i=[...e,...t,...i],this._updateNotFoundMessage(Boolean(i.length));const s=this._list.element.offsetHeight;this._items.replaceAll(i),i.length&&this._list.selectItem(i[0]),this._list.element.offsetHeight!==s&&this._list.viewportResized(),this._itemsFilteredForTest()}_updateNotFoundMessage(e){this._list.element.classList.toggle("hidden",!e),this._notFoundElement.classList.toggle("hidden",e),!e&&this._provider&&(this._notFoundElement.textContent=this._provider.notFoundText(this._cleanValue()),m.alert(this._notFoundElement.textContent,this._notFoundElement))}_onInput(){this._queryChanged(),this._scheduleFilter()}_queryChanged(){this._queryChangedCallback&&this._queryChangedCallback(this._value()),this._provider&&this._provider.queryChanged(this._cleanValue())}updateSelectedItemARIA(e,t){return!1}_onKeyDown(e){let t=!1;switch(e.key){case"Enter":return void this._onEnter(e);case"Tab":t=this._tabKeyPressed();break;case"ArrowUp":t=this._list.selectPreviousItem(!0,!1);break;case"ArrowDown":t=this._list.selectNextItem(!0,!1);break;case"PageUp":t=this._list.selectItemPreviousPage(!1);break;case"PageDown":t=this._list.selectItemNextPage(!1)}t&&e.consume(!0)}_scheduleFilter(){this._filterTimer||(this._filterTimer=window.setTimeout(this._filterItems.bind(this),0))}_selectItem(e){this._promptHistory.push(this._value()),this._promptHistory.length>100&&this._promptHistory.shift(),this._provider&&this._provider.selectItem(e,this._cleanValue())}}class k{constructor(){this._refreshCallback}setRefreshCallback(e){this._refreshCallback=e}attach(){}itemCount(){return 0}itemKeyAt(e){return""}itemScoreAt(e,t){return 1}renderItem(e,t,i,s){}renderAsTwoRows(){return!1}selectItem(e,t){}refresh(){this._refreshCallback&&this._refreshCallback()}rewriteQuery(e){return e}queryChanged(e){}notFoundText(t){return e.UIString("No results found")}detach(){}}var L=Object.freeze({__proto__:null,FilteredListWidget:A,Provider:k});const I=[];class P{constructor(){this._prefix=null,this._query="",this._providers=new Map,this._prefixes=[],this._filteredListWidget=null,c.Runtime.instance().extensions(k).forEach(this._addProvider.bind(this)),this._prefixes.sort(((e,t)=>t.length-e.length))}static show(e){const t=new this,i=new A(null,I,t._queryChanged.bind(t));t._filteredListWidget=i,i.setPlaceholder(n`Type '?' to see available commands`,n`Type question mark to see available commands`),i.showAsDialog(),i.setQuery(e)}_addProvider(e){const t=e.descriptor().prefix;null!==t&&(this._prefixes.push(t),this._providers.set(t,e.instance.bind(e)))}_queryChanged(e){const t=this._prefixes.find((t=>e.startsWith(t)));if("string"!=typeof t||this._prefix===t)return;if(this._prefix=t,!this._filteredListWidget)return;this._filteredListWidget.setPrefix(t),this._filteredListWidget.setProvider(null);const i=this._providers.get(t);i&&i().then((e=>{this._prefix===t&&this._filteredListWidget&&(this._filteredListWidget.setProvider(e),this._providerLoadedForTest(e))}))}_providerLoadedForTest(e){}}var R=Object.freeze({__proto__:null,history:I,QuickOpenImpl:P,ShowActionDelegate:class{handleAction(e,t){switch(t){case"quickOpen.show":return P.show(""),!0}return!1}}});let F;class S{constructor(){this._commands=[],this._loadCommands()}static instance(e={forceNew:null}){const{forceNew:t}=e;return F&&!t||(F=new S),F}static createCommand(e){const{category:t,keys:i,title:o,shortcut:n,executeHandler:a,availableHandler:l,userActionCode:h}=e;let c=a;if(h){const e=h;c=()=>{s.actionTaken(e),a()}}if("Show Issues"===o){const e=c;c=()=>{s.issuesPanelOpenedFrom(r.IssueOpener.CommandMenu),e()}}return new H(t,o,i,n,c,l)}static createSettingCommand(e,t,i){const s=e.category()||"",r=e.tags()||"",o=Boolean(e.reloadRequired());return S.createCommand({category:s,keys:r,title:t,shortcut:"",executeHandler:()=>{e.set(i),o&&w.InspectorView.instance().displayReloadRequiredWarning(n`One or more settings have changed which requires a reload to take effect.`)},availableHandler:function(){return e.get()!==i},userActionCode:void 0})}static createActionCommand(e){const{action:t,userActionCode:i}=e,s=y.ShortcutRegistry.instance().shortcutTitleForAction(t.id())||"";return S.createCommand({category:t.category(),keys:t.tags()||"",title:t.title()||"",shortcut:s,executeHandler:t.execute.bind(t),userActionCode:i,availableHandler:void 0})}static createRevealViewCommand(e){const{title:t,tags:i,category:s,userActionCode:r,id:o}=e;return S.createCommand({category:s,keys:i,title:t,shortcut:"",executeHandler:x.ViewManager.instance().showView.bind(x.ViewManager.instance(),o,!0),userActionCode:r,availableHandler:void 0})}_loadCommands(){const e=new Map;c.Runtime.instance().extensions(E.ViewLocationResolver).forEach((t=>{const i=t.descriptor().category,s=t.descriptor().name;i&&s&&e.set(s,n(i))}));for(const{category:t,name:i}of x.getRegisteredLocationResolvers())t&&i&&e.set(i,t);const i=c.Runtime.instance().extensions("setting");for(const e of i){const i=e.descriptor(),s=i.options;if(s&&i.category)for(const e of s){const s=t.Settings.instance().moduleSetting(i.settingName);this._commands.push(S.createSettingCommand(s,n(e.title),e.value))}}this._loadCommandsFromPreRegisteredExtensions(e)}_loadCommandsFromPreRegisteredExtensions(e){const i=x.getRegisteredViewExtensions();for(const t of i){const i=t.location(),s=i&&e.get(i);if(!s)continue;const r={title:t.commandPrompt(),tags:t.tags()||"",category:s,userActionCode:void 0,id:t.viewId()};this._commands.push(S.createRevealViewCommand(r))}const s=t.getRegisteredSettings();for(const e of s){const i=e.options;if(i&&e.category)for(const s of i){const i=t.Settings.instance().moduleSetting(e.settingName);this._commands.push(S.createSettingCommand(i,s.title(),s.value))}}}commands(){return this._commands}}const D=["#F44336","#E91E63","#9C27B0","#673AB7","#3F51B5","#03A9F4","#00BCD4","#009688","#4CAF50","#8BC34A","#CDDC39","#FFC107","#FF9800","#FF5722","#795548","#9E9E9E","#607D8B"];class H{constructor(e,t,i,s,r,o){this._category=e,this._title=t,this._key=e+"\0"+t+"\0"+i,this._shortcut=s,this._executeHandler=r,this._availableHandler=o}category(){return this._category}title(){return this._title}key(){return this._key}shortcut(){return this._shortcut}available(){return!this._availableHandler||this._availableHandler()}execute(){this._executeHandler()}}var O=Object.freeze({__proto__:null,CommandMenu:S,ActionCommandOptions:undefined,RevealViewCommandOptions:undefined,CreateCommandOptions:undefined,CommandMenuProvider:class extends k{constructor(){super(),this._commands=[]}attach(){const e=S.instance().commands(),t=b.ActionRegistry.instance().availableActions();for(const e of t){if(!e.category())continue;const t={action:e,userActionCode:void 0};this._commands.push(S.createActionCommand(t))}for(const t of e)t.available()&&this._commands.push(t);this._commands=this._commands.sort((function(e,t){const i=a.compare(e.category(),t.category());return i||a.compare(e.title(),t.title())}))}detach(){this._commands=[]}itemCount(){return this._commands.length}itemKeyAt(e){return this._commands[e].key()}itemScoreAt(e,t){const s=this._commands[e];let r=i.DiffWrapper.characterScore(t.toLowerCase(),s.title().toLowerCase());return s.category().startsWith("Panel")?r+=2:s.category().startsWith("Drawer")&&(r+=1),r}renderItem(e,t,i,s){const r=this._commands[e];i.removeChildren();const o=i.createChild("span","tag"),n=a.hashCode(r.category())%D.length;o.style.backgroundColor=D[n],o.textContent=r.category(),g.createTextChild(i,r.title()),A.highlightRanges(i,t,!0),s.textContent=r.shortcut()}selectItem(e,t){null!==e&&(this._commands[e].execute(),s.actionTaken(r.Action.SelectCommandFromCommandMenu))}notFoundText(){return n`No commands found`}},MaterialPaletteColors:D,Command:H,ShowActionDelegate:class{handleAction(e,t){return o.InspectorFrontendHostInstance.bringToFront(),P.show(">"),!0}}});var W=Object.freeze({__proto__:null,HelpQuickOpen:class extends k{constructor(){super(),this._providers=[],c.Runtime.instance().extensions(k).forEach(this._addProvider.bind(this))}_addProvider(e){e.title()&&this._providers.push({prefix:e.descriptor().prefix||"",title:e.title()})}itemCount(){return this._providers.length}itemKeyAt(e){return this._providers[e].prefix}itemScoreAt(e,t){return-this._providers[e].prefix.length}renderItem(e,t,i,s){const r=this._providers[e];i.createChild("span","monospace").textContent=(r.prefix||"…")+" ",g.createTextChild(i,r.title)}selectItem(e,t){null!==e&&P.show(this._providers[e].prefix)}renderAsTwoRows(){return!1}}});class q extends k{constructor(e,t){super(),this._options=e,this._resolve=t}notFoundText(){return n`${this._options.prompt} (Press 'Enter' to confirm or 'Escape' to cancel.)`}selectItem(e,t){this._resolve(t)}}var B=Object.freeze({__proto__:null,QuickInputOptions:undefined,QuickInput:class{constructor(){throw new ReferenceError("Instance type not implemented.")}static show(e){let t=new Promise((e=>{}));const i=new Promise((i=>{const s=new q(e,i),r=new A(s);e.placeHolder&&r.setPlaceholder(e.placeHolder),r.setPromptTitle(e.placeHolder||e.prompt),r.showAsDialog(e.prompt),t=r.once("hidden"),r.setQuery(e.value||""),e.valueSelection&&r.setQuerySelectedRange(e.valueSelection[0],e.valueSelection[1])}));return Promise.race([i,t]).then((e=>e))}}});class Q extends k{constructor(e,t,i=.5,s=.25){super(),this._resolve=t,this._items=e,this._matchOnDescription=i,this._matchOnDetail=s}itemCount(){return this._items.length}itemKeyAt(e){const t=this._items[e];let i=t.label;return this._matchOnDescription&&(i+=" "+t.description),this._matchOnDetail&&(i+=" "+t.detail),i}itemScoreAt(e,t){const s=this._items[e],r=t.toLowerCase();let o=i.DiffWrapper.characterScore(r,s.label.toLowerCase());if(this._matchOnDescription&&s.description){o+=i.DiffWrapper.characterScore(r,s.description.toLowerCase())*this._matchOnDescription}if(this._matchOnDetail&&s.detail){o+=i.DiffWrapper.characterScore(r,s.detail.toLowerCase())*this._matchOnDetail}return o}renderItem(e,t,i,s){const r=this._items[e];i.removeChildren();const o=i.createChild("span");if(g.createTextChild(o,r.label),A.highlightRanges(i,t,!0),r.description){const e=i.createChild("span","quickpick-description");g.createTextChild(e,r.description),this._matchOnDescription&&A.highlightRanges(e,t,!0)}r.detail&&(g.createTextChild(s,r.detail),this._matchOnDetail&&A.highlightRanges(s,t,!0))}renderAsTwoRows(){return this._items.some((e=>Boolean(e.detail)))}selectItem(e,t){"number"!=typeof e?this._resolve(void 0):this._resolve(this._items[e])}}var M=Object.freeze({__proto__:null,QuickPickItem:undefined,QuickPickOptions:undefined,QuickPick:class{constructor(){throw new ReferenceError("Instance type not implemented.")}static show(e,t){let i=new Promise((e=>{}));const s=new Promise((s=>{const r=new Q(e,s,t.matchOnDescription?.5:0,t.matchOnDetail?.25:0),o=new A(r);o.setPlaceholder(t.placeHolder),o.setPromptTitle(t.placeHolder),o.showAsDialog(t.placeHolder),i=o.once("hidden"),o.setQuery("")}));return Promise.race([s,i]).then((e=>e))}}});export{O as CommandMenu,L as FilteredListWidget,W as HelpQuickOpen,B as QuickInput,R as QuickOpen,M as QuickPick};
